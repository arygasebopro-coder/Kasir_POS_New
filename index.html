<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kasir Toko Tanaman</title>

<style>
/* ======== THEME: Premium Red / Green / Blue ======== */
:root{
  --brand:#c62828;      /* merah dominan */
  --brand-700:#b71c1c;
  --accent:#2e7d32;     /* hijau */
  --info:#1565c0;       /* biru */
  --bg:#f7f7f9;
  --card:#ffffff;
  --text:#222;
  --muted:#6b7280;
  --ring: rgba(198,40,40,.25);
  --line:#ececf1;
  --chip:#eef2ff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{ background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }

.container{ max-width:1000px; margin:14px auto; padding:0 12px; }
.hidden{ display:none !important; }

/* Header user */
.userbar{ display:flex; align-items:center; gap:12px; margin-bottom:10px; flex-wrap:wrap;}
.userbar .you{ font-size:.95rem; color:#555; }
.userbar a{ color:var(--brand); font-weight:700; text-decoration:none; }
.badge{ display:inline-flex; align-items:center; gap:6px; background:var(--chip); color:#334; padding:6px 10px; border-radius:999px; border:1px solid #e6e8ff; font-weight:700; }

/* Tabs */
.tabs{ display:flex; gap:.75rem; margin-bottom:12px;}
.tab{
  flex:1 1 auto; text-align:center; font-weight:700;
  background:#eaeaec; color:#333; border-radius:12px; padding:.9rem 1rem;
  border:1px solid #e3e3e8; transition:all .2s ease; cursor:pointer;
}
.tab.active{
  background:linear-gradient(135deg,var(--brand),var(--brand-700));
  color:#fff; box-shadow:0 8px 20px -8px var(--ring), inset 0 -2px 0 rgba(255,255,255,.15);
  border-color:transparent;
}

/* Card & inputs */
.card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
.card h4{ margin:.25rem 0 6px; }
select, input[type="email"], input[type="text"], input[type="number"]{
  width:100%;
  border:1px solid var(--line); border-radius:12px; padding:.62rem .8rem; background:#fff; color:#222;
  outline:none; transition:border .2s;
}
select:focus, input:focus{ border-color:var(--brand); box-shadow:0 0 0 4px var(--ring); }

.action-toolbar{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:6px 0 10px; }
.btn{
  appearance:none; border:0; border-radius:999px; cursor:pointer;
  font-weight:700; letter-spacing:.2px;
  padding:.42rem .7rem; line-height:1; transition:transform .06s, box-shadow .2s, background .2s;
}
.btn:active{ transform:translateY(1px); }
.btn--brand{ background:var(--brand); color:#fff; }
.btn--brand:hover{ background:var(--brand-700); }
.btn--accent{ background:var(--accent); color:#fff; }
.btn--info{ background:var(--info); color:#fff; }
.btn--sm{ font-size:.86rem; padding:.36rem .6rem; }
.btn--ghost{ background:transparent; color:var(--muted); border:1px dashed #d7d7dc; }
.btn--line{ background:#fff; border:1px solid var(--line); }
.btn--full{ width:100%; padding:12px 14px; border-radius:12px; font-size:1rem; }

.filters{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin:10px 0; }
.filters .grow{ flex:1 1 280px; }

/* ====== Produk (versi kompak & profesional) ====== */
.product-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
  gap:10px;
  content-visibility:auto; contain-intrinsic-size: 400px;
}
@media (min-width: 980px){
  .product-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
}
.p-card{
  border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden;
  display:grid; grid-template-rows:auto 1fr; transition:box-shadow .2s, transform .06s;
}
.p-card:hover{ box-shadow:0 8px 18px -10px rgba(0,0,0,.12); transform:translateY(-1px); }
.p-img{
  width:100%; height:160px; object-fit:cover; display:block; background:#f3f4f6;
}
.p-body{ padding:10px; display:flex; flex-direction:column; gap:6px; }
.p-name{
  font-weight:700; font-size:.95rem; line-height:1.25;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
}
.p-meta{ color:var(--muted); font-size:.85rem; }
.p-foot{ display:flex; align-items:center; justify-content:space-between; margin-top:4px; }
.price{ font-weight:900; color:var(--brand); font-size:1rem; }
.price-control.hidden { display:none !important; } /* sembunyikan input nego sampai diklik */

/* Keranjang */
.two-cols{ display:grid; gap:12px; }
@media (min-width: 980px){ .two-cols{ grid-template-columns: 1.2fr .8fr; } }

.cart{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; }
.cart-item{ display:grid; grid-template-columns: 1fr auto; gap:8px; padding:10px 0; border-bottom:1px dashed #e8e8ee; }
.qty{ display:inline-flex; align-items:center; gap:6px; }
.qty button{ width:28px; height:28px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; }
.k-right{ display:flex; align-items:center; gap:8px; }
.chip{ background:#f3f4f6; border:1px solid var(--line); padding:4px 8px; border-radius:8px; font-weight:700; color:#444; }

/* Table (laporan/detail) */
.table{ width:100%; border-collapse:collapse; }
.table th,.table td{ border:1px solid var(--line); padding:8px 10px; font-size:.92rem; }
.table thead th{ background:#fafafe; text-align:left; }
.row-actions button{ background:#ffe4e6; border:1px solid #ffccd0; color:#c62828; padding:4px 8px; border-radius:8px; cursor:pointer; }

/* Login */
.login-card{ max-width:520px; margin:30px auto; }
.login-card input{ width:100%; }

/* Print (58mm) */
@media print{
  @page{ size:58mm auto; margin:0 }
  body{ background:#fff }
  .print{ width:58mm; font-family:monospace; font-size:11px; }
  .print h3{ text-align:center; margin:6px 0 }
  .print .line{ border-top:1px dashed #000; margin:6px 0 }
  .print .row{ display:flex; justify-content:space-between }
}
</style>
</head>
<body>

<div class="container">
  <!-- LOGIN -->
  <div id="loginPage" class="login-card">
    <div class="card">
      <h2>Login Kasir</h2>
      <input type="email" id="emailInput" placeholder="Email (contoh: kasir@tokotanaman.com)" />
      <div style="height:8px"></div>
      <button class="btn btn--brand btn--full" onclick="login()">Masuk</button>
    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="hidden">
    <div class="userbar">
      <div class="you" id="userInfo">Kasir: - | Cabang: -</div>
      <span class="badge" id="memberBadge" title="Status member">Member: Non-aktif</span>
      <a href="javascript:void(0)" onclick="logout()">Logout</a>
    </div>

    <div class="tabs">
      <button id="navKasir" class="tab active" onclick="tampilkanHalaman('kasir')">Kasir</button>
      <button id="navLaporan" class="tab" onclick="tampilkanHalaman('laporan')">Laporan</button>
    </div>

    <!-- ===== HALAMAN KASIR ===== -->
    <div id="posPage">
      <!-- Toolbar mini -->
      <div class="action-toolbar">
        <button class="btn btn--ghost btn--sm" onclick="bukaFormMember()">+ Member</button>
        <button class="btn btn--ghost btn--sm" onclick="bukaFormManual()">+ Item Manual</button>
        <button class="btn btn--ghost btn--sm" onclick="toggleMember()">Diskon Member</button>
      </div>

      <!-- Filter & Pagination -->
      <div class="filters">
        <input class="grow" id="searchInput" type="text" placeholder="Cari tanaman..." oninput="updateProductView()"/>
        <div style="display:flex; gap:.5rem; margin-left:auto">
          <button id="prevPageBtn" class="btn btn--line btn--sm" onclick="changePage(-1)">&laquo; Sebelumnya</button>
          <span id="pageInfo" class="chip">Halaman 1 dari 1</span>
          <button id="nextPageBtn" class="btn btn--line btn--sm" onclick="changePage(1)">Berikutnya &raquo;</button>
        </div>
      </div>

      <div class="two-cols">
        <!-- GRID PRODUK -->
        <div class="card">
          <div id="produkGrid" class="product-grid"></div>
        </div>

        <!-- KERANJANG -->
        <div>
          <div class="cart">
            <h4>Keranjang Belanja</h4>
            <div id="cartList" class="muted">Tidak ada item.</div>
            <div class="line" style="border-top:1px dashed #eaeaea; margin:10px 0;"></div>
            <div><b>Subtotal:</b> <span id="subtotalText">Rp 0</span></div>
            <div><b>Penghematan Member:</b> <span id="hematText">Rp 0</span></div>
            <div><b>Total:</b> <span id="totalText">Rp 0</span></div>
            <div style="height:8px"></div>
            <button id="btnBayar" class="btn btn--brand btn--full" onclick="mulaiPembayaran()" disabled>Lanjut ke Pembayaran</button>
          </div>

          <!-- PEMBAYARAN -->
          <div id="payCard" class="card hidden" style="margin-top:10px">
            <h4>Detail Pembayaran</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <label><input type="radio" name="pay" value="Tunai" checked onclick="switchPay('Tunai')"/> Tunai</label>
              <label><input type="radio" name="pay" value="Non-Tunai" onclick="switchPay('Non-Tunai')"/> Non-Tunai</label>
              <select id="detailMetode" class="hidden">
                <option>Transfer</option>
                <option>QRIS</option>
                <option>Debit</option>
                <option>Shopee</option>
                <option>Tokopedia</option>
              </select>
            </div>
            <div style="height:8px"></div>
            <button id="btnSimpan" class="btn btn--brand" onclick="selesaikanTransaksi(this)">Konfirmasi & Simpan</button>
            <button class="btn btn--line" onclick="batalPembayaran()">Kembali ke Keranjang</button>
          </div>

          <!-- SELESAI -->
          <div id="postTransactionCard" class="card hidden" style="margin-top:10px">
            <h4>Transaksi Berhasil</h4>
            <p class="center" style="color:#555">Silakan cetak struk atau kembali ke kasir.</p>
            <button id="btnCetakStruk" class="btn btn--accent" onclick="cetakStruk()">Cetak Struk</button>
            <button class="btn btn--line" onclick="kembaliKeHalamanAwal()">Kembali ke Kasir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== HALAMAN LAPORAN ===== -->
    <div id="laporanPage" class="hidden">
      <div class="card">
        <h3 id="laporanTitle">Laporan Gabungan Semua Cabang</h3>
        <small>(Data diperbarui setiap ada transaksi baru)</small>
        <div id="reportContent" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   KONFIGURASI BACKEND (GET)
   =========================== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

/* GET helper untuk semua panggilan (tidak kena preflight) */
async function getData(action, payload = {}) {
  const url = new URL(SCRIPT_URL);
  url.searchParams.set('action', action);
  if (payload && Object.keys(payload).length) {
    url.searchParams.set('payload', JSON.stringify(payload));
  }
  const res = await fetch(url.toString(), { method: 'GET' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

/* GANTI postData: pakai GET juga */
async function postData(action, payload = {}) {
  return getData(action, payload);
}

/* ===========================
   STATE & UTIL
   =========================== */
let semuaProduk = [], keranjang = [], currentUser = null;
let currentPage = 1, itemsPerPage = 8;
let isMemberActive = false;
let lastSavedTransaction = null;

const fmt = n => 'Rp ' + (Number(n||0)).toLocaleString('id-ID');

/* ===========================
   LOGIN
   =========================== */
async function login(){
  const email = document.getElementById('emailInput').value.trim();
  if(!email){ alert('Masukkan email.'); return; }
  try{
    const res = await getData('cekLogin', { email });
    if(!res.success){ alert(res.message||'Login gagal'); return; }
    currentUser = res.user;
    document.getElementById('userInfo').textContent = `Kasir: ${currentUser.email} | Cabang: ${currentUser.cabang}`;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
    await inisialisasi();
  }catch(e){ alert('Gagal terhubung ke server.'); console.error(e); }
}
function logout(){ location.reload(); }

/* ===========================
   INIT
   =========================== */
async function inisialisasi(){
  const p = await getData('getProduk');
  semuaProduk = (p||[]).map(x => ({
    id: x['ID Produk']||x.ID||x.Kode||'',
    nama: x['Nama Produk']||'',
    variasi: x['Ukuran/Variasi']||'',
    harga: Number(x['Harga Jual']||0),
    hargaMember: Number(x['Harga Member']||x['Harga Member ']||x['Harga member']||0)||null,
    foto: x['Foto URL']||''
  }));
  updateProductView();
}

/* ===========================
   PRODUK LIST (kompak)
   =========================== */
function getFilteredProduk(){
  const q = (document.getElementById('searchInput').value||'').toLowerCase();
  return semuaProduk.filter(p => p.nama.toLowerCase().includes(q));
}
function paginate(data){
  const totalPages = Math.max(1, Math.ceil(data.length / itemsPerPage));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*itemsPerPage;
  return { data: data.slice(start, start+itemsPerPage), totalPages };
}

function renderProduk(){
  const grid = document.getElementById('produkGrid');
  const data = getFilteredProduk();
  const { data: pageData, totalPages } = paginate(data);

  grid.innerHTML = pageData.map(p=>`
    <div class="p-card">
      <img class="p-img" src="${p.foto||''}" alt="${p.nama}" width="400" height="160"
           loading="lazy" decoding="async" referrerpolicy="no-referrer">
      <div class="p-body">
        <div class="p-name">${p.nama}</div>
        ${p.variasi ? `<div class="p-meta">${p.variasi}</div>` : ``}
        <div class="p-foot">
          <div class="price">${fmt(isMemberActive && p.hargaMember ? p.hargaMember : p.harga)}</div>
          <button class="btn btn--accent btn--sm"
            onclick='tambahKeKeranjang(${JSON.stringify(p).replace(/"/g,"&quot;")})'>+ Keranjang</button>
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">Tidak ada produk.</div>';

  const info = document.getElementById('pageInfo');
  info.textContent = `Halaman ${currentPage} dari ${totalPages}`;
  document.getElementById('prevPageBtn').disabled = currentPage===1;
  document.getElementById('nextPageBtn').disabled = currentPage===totalPages;
}

function updateProductView(){ renderProduk(); }
function changePage(d){ currentPage += d; if(currentPage<1) currentPage=1; updateProductView(); }

/* ===========================
   KERANJANG
   =========================== */
function tambahKeKeranjang(p){
  const idx = keranjang.findIndex(it => it.id===p.id && it.variasi===p.variasi);
  const harga = (isMemberActive && p.hargaMember) ? p.hargaMember : p.harga;
  if (idx>=0) keranjang[idx].qty++;
  else keranjang.push({ id:p.id, nama:p.nama, variasi:p.variasi, qty:1, hargaAwal: harga, hargaNego: harga, custom:false });
  renderCart();
}
function bukaFormManual(){
  const nama = prompt('Nama item (mis: kurir):','');
  if(!nama) return;
  const harga = Number(prompt('Harga satuan:','0')||0);
  if(harga<=0) return;
  keranjang.push({ id:'MANUAL-'+Date.now(), nama, variasi:'Custom', qty:1, hargaAwal:harga, hargaNego:harga, custom:true });
  renderCart();
}
function bukaFormMember(){ toggleMember(true); }
function toggleMember(forceOn){
  if(forceOn===true) isMemberActive = true;
  else isMemberActive = !isMemberActive;
  document.getElementById('memberBadge').textContent = 'Member: ' + (isMemberActive?'Aktif':'Non-aktif');
  // update harga keranjang
  keranjang = keranjang.map(k=>{
    if(k.custom) return k;
    const p = semuaProduk.find(x=>x.nama===k.nama && x.variasi===k.variasi);
    const h = (isMemberActive && p && p.hargaMember)? p.hargaMember : (p?p.harga: k.hargaAwal);
    return {...k, hargaAwal:h, hargaNego:h};
  });
  renderCart(); renderProduk();
}
function qtyChange(i,delta){
  keranjang[i].qty += delta;
  if(keranjang[i].qty<=0) keranjang.splice(i,1);
  renderCart();
}
function removeItem(i){ keranjang.splice(i,1); renderCart(); }

function renderCart(){
  const box = document.getElementById('cartList');
  if(!keranjang.length){ box.innerHTML='Tidak ada item.'; document.getElementById('btnBayar').disabled=true; hitungTotal(); return; }
  box.innerHTML = keranjang.map((it,i)=>`
    <div class="cart-item">
      <div>
        <div><b>${it.nama}</b> ${it.variasi?`<span class="p-meta">(${it.variasi})</span>`:''}</div>
        <div class="qty">
          <button onclick="qtyChange(${i},-1)">−</button>
          <span>${it.qty}</span>
          <button onclick="qtyChange(${i},1)">+</button>
          <button class="btn btn--sm btn--line" onclick="toggleNego(${i})">Nego</button>
          <span class="price-control ${it.showNego?'':'hidden'}">
            Rp <input type="number" style="width:90px" value="${it.hargaNego}" oninput="negoInput(${i},this.value)"/>
            <button class="btn btn--sm btn--accent" onclick="applyNego(${i})">OK</button>
          </span>
        </div>
      </div>
      <div class="k-right">
        <span class="chip">${fmt(it.hargaNego)}</span>
        <button class="btn btn--sm btn--line" onclick="removeItem(${i})">Hapus</button>
      </div>
    </div>
  `).join('');
  document.getElementById('btnBayar').disabled=false;
  hitungTotal();
}
function toggleNego(i){ keranjang[i].showNego = !keranjang[i].showNego; renderCart(); }
function negoInput(i,val){ keranjang[i].hargaNego = Number(val||0); }
function applyNego(i){ if(keranjang[i].hargaNego<=0) keranjang[i].hargaNego=keranjang[i].hargaAwal; keranjang[i].showNego=false; renderCart(); }

function hitungTotal(){
  let subtotal = 0, asli = 0;
  keranjang.forEach(it => { subtotal += it.qty*it.hargaNego; asli += it.qty*it.hargaAwal; });
  const hemat = Math.max(0, asli - subtotal);
  document.getElementById('subtotalText').textContent = fmt(asli);
  document.getElementById('hematText').textContent = fmt(hemat);
  document.getElementById('totalText').textContent = fmt(subtotal);
}

/* ===========================
   PEMBAYARAN
   =========================== */
function mulaiPembayaran(){
  document.getElementById('payCard').classList.remove('hidden');
  document.getElementById('postTransactionCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=true;
}
function batalPembayaran(){
  document.getElementById('payCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=false;
}
function switchPay(type){
  const d = document.getElementById('detailMetode');
  if(type==='Tunai'){ d.classList.add('hidden'); }
  else d.classList.remove('hidden');
}
async function selesaikanTransaksi(btn){
  if(!keranjang.length) return;
  btn.disabled = true; btn.textContent = 'Menyimpan...';
  try{
    const payload = {
      cabang: currentUser.cabang,
      metodePembayaran: document.querySelector('input[name="pay"]:checked').value,
      detailMetode: document.getElementById('detailMetode').classList.contains('hidden') ? '' : document.getElementById('detailMetode').value,
      items: keranjang.map(k=>({
        produk: { 'ID Produk': k.id, 'Nama Produk': k.nama, 'Ukuran/Variasi': k.variasi },
        qty: k.qty,
        hargaAkhirSatuan: k.hargaNego
      }))
    };
    const res = await postData('simpanTransaksi', payload);
    if(!res.success){ alert(res.message||'Gagal menyimpan'); btn.disabled=false; btn.textContent='Konfirmasi & Simpan'; return; }
    lastSavedTransaction = res.id || null;
    document.getElementById('payCard').classList.add('hidden');
    document.getElementById('postTransactionCard').classList.remove('hidden');
  }catch(e){ alert('Terjadi kesalahan saat menyimpan transaksi: ' + e.message); }
  finally{ btn.disabled=false; btn.textContent='Konfirmasi & Simpan'; }
}
function kembaliKeHalamanAwal(){
  keranjang = []; renderCart();
  document.getElementById('postTransactionCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=true;
}

/* ===========================
   CETAK STRUK 58mm
   =========================== */
function cetakStruk(){
  if(!keranjang.length && !lastSavedTransaction){ alert('Tidak ada isi untuk dicetak.'); return; }
  // Ambil snapshot keranjang saat ini (setelah simpan)
  const items = keranjang.length ? keranjang : [];
  const total = items.reduce((s,i)=>s+i.qty*i.hargaNego,0);
  const w = window.open('', '_blank');
  w.document.write(`
    <html><head><meta charset="utf-8">
      <style>
        @page{ size:58mm auto; margin:0 }
        body{ font-family:monospace; font-size:11px; margin:0; }
        .print{ width:58mm; padding:6px 8px; }
        h3{ text-align:center; margin:4px 0 6px; }
        .line{ border-top:1px dashed #000; margin:6px 0 }
        .row{ display:flex; justify-content:space-between }
      </style>
    </head><body onload="window.print(); setTimeout(()=>window.close(),300);">
      <div class="print">
        <h3>STRUK PENJUALAN</h3>
        <div>Kasir: ${currentUser.email}</div>
        <div>Cabang: ${currentUser.cabang}</div>
        <div class="line"></div>
        ${items.map(i=>`
          <div>${i.nama}${i.variasi?` (${i.variasi})`:''}</div>
          <div class="row"><span>${i.qty} x ${fmt(i.hargaNego)}</span><b>${fmt(i.qty*i.hargaNego)}</b></div>
        `).join('')}
        <div class="line"></div>
        <div class="row"><b>Total</b><b>${fmt(total)}</b></div>
        <div style="margin-top:6px; text-align:center">Terima kasih</div>
      </div>
    </body></html>
  `);
  w.document.close();
}

/* ===========================
   NAVIGASI TAB
   =========================== */
function tampilkanHalaman(hal){
  const posPage  = document.getElementById('posPage');
  const lapPage  = document.getElementById('laporanPage');
  const navKasir = document.getElementById('navKasir');
  const navLap   = document.getElementById('navLaporan');
  if(hal==='laporan'){
    posPage.classList.add('hidden'); lapPage.classList.remove('hidden');
    navLap.classList.add('active'); navKasir.classList.remove('active');
    muatLaporan();
  }else{
    lapPage.classList.add('hidden'); posPage.classList.remove('hidden');
    navKasir.classList.add('active'); navLap.classList.remove('active');
  }
}

/* ===========================
   LAPORAN + ADMIN HAPUS ITEM
   =========================== */
async function muatLaporan(){
  if(!currentUser) return;
  const loader = document.getElementById('reportContent');
  loader.innerHTML = '<div class="muted">Memproses...</div>';

  try{
    const [harian, detail] = await Promise.all([
      getData('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang }),
      getData('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang })
    ]);

    let html = '';
    // Ringkasan per cabang
    (harian.reports||[]).forEach(r=>{
      html += `
        <div class="card" style="margin-bottom:10px">
          <b>Laporan Cabang: ${r.cabang}</b>
          <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin-top:8px">
            <div>Total Penjualan<br><b>${fmt(r.totalPenjualan)}</b></div>
            <div>Jumlah Transaksi<br><b>${r.jumlahTransaksi}</b></div>
            <div>Penjualan Tunai<br><b>${fmt(r.totalTunai)}</b></div>
            <div>Penjualan Non-Tunai<br><b>${fmt(r.totalNonTunai)}</b></div>
          </div>
        </div>`;
    });

    // Detail item terjual (tiap cabang)
    if(currentUser.role==='Admin'){
      const grouped = detail.groupedTransactions || {};
      Object.keys(grouped).forEach(cbg=>{
        html += renderDetailTabel(cbg, grouped[cbg], true);
      });
    }else{
      html += renderDetailTabel(currentUser.cabang, (detail.transactions||[]), false);
    }

    loader.innerHTML = html || '<div class="muted">Tidak ada data hari ini.</div>';
  }catch(e){
    loader.innerHTML = '<div class="muted">Gagal memuat laporan: '+e.message+'</div>';
  }
}

function renderDetailTabel(cabang, list, isAdmin){
  const rows = (list||[]).map(it=>`
    <tr>
      <td>${it.timestamp||''}</td>
      <td>${it.produk||''}</td>
      <td class="right">${it.qty}</td>
      <td class="right">${fmt(it.hargaSatuan||0)}</td>
      <td class="right"><b>${fmt(it.total||0)}</b></td>
      <td class="row-actions" style="text-align:center">${ isAdmin ? `<button onclick="hapusItemAdmin(${it.row})">❌</button>` : '' }</td>
    </tr>
  `).join('');
  return `
    <details class="card" style="margin-top:10px" open>
      <summary><b>Lihat Detail Item Terjual - Cabang ${cabang}</b></summary>
      <div style="margin-top:8px; overflow:auto">
        <table class="table">
          <thead><tr>
            <th>Waktu</th><th>Produk</th><th>Qty</th><th>Harga Satuan</th><th>Total</th><th>Aksi</th>
          </tr></thead>
          <tbody>${rows || '<tr><td colspan="6">Tidak ada item.</td></tr>'}</tbody>
        </table>
      </div>
    </details>
  `;
}

async function hapusItemAdmin(row){
  if(!confirm('Yakin hapus baris transaksi ini?')) return;
  try{
    const res = await postData('hapusItem', { row, userRole: currentUser.role, userCabang: currentUser.cabang });
    if(!res.success){ alert(res.message||'Gagal menghapus.'); return; }
    await muatLaporan(); // refresh
  }catch(e){ alert('Gagal: '+e.message); }
}

/* ===========================
   UTIL TAMBAHAN
   =========================== */
function tambahItemManual(){ bukaFormManual(); }
</script>
</body>
</html>
