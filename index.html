<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasir Toko Tanaman</title>
  <style>
    /* ====== Light Theme ====== */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; transition: background-color .3s, color .3s; }
    .container { max-width: 980px; margin: 0 auto; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin: 15px 0; }
    h2, h3, h4 { color: #1a1a1a; margin-top: 0; }
    input, select, button { padding: 12px 15px; margin: 8px 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background-color: #28a745; color: #fff; font-weight: 700; border: none; cursor: pointer; transition: background-color .2s; }
    button:hover { background-color: #218838; }
    button:disabled { background-color: #9aa0a6; cursor: not-allowed; }
    .btn-secondary { background:#6c757d; }
    .btn-blue { background:#0d6efd; }
    .btn-warning { background:#ffc107; color:#333; }
    .btn-danger { background:#dc3545; }
    .hidden { display:none; }

    .header-controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px; }
    #userInfo { flex-grow:1; color:#555; font-size:14px; }
    #userInfo a { font-weight:700; color:#dc3545; text-decoration:none; font-size:12px; }
    #theme-toggle { width:40px; height:40px; padding:0; font-size:20px; border-radius:50%; background:#e9ecef; color:#333; border:1px solid #ddd; line-height:1; }

    .nav { display:flex; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1); border-radius:12px; margin:0 auto; padding:5px; }
    .nav-button { flex:1; padding:15px; text-align:center; background:none; border:none; font-size:16px; font-weight:700; color:#555; cursor:pointer; border-radius:8px; }
    .nav-button.active { background:#28a745; color:#fff; }

    .product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; }
    .product-card { border:1px solid #eee; border-radius:8px; overflow:hidden; text-align:center; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.05); padding-bottom:10px; display:none; }
    .product-card img { width:100%; height:100px; object-fit:cover; }
    .product-card p { margin:8px 5px; font-size:14px; }
    .product-admin-info { margin-top:8px; font-size:11px; color:#6c757d; background:#f8f9fa; padding:5px; border-radius:4px; text-align:left; margin:5px; }
    .product-admin-info strong { color:#0d6efd; }

    .cart-item { padding:10px 0; border-bottom:1px solid #f0f0f0; }
    .cart-item-details { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .cart-item-info { flex:1; }
    .btn-remove { background:none; border:none; color:#dc3545; font-size:24px; cursor:pointer; padding:0 5px; width:auto; line-height:1; }

    .cart-controls { display:flex; align-items:center; justify-content:space-between; background:#f8f9fa; padding:8px; border-radius:8px; margin-top:8px; gap:10px; flex-wrap:wrap; }
    .quantity-controls { display:flex; align-items:center; gap:6px; }
    .quantity-controls button { width:34px; height:34px; padding:0; font-size:20px; border-radius:50%; }
    .quantity-controls input { width:60px; text-align:center; padding:6px; -moz-appearance:textfield; }
    .quantity-controls input::-webkit-outer-spin-button,
    .quantity-controls input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .price-control { display:flex; align-items:center; gap:5px; }
    .price-control input { width:100px; text-align:right; padding:6px; }

    .total-section { margin-top:15px; font-weight:700; font-size:1.1em; }
    .total-section div { display:flex; justify-content:space-between; padding:5px 0; }
    .discount-applied { color:#28a745; }

    .filter-controls { display:flex; gap:10px; align-items:center; margin-bottom:20px; }
    .filter-controls select { flex:1; }
    .filter-controls button { width:auto; }

    .pagination-controls { display:flex; justify-content:space-between; align-items:center; margin-top:20px; }
    .pagination-controls button { width:auto; padding:8px 15px; font-size:14px; }
    .pagination-controls span { font-weight:700; font-size:14px; }

    /* Toolbar kecil untuk aksi opsional */
    .mini-toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .mini-toolbar .mini-btn { padding:8px 10px; width:auto; font-size:13px; border-radius:6px; }
    .mini-section { margin-top:10px; }

    /* Laporan */
    .report-card { background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px; }
    .report-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .report-card h4 { margin:0 0 10px; color:#555; font-size:14px; }
    .report-card p { margin:0; font-size:22px; font-weight:700; color:#1a1a1a; }
    .report-grand-total { background:#e9ecef; padding:20px; border-radius:12px; margin-top:20px; }
    .report-detail-table { width:100%; border-collapse:collapse; margin-top:20px; font-size:12px; }
    .report-detail-table th, .report-detail-table td { border:1px solid #ddd; padding:8px; text-align:left; }
    .report-detail-table th { background:#f2f2f2; }

    details summary { font-weight:700; cursor:pointer; padding:10px; background:#f1f1f1; border-radius:8px; margin-top:20px; list-style:none; position:relative; padding-left:30px; }
    details summary::-webkit-details-marker { display:none; }
    details summary::before { content:'▶'; position:absolute; left:10px; top:50%; transform:translateY(-50%); }
    details[open] > summary::before { content:'▼'; }

    /* ====== Dark Theme ====== */
    body.dark-mode { background:#1a1a1a; color:#e0e0e0; }
    body.dark-mode .card { background:#2c2c2c; border:1px solid #444; }
    body.dark-mode h2, body.dark-mode h3, body.dark-mode h4 { color:#f5f5f5; }
    body.dark-mode input, body.dark-mode select { background:#333; border-color:#555; color:#e0e0e0; }
    body.dark-mode input::placeholder { color:#888; }
    body.dark-mode .nav { background:#2c2c2c; }
    body.dark-mode .nav-button { color:#aaa; }
    body.dark-mode .nav-button.active { background:#28a745; color:#fff; }
    body.dark-mode .product-card { background:#333; border-color:#444; }
    body.dark-mode .cart-item { border-bottom-color:#444; }
    body.dark-mode .cart-controls { background:#3a3a3a; }
    body.dark-mode #theme-toggle { background:#444; color:#e0e0e0; border-color:#555; }
    body.dark-mode .report-card, body.dark-mode .report-grand-total { background:#333; }
    body.dark-mode .report-card h4 { color:#aaa; }
    body.dark-mode .report-card p { color:#f5f5f5; }
    body.dark-mode details summary { background:#3a3a3a; }
    body.dark-mode .report-detail-table th, body.dark-mode .report-detail-table td { border-color:#555; }
    body.dark-mode .report-detail-table th { background:#444; }

    /* Cetak 58mm */
    #strukArea { display:none; }
    @media print {
      body * { visibility: hidden; }
      #strukArea, #strukArea * { visibility: visible; }
      #strukArea { position:absolute; left:0; top:0; width:100%; max-width:58mm; font-family:'Courier New', Courier, monospace; line-height:1.4; font-size:10pt; }
      #strukArea h3 { text-align:center; margin:0; font-size:12pt; }
      #strukArea p { margin:2px 0; }
      #strukArea table { width:100%; border-collapse:collapse; margin-top:5px; }
      #strukArea td { text-align:left; padding:1px 0; vertical-align:top; }
      #strukArea .total-line td { border-top:1px dashed #000; padding-top:5px; }
      #strukArea .footer { text-align:center; margin-top:10px; font-size:9pt; }
    }

    /* — FIX: sembunyikan kolom nego sampai tombol diklik — */
    .hidden { display: none !important; }
    .price-control.hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container" id="loginPage">
    <div class="card">
      <h2>Login Kasir</h2>
      <input type="email" id="emailInput" placeholder="Email (contoh: kasir@tokotanaman.com)">
      <button onclick="login()">Masuk</button>
    </div>
  </div>

  <div id="appContainer" class="hidden">
    <div class="container">
      <div class="header-controls">
        <p id="userInfo"></p>
        <button id="theme-toggle" onclick="toggleTheme()">☀️</button>
      </div>
      <div class="nav">
        <button class="nav-button active" id="navKasir" onclick="tampilkanHalaman('pos')">Kasir</button>
        <button class="nav-button" id="navLaporan" onclick="tampilkanHalaman('laporan')">Laporan</button>
      </div>
    </div>

    <div id="posPage">
      <div class="container">
        <div id="loader">Memuat produk...</div>

        <div id="mainContent" class="hidden">
          <div class="card">
            <h3>Pilih Produk</h3>
            <div class="filter-controls">
              <select id="categorySelect" onchange="filterByCategory(this.value)"></select>
              <button class="btn-secondary" onclick="filterByCategory('Semua')">Home</button>
              <label style="display:flex;align-items:center;gap:8px;margin-left:auto;">
                <span style="font-size:14px;color:#555;">Tampilkan Info Modal</span>
                <input type="checkbox" id="toggleInfoModal" onchange="toggleInfoModalView()" style="width:auto;">
              </label>
            </div>
            <input type="text" id="searchInput" placeholder="Cari tanaman..." onkeyup="updateProductView()">
            <div class="product-grid" id="produkList"></div>
            <div class="pagination-controls hidden" id="paginationControls">
              <button id="prevPageBtn" onclick="changePage(-1)">&laquo; Sebelumnya</button>
              <span id="pageInfo"></span>
              <button id="nextPageBtn" onclick="changePage(1)">Berikutnya &raquo;</button>
            </div>
          </div>

          <!-- Toolbar kecil -->
          <div class="card">
            <div class="mini-toolbar">
              <button class="mini-btn btn-secondary" onclick="toggleForm('memberFormContainer')">+ Member</button>
              <button class="mini-btn btn-secondary" onclick="toggleForm('manualItemFormContainer')">+ Item Manual</button>
              <button class="mini-btn btn-warning" onclick="toggleForm('diskonFormContainer')">Diskon Member</button>
            </div>

            <!-- Form tersembunyi -->
            <div id="memberFormContainer" class="hidden mini-section">
              <h3>Form Member Baru</h3>
              <input type="text" id="newMemberName" placeholder="Nama Member Baru">
              <input type="number" id="newMemberHp" placeholder="Nomor HP Member Baru">
              <button onclick="daftarkanMemberBaru(this)">+ Daftarkan</button>
            </div>

            <div id="manualItemFormContainer" class="hidden mini-section">
              <h3>Form Item Manual</h3>
              <input type="text" id="manualItemName" placeholder="Nama Item (cth: Biaya Antar)">
              <input type="number" id="manualItemPrice" placeholder="Harga">
              <button onclick="tambahItemManual()">+ Tambah</button>
            </div>

            <div class="card mini-section" id="keranjangCard" style="margin:10px 0 0;">
              <h3>Keranjang Belanja</h3>
              <div id="diskonFormContainer" class="hidden" style="margin-top:5px; border-bottom:1px solid #f0f0f0; padding-bottom:10px;">
                <input type="text" id="memberId" placeholder="ID Member (No. HP)">
                <button id="btnTerapkanDiskon" onclick="terapkanDiskon(this)">Terapkan Diskon</button>
              </div>

              <div id="cartItems">Tidak ada item.</div>
              <div class="total-section">
                <div id="subtotalLine"><span>Subtotal:</span> <span id="subtotalHarga">Rp 0</span></div>
                <div id="diskonLine" class="hidden"><span>Penghematan Member:</span> <span id="nilaiDiskon" class="discount-applied">Rp 0</span></div>
                <hr>
                <div><span>Total:</span> <span id="totalHarga">Rp 0</span></div>
              </div>
              <button id="btnSelesaikanTransaksi" class="hidden btn-blue" onclick="tampilkanPembayaran()">Lanjut ke Pembayaran</button>
            </div>

            <div class="card hidden" id="paymentCard">
              <h3>Detail Pembayaran</h3>
              <h4>Total Tagihan: <span id="paymentTotalTagihan">Rp 0</span></h4>
              <div class="payment-options">
                <label><input type="radio" name="metodePembayaran" value="Tunai" onchange="togglePaymentDetails()" checked style="width:auto"> Tunai</label>
                <label><input type="radio" name="metodePembayaran" value="Non-Tunai" onchange="togglePaymentDetails()" style="width:auto"> Non-Tunai</label>
              </div>
              <div id="tunaiDetails">
                <input type="number" id="uangDiterima" placeholder="Uang Diterima (Rp)" oninput="hitungKembalian()">
                <p>Kembalian: <strong id="kembalian">Rp 0</strong></p>
              </div>
              <div id="nonTunaiDetails" class="hidden">
                <select id="jenisNonTunai">
                  <option value="QRIS">QRIS</option>
                  <option value="Shopee">Shopee</option>
                  <option value="Tokopedia">Tokopedia</option>
                  <option value="Transfer">Transfer</option>
                </select>
              </div>
              <button id="btnKonfirmasiPembayaran" class="btn-blue" onclick="selesaikanTransaksi(this)">Konfirmasi & Simpan</button>
              <button class="btn-secondary" onclick="batalPembayaran()">Kembali ke Keranjang</button>
            </div>

            <div class="card hidden" id="postTransactionCard">
              <h4>Transaksi Berhasil!</h4>
              <p style="text-align:center; color:#555; font-size:14px;">Silakan cetak struk atau kembali ke kasir.</p>
              <button id="btnCetakStruk" onclick="cetakStruk()">Cetak Struk</button>
              <button class="btn-secondary" onclick="kembaliKeHalamanAwal()">Kembali ke Kasir</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container hidden" id="laporanPage">
      <div class="card">
        <h3 id="laporanTitle">Laporan Penjualan Hari Ini</h3>
        <p><small>(Data diperbarui setiap ada transaksi baru)</small></p>
        <div id="reportLoader">Memuat laporan...</div>
        <div id="reportContent" class="hidden"></div>
        <div id="detailDropdownContainer"></div>
      </div>
    </div>
  </div>

  <div id="strukArea"></div>

  <script>
    /* =============================
       KONFIG BACKEND (JSONP, bebas CORS)
       ============================= */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJXVMVdiDZ0VLQSypl7r2dy1gzixMD8MmnNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, 15000);
        function cleanup(){ delete window[cb]; s.remove(); clearTimeout(timer); }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.body.appendChild(s);
      });
    }
    async function getData(action, payload = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.set('action', action);
      if (payload && Object.keys(payload).length) {
        url.searchParams.set('payload', JSON.stringify(payload));
      }
      return jsonp(url.toString());
    }
    async function postData(action, payload = {}) { return getData(action, payload); }

    /* =============================
       STATE & UTIL
       ============================= */
    var semuaProduk = [], keranjang = [], currentUser = null;
    var currentPage = 1, itemsPerPage = 6, isMemberActive = false, lastTransactionData = {};

    function toggleTheme() {
      var body = document.body;
      body.classList.toggle('dark-mode');
      var theme = body.classList.contains('dark-mode') ? 'dark' : 'light';
      localStorage.setItem('theme', theme);
      document.getElementById('theme-toggle').textContent = theme === 'dark' ? '🌙' : '☀️';
    }
    function toggleForm(id) { document.getElementById(id).classList.toggle('hidden'); }
    function toggleNegoForm(index, show) {
      var btn = document.getElementById('nego-btn-' + index);
      var form = document.getElementById('price-control-' + index);
      if (show) { btn.classList.add('hidden'); form.classList.remove('hidden'); }
      else { btn.classList.remove('hidden'); form.classList.add('hidden'); }
    }

    window.onload = function(){
      try {
        var savedUser = localStorage.getItem('currentUser');
        if (savedUser) setupApp(JSON.parse(savedUser));
      } catch (e) { console.error('Gagal memuat sesi:', e); localStorage.removeItem('currentUser'); }
      var savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-toggle').textContent = '🌙'; }
      else { document.getElementById('theme-toggle').textContent = '☀️'; }
    };

    /* =============================
       AUTH
       ============================= */
    async function login(){
      var email = document.getElementById('emailInput').value;
      if (!email) return alert('Email tidak boleh kosong.');
      try {
        const res = await getData('cekLogin', { email });
        hasilLogin(res);
      } catch(e){ alert('Gagal terhubung ke server.'); }
    }
    function logout(){
      if (confirm('Apakah Anda yakin ingin logout?')) { localStorage.removeItem('currentUser'); location.reload(); }
    }
    function setupApp(user){
      currentUser = user;
      document.getElementById('userInfo').innerHTML = '<span>Kasir: '+currentUser.email+' | Cabang: '+currentUser.cabang+'</span> <a href="#" onclick="logout();return false;">Logout</a>';
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      muatProduk();
    }
    function hasilLogin(res){
      if (res && res.success) { localStorage.setItem('currentUser', JSON.stringify(res.user)); setupApp(res.user); }
      else { alert((res && res.message) || 'Login gagal.'); }
    }

    /* =============================
       PRODUK
       ============================= */
    async function muatProduk(){
      try{
        const data = await getData('getProduk');
        tampilkanProduk(data);
      }catch(e){ alert('Gagal memuat produk.'); }
    }
    function tampilkanProduk(data){
      if (!data || !Array.isArray(data)) {
        alert("Gagal memuat data produk atau format salah.");
        document.getElementById('loader').textContent = "Error: Data Produk Tidak Valid.";
        return;
      }
      semuaProduk = data;
      var container = document.getElementById('produkList');
      var filterSelect = document.getElementById('categorySelect');
      container.innerHTML = ''; filterSelect.innerHTML = '';

      var categories = ['Semua'];
      var categorySet = new Set(data.map(p => p && p['Jenis']).filter(Boolean));
      categories = categories.concat(Array.from(categorySet));
      categories.forEach(function(category){
        var option = document.createElement('option'); option.value = category; option.textContent = category; filterSelect.appendChild(option);
      });

      data.forEach(function(p, index){
        if (!p || !p['Nama Produk']) return;
        var div = document.createElement('div'); div.className = 'product-card'; div.dataset.jenis = p['Jenis'] || ''; div.dataset.index = index;
        var hargaJual = parseInt(p['Harga Jual']) || 0;
        var hargaMember = parseInt(p['Harga Member']) || 0;
        var hargaModal = parseInt(p['Harga Modal']) || 0;
        var supplier = p['Supplier'] || 'Tidak ada';
        div.innerHTML =
          '<img src="'+(p['Foto URL'] || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=x')+'" alt="'+p['Nama Produk']+'" onerror="this.onerror=null;this.src=\'https://placehold.co/100x100/e2e8f0/e2e8f0?text=x\';">'+
          '<p>'+p['Nama Produk']+' ('+(p['Ukuran/Variasi']||'')+')</p>'+
          '<p><strong>Rp '+hargaJual.toLocaleString()+'</strong></p>'+
          '<div class="product-admin-info hidden">'+
          '  <small>Modal: Rp '+hargaModal.toLocaleString()+'<br>'+
          '  <strong>Member: Rp '+hargaMember.toLocaleString()+'</strong><br>'+
          '  Supplier: '+supplier+'</small>'+
          '</div>'+
          '<button class="btn-secondary" style="width:auto" onclick="tambahKeKeranjang('+index+')">+ Keranjang</button>';
        container.appendChild(div);
      });

      document.getElementById('loader').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      toggleInfoModalView();
      updateProductView();
    }

    /* =============================
       KERANJANG
       ============================= */
    function tambahKeKeranjang(index){
      var produk = semuaProduk[index];
      var itemAda = keranjang.find(item => item.produk['ID Produk'] === produk['ID Produk'] && item.produk['Ukuran/Variasi'] === produk['Ukuran/Variasi']);
      var hargaJual = parseInt(produk['Harga Jual']) || 0;
      var hargaMember = parseInt(produk['Harga Member']) || 0;
      var hargaEfektif = (isMemberActive && hargaMember > 0 && hargaMember < hargaJual) ? hargaMember : hargaJual;
      if (itemAda) itemAda.qty++;
      else keranjang.push({ produk: produk, qty: 1, hargaSaatIni: hargaEfektif });
      updateKeranjang();
    }
    function ubahJumlah(index, amount){
      var item = keranjang[index]; if (!item) return;
      item.qty += amount; if (item.qty <= 0) hapusItem(index); else updateKeranjang();
    }
    function ubahHarga(el, index){
      var item = keranjang[index]; if (!item) return;
      var newPrice = parseInt(el.value);
      if (isNaN(newPrice) || newPrice < 0) {
        var hj = parseInt(item.produk['Harga Jual']) || 0;
        var hm = parseInt(item.produk['Harga Member']) || 0;
        item.hargaSaatIni = (isMemberActive && hm > 0 && hm < hj) ? hm : hj;
      } else { item.hargaSaatIni = newPrice; }
      updateKeranjang();
    }
    function setJumlah(el, index){
      var item = keranjang[index]; if (!item) return;
      var n = parseInt(el.value); if (isNaN(n) || n <= 0) hapusItem(index); else { item.qty = n; updateKeranjang(); }
    }
    function hapusItem(index){ keranjang.splice(index,1); updateKeranjang(); }

    function updateKeranjang(){
      var container = document.getElementById('cartItems');
      if (keranjang.length === 0) {
        container.innerHTML = 'Tidak ada item.';
        document.getElementById('btnSelesaikanTransaksi').classList.add('hidden');
      } else {
        container.innerHTML = '';
        keranjang.forEach(function(item, i){
          var totalItem = item.qty * item.hargaSaatIni;
          var div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML =
            '<div class="cart-item-details">'+
              '<div class="cart-item-info">'+
                item.produk['Nama Produk']+' ('+(item.produk['Ukuran/Variasi']||'')+')<br>'+
                '<strong>'+item.qty+' x '+item.hargaSaatIni.toLocaleString()+' = Rp '+totalItem.toLocaleString()+'</strong>'+
              '</div>'+
              '<button class="btn-remove" onclick="hapusItem('+i+')">&times;</button>'+
            '</div>'+
            '<div class="cart-controls">'+
              '<div class="quantity-controls">'+
                '<button onclick="ubahJumlah('+i+',-1)">-</button>'+
                '<input type="number" value="'+item.qty+'" onchange="setJumlah(this,'+i+')">'+
                '<button onclick="ubahJumlah('+i+',1)">+</button>'+
              '</div>'+
              '<button id="nego-btn-'+i+'" class="btn-warning" style="width:auto" onclick="toggleNegoForm('+i+',true)">Nego</button>'+
              '<div id="price-control-'+i+'" class="price-control hidden">'+
                '<span>Rp</span>'+
                '<input type="number" value="'+item.hargaSaatIni+'" onchange="ubahHarga(this,'+i+')">'+
                '<button class="btn-blue" style="width:auto" onclick="toggleNegoForm('+i+',false)">OK</button>'+
              '</div>'+
            '</div>';
          container.appendChild(div);
        });
        document.getElementById('btnSelesaikanTransaksi').classList.remove('hidden');
      }
      kalkulasiTotal();
    }

    function kalkulasiTotal(){
      var subtotal = 0, subtotalNormal = 0;
      keranjang.forEach(function(item){
        var hargaJualNormal = parseInt(item.produk['Harga Jual']) || 0;
        subtotal += item.qty * item.hargaSaatIni;
        subtotalNormal += item.qty * hargaJualNormal;
      });
      document.getElementById('subtotalHarga').textContent = 'Rp ' + subtotalNormal.toLocaleString();
      document.getElementById('subtotalLine').classList.toggle('hidden', keranjang.length === 0);
      var penghematan = subtotalNormal - subtotal;
      if (penghematan > 0) {
        document.getElementById('diskonLine').classList.remove('hidden');
        document.getElementById('nilaiDiskon').textContent = '- Rp ' + penghematan.toLocaleString();
      } else { document.getElementById('diskonLine').classList.add('hidden'); }
      document.getElementById('totalHarga').textContent = 'Rp ' + subtotal.toLocaleString();
      return { totalAkhir: subtotal, totalHemat: penghematan };
    }

    async function terapkanDiskon(btn){
      var nomorHp = document.getElementById('memberId').value;
      if (!nomorHp) return alert('Silakan masukkan nomor HP member.');
      btn.disabled = true; btn.textContent = 'Mengecek...';
      try {
        const res = await getData('cekMember', { nomorHp });
        if (res.success) { alert('Harga member untuk '+res.nama+' berhasil diterapkan.'); isMemberActive = true; btn.textContent = 'Harga Member Aktif'; btn.classList.add('disabled'); }
        else { alert(res.message); isMemberActive = false; btn.disabled = false; btn.textContent = 'Terapkan Diskon'; }
        updateKeranjang();
      } catch(e){ alert('Gagal menghubungi server untuk cek member.'); btn.disabled=false; btn.textContent='Terapkan Diskon'; }
    }

    async function daftarkanMemberBaru(btn){
      var nama = document.getElementById('newMemberName').value;
      var nomorHp = document.getElementById('newMemberHp').value;
      if (!nama || !nomorHp) return alert('Nama dan Nomor HP tidak boleh kosong.');
      btn.disabled = true; btn.textContent='Mendaftarkan...';
      try {
        const res = await postData('tambahMemberBaru', { nama, nomorHp });
        alert(res.message);
        if (res.success){ document.getElementById('newMemberName').value=''; document.getElementById('newMemberHp').value=''; toggleForm('memberFormContainer'); }
      } catch(e){ alert('Gagal menghubungi server untuk mendaftarkan member.'); }
      finally { btn.disabled=false; btn.textContent='+ Daftarkan'; }
    }

    function tambahItemManual(){
      var name = document.getElementById('manualItemName').value;
      var price = parseInt(document.getElementById('manualItemPrice').value);
      if (name && price > 0) {
        var manualProduct = { 'ID Produk':'MANUAL-'+Date.now(), 'Nama Produk':name, 'Ukuran/Variasi':'Custom', 'Harga Jual':price, 'Harga Member':price, 'Harga Modal':0, 'Supplier':'Internal' };
        keranjang.push({ produk: manualProduct, qty: 1, hargaSaatIni: price });
        updateKeranjang();
        document.getElementById('manualItemName').value = ''; document.getElementById('manualItemPrice').value = '';
        toggleForm('manualItemFormContainer');
      } else { alert('Nama item dan harga manual harus diisi.'); }
    }

    function tampilkanPembayaran(){
      if (keranjang.length === 0) return alert('Keranjang kosong.');
      var totalInfo = kalkulasiTotal();
      document.getElementById('paymentTotalTagihan').textContent = 'Rp ' + totalInfo.totalAkhir.toLocaleString();
      document.getElementById('keranjangCard').classList.add('hidden');
      document.getElementById('paymentCard').classList.remove('hidden');
      hitungKembalian();
    }
    function batalPembayaran(){ document.getElementById('paymentCard').classList.add('hidden'); document.getElementById('keranjangCard').classList.remove('hidden'); }
    function togglePaymentDetails(){
      var selected = document.querySelector('input[name="metodePembayaran"]:checked').value;
      document.getElementById('tunaiDetails').classList.toggle('hidden', selected !== 'Tunai');
      document.getElementById('nonTunaiDetails').classList.toggle('hidden', selected === 'Tunai');
    }
    function hitungKembalian(){
      var totalInfo = kalkulasiTotal(); var uangDiterima = parseInt(document.getElementById('uangDiterima').value) || 0; var kembalian = uangDiterima - totalInfo.totalAkhir;
      document.getElementById('kembalian').textContent = 'Rp ' + (kembalian >= 0 ? kembalian.toLocaleString() : 0);
    }

    async function selesaikanTransaksi(btn){
      var metode = document.querySelector('input[name="metodePembayaran"]:checked').value;
      var detailMetode = (metode === 'Non-Tunai') ? document.getElementById('jenisNonTunai').value : '';
      var totalInfo = kalkulasiTotal();
      var dataTransaksi = {
        items: keranjang.map(function(item){ return { produk:item.produk, qty:item.qty, hargaAkhirSatuan:item.hargaSaatIni }; }),
        memberId: document.getElementById('memberId').value,
        metodePembayaran: metode, detailMetode: detailMetode,
        diskonJumlah: totalInfo.totalHemat, totalAkhir: totalInfo.totalAkhir,
        timestamp: new Date().toISOString(), cabang: currentUser.cabang
      };
      lastTransactionData = dataTransaksi;
      btn.disabled = true; btn.textContent = 'Menyimpan...';
      try {
        const res = await postData('simpanTransaksi', dataTransaksi);
        onTransaksiSuccess(res);
      } catch(e){ onTransaksiFailure(e); }
    }
    function onTransaksiSuccess(response){
      var b = document.getElementById('btnKonfirmasiPembayaran');
      if (response === 'Sukses' || (response && response.success)) {
        document.getElementById('paymentCard').classList.add('hidden');
        document.getElementById('postTransactionCard').classList.remove('hidden');
        generateStruk();
      } else { alert('Gagal menyimpan transaksi: '+response); }
      b.disabled=false; b.textContent='Konfirmasi & Simpan';
    }
    function onTransaksiFailure(error){
      alert('Terjadi kesalahan saat menyimpan transaksi: '+(error && error.message ? error.message : error));
      var b = document.getElementById('btnKonfirmasiPembayaran'); b.disabled=false; b.textContent='Konfirmasi & Simpan';
    }
    function kembaliKeHalamanAwal(){
      document.getElementById('postTransactionCard').classList.add('hidden');
      document.getElementById('keranjangCard').classList.remove('hidden');
      resetKeranjang(); filterByCategory('Semua');
    }
    function resetKeranjang(){
      keranjang = []; isMemberActive = false; lastTransactionData = {};
      var m = document.getElementById('memberId'); if (m) m.value='';
      var btn = document.getElementById('btnTerapkanDiskon'); btn.textContent='Terapkan Diskon'; btn.disabled=false; btn.classList.remove('disabled');
      updateKeranjang();
    }

    function generateStruk(){
      var el = document.getElementById('strukArea'); var totalInfo = kalkulasiTotal(); var now = new Date();
      var date = now.toLocaleDateString('id-ID'); var time = now.toLocaleTimeString('id-ID');
      var itemsHtml = '';
      (lastTransactionData.items || []).forEach(function(item){
        itemsHtml += '<tr><td colspan="3">'+item.produk['Nama Produk']+'</td></tr>'+
                     '<tr><td>'+item.qty+'x</td><td style="text-align:right;">'+item.hargaAkhirSatuan.toLocaleString()+'</td><td style="text-align:right;">'+(item.qty*item.hargaAkhirSatuan).toLocaleString()+'</td></tr>';
      });
      el.innerHTML =
        '<h3>Toko</h3>'+
        '<p>Cabang: '+currentUser.cabang+'</p>'+
        '<p>Kasir: '+currentUser.email+'</p>'+
        '<p>Tanggal: '+date+' '+time+'</p><hr>'+
        '<table>'+itemsHtml+'</table><hr>'+
        '<table>'+
        '  <tr class="total-line"><td colspan="2">Subtotal</td><td style="text-align:right;">'+(totalInfo.totalAkhir+totalInfo.totalHemat).toLocaleString()+'</td></tr>'+
        (totalInfo.totalHemat>0 ? '<tr><td colspan="2">Diskon</td><td style="text-align:right;">-'+totalInfo.totalHemat.toLocaleString()+'</td></tr>' : '')+
        '  <tr class="total-line"><td colspan="2"><strong>TOTAL</strong></td><td style="text-align:right;"><strong>'+totalInfo.totalAkhir.toLocaleString()+'</strong></td></tr>'+
        '</table>'+
        '<p class="footer">Terima kasih!</p>';
    }
    function cetakStruk(){ window.print(); }

    /* =============================
       LAPORAN
       ============================= */
    function tampilkanHalaman(hal){
      var posPage = document.getElementById('posPage');
      var laporanPage = document.getElementById('laporanPage');
      var navKasir = document.getElementById('navKasir');
      var navLaporan = document.getElementById('navLaporan');
      if (hal === 'laporan') {
        posPage.classList.add('hidden'); laporanPage.classList.remove('hidden');
        navKasir.classList.remove('active'); navLaporan.classList.add('active');
        muatLaporan();
      } else {
        laporanPage.classList.add('hidden'); posPage.classList.remove('hidden');
        navLaporan.classList.remove('active'); navKasir.classList.add('active');
      }
    }

    async function muatLaporan(){
      if (!currentUser) return;
      document.getElementById('reportLoader').classList.remove('hidden');
      document.getElementById('reportContent').classList.add('hidden');
      document.getElementById('detailDropdownContainer').innerHTML = '';

      try {
        const harian = await getData('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang });
        tampilkanDataLaporan(harian);
      } catch(e){ gagalMuatLaporan(e); }

      try {
        const detail = await getData('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang });
        tampilkanDetailLaporan(detail);
      } catch(e){ gagalMuatLaporan(e); }

      // (Opsional) Panel admin pembatalan bila backend tersedia
      if (currentUser.role === 'Admin') {
        try {
          const dataAdm = await getData('getTransaksiHariIni', { role: currentUser.role, cabang: currentUser.cabang });
          renderAdminPembatalan(dataAdm);
        } catch(_) { /* jika endpoint belum ada, abaikan */ }
      }
    }

    function gagalMuatLaporan(err){
      var loader = document.getElementById('reportLoader');
      loader.textContent = 'Gagal memuat laporan: ' + (err && err.toString ? err.toString() : err);
    }

    function tampilkanDataLaporan(data){
      if (data && data.error) return gagalMuatLaporan(data.error);
      var reportContent = document.getElementById('reportContent'); reportContent.innerHTML = '';
      var grandTotal = 0, grandTransaksi = 0;
      (data.reports || []).forEach(function(report){
        var html =
          '<div class="report-card">'+
            '<h4>Laporan Cabang: '+report.cabang+'</h4>'+
            '<div class="report-grid">'+
              '<div><h4>Total Penjualan</h4><p>Rp '+(report.totalPenjualan||0).toLocaleString()+'</p></div>'+
              '<div><h4>Jumlah Transaksi</h4><p>'+(report.jumlahTransaksi||0)+'</p></div>'+
              '<div><h4>Penjualan Tunai</h4><p>Rp '+(report.totalTunai||0).toLocaleString()+'</p></div>'+
              '<div><h4>Penjualan Non-Tunai</h4><p>Rp '+(report.totalNonTunai||0).toLocaleString()+'</p></div>'+
            '</div>'+
          '</div>';
        reportContent.innerHTML += html;
        grandTotal += report.totalPenjualan || 0;
        grandTransaksi += report.jumlahTransaksi || 0;
      });
      if (currentUser.role === 'Admin' && (data.reports||[]).length > 1) {
        document.getElementById('laporanTitle').textContent = 'Laporan Gabungan Semua Cabang';
        reportContent.innerHTML +=
          '<div class="report-grand-total">'+
            '<h3>Total Keseluruhan (Semua Cabang)</h3>'+
            '<h4>Total Pemasukan: Rp '+grandTotal.toLocaleString()+'</h4>'+
            '<h4>Total Transaksi: '+grandTransaksi+'</h4>'+
          '</div>';
      } else { document.getElementById('laporanTitle').textContent = 'Laporan Penjualan Hari Ini ('+currentUser.cabang+')'; }
      document.getElementById('reportLoader').classList.add('hidden'); reportContent.classList.remove('hidden');
    }

    function tampilkanDetailLaporan(data){
      var main = document.getElementById('detailDropdownContainer'); main.innerHTML = '';
      if (data && data.error) { main.innerHTML = '<p style="color:red;">Gagal memuat detail.</p>'; return; }
      function createTable(list){
        if (!list || !list.length) return '<p>Tidak ada detail transaksi.</p>';
        var t = '<div style="overflow-x:auto;"><table class="report-detail-table"><thead><tr><th>Waktu</th><th>Produk</th><th>Qty</th><th>Harga Satuan</th><th>Total</th></tr></thead><tbody>';
        list.forEach(function(it){
          t += '<tr><td>'+it.timestamp+'</td><td>'+it.produk+' ('+(it.variasi||'')+')</td><td>'+it.qty+'</td><td>'+it.hargaSatuan.toLocaleString()+'</td><td>'+it.total.toLocaleString()+'</td></tr>';
        });
        t += '</tbody></table></div>'; return t;
      }
      if (currentUser.role === 'Admin' && data.groupedTransactions) {
        var keys = Object.keys(data.groupedTransactions); if (!keys.length) { main.innerHTML = '<p>Belum ada detail transaksi hari ini.</p>'; return; }
        keys.forEach(function(cab){
          var details = document.createElement('details');
          details.innerHTML = '<summary>Lihat Detail Item Terjual - Cabang '+cab+'</summary>'+createTable(data.groupedTransactions[cab]);
          main.appendChild(details);
        });
      } else if (data.transactions) {
        var details = document.createElement('details');
        details.innerHTML = '<summary>Lihat Detail Item Terjual Hari Ini</summary>'+createTable(data.transactions);
        main.appendChild(details);
      } else { main.innerHTML = '<p>Belum ada detail transaksi hari ini.</p>'; }
    }

    /* (Opsional) Panel admin pembatalan transaksi — hanya akan muncul jika backend sediakan endpoint */
    function renderAdminPembatalan(data){
      if (!data || !data.transactions) return;
      if (currentUser.role !== 'Admin') return;
      const mainContainer = document.getElementById('detailDropdownContainer');
      const list = data.transactions;
      const html =
        `<h4>🛡️ Admin: Batalkan Transaksi Hari Ini</h4>
        <div style="overflow-x:auto;">
          <table class="report-detail-table">
            <thead>
              <tr><th>ID</th><th>Waktu</th><th>Cabang</th><th>Metode</th><th>Total</th><th>Aksi</th></tr>
            </thead>
            <tbody>
              ${list.length ? list.map(t => `
                <tr>
                  <td>${t.id}</td>
                  <td>${t.waktu}</td>
                  <td>${t.cabang}</td>
                  <td>${t.metode}${t.detailMetode ? ' ('+t.detailMetode+')' : ''}</td>
                  <td>Rp ${Number(t.total).toLocaleString()}</td>
                  <td><button class="btn-danger" style="width:auto" onclick="batalkanTransaksi('${t.id}', this)">Batalkan</button></td>
                </tr>`).join('') : `<tr><td colspan="6">Tidak ada transaksi hari ini.</td></tr>`}
            </tbody>
          </table>
        </div>`;
      mainContainer.insertAdjacentHTML('afterbegin', html);
    }
    async function batalkanTransaksi(id, btn){
      if (!confirm('Yakin membatalkan transaksi '+id+' ?')) return;
      btn.disabled = true; btn.textContent = 'Memproses...';
      try {
        const res = await postData('batalkanTransaksi', { id, userRole: currentUser.role, userCabang: currentUser.cabang });
        if (res && res.success) { alert('Transaksi dibatalkan.'); muatLaporan(); }
        else { alert((res && res.message) || 'Gagal membatalkan transaksi.'); }
      } catch(e){ alert('Gagal: '+e.message); }
      finally{ btn.disabled=false; btn.textContent='Batalkan'; }
    }

    /* =============================
       FILTER & PAGINASI PRODUK
       ============================= */
    function toggleInfoModalView(){
      var isChecked = document.getElementById('toggleInfoModal').checked;
      document.querySelectorAll('.product-admin-info').forEach(el => el.classList.toggle('hidden', !isChecked));
    }
    function filterByCategory(j){ document.getElementById('categorySelect').value = j; currentPage = 1; updateProductView(); }
    function updateProductView(){
      var active = document.getElementById('categorySelect').value;
      var search = (document.getElementById('searchInput').value || '').toLowerCase();
      var cards = document.querySelectorAll('.product-card');
      var filtered = Array.from(cards).filter(function(card){
        var cat = card.dataset.jenis;
        var text = card.innerText.toLowerCase();
        var catMatch = (active === 'Semua' || cat === active);
        var searchMatch = text.includes(search);
        return catMatch && searchMatch;
      });
      cards.forEach(c => c.style.display = 'none');
      var totalPages = Math.ceil(filtered.length / itemsPerPage);
      var start = (currentPage - 1) * itemsPerPage;
      var pageCards = filtered.slice(start, start + itemsPerPage);
      pageCards.forEach(c => c.style.display = 'block');
      updatePaginationControls(totalPages);
    }
    function updatePaginationControls(totalPages){
      var controls = document.getElementById('paginationControls');
      var prevBtn = document.getElementById('prevPageBtn');
      var nextBtn = document.getElementById('nextPageBtn');
      var pageInfo = document.getElementById('pageInfo');
      if (totalPages > 1) {
        controls.classList.remove('hidden');
        pageInfo.textContent = 'Halaman ' + currentPage + ' dari ' + totalPages;
        prevBtn.disabled = (currentPage === 1);
        nextBtn.disabled = (currentPage === totalPages);
      } else { controls.classList.add('hidden'); }
    }
    function changePage(dir){ currentPage += dir; updateProductView(); }
  </script>
</body>
</html>
