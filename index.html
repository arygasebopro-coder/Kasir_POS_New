<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasir Toko Tanaman</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; margin: 0; padding: 10px; background-color: #f0f2f5; color: #333; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin: 15px 0; }
    h2, h3, h4 { color: #1a1a1a; margin-top: 0; }
    input, select, button { padding: 12px 15px; margin: 8px 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    button { background-color: #28a745; color: white; font-weight: bold; border: none; cursor: pointer; }
    button:hover { background-color: #218838; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .hidden { display: none; }

    #loader, #reportLoader { text-align: center; padding: 20px; }

    .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    #userInfo { flex-grow: 1; color: #555; font-size: 14px;}
    #userInfo a { font-weight:bold; color:#dc3545; text-decoration:none; font-size: 12px; }
    #theme-toggle { width: 40px; height: 40px; padding: 0; margin-left: 10px; font-size: 20px; border-radius: 50%; background-color: #e9ecef; color: #333; border: 1px solid #ddd; line-height: 1; }

    .nav { display: flex; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 12px; margin: 0 auto; padding: 5px; }
    .nav-button { flex: 1; padding: 15px; text-align: center; background: none; border: none; font-size: 16px; font-weight: bold; color: #555; cursor: pointer; border-radius: 8px; }
    .nav-button.active { background: #28a745; color: #fff; }

    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
    .product-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; text-align: center; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding-bottom: 10px; }
    .product-card img { width: 100%; height: 100px; object-fit: cover; }
    .product-card p { margin: 8px 5px; font-size: 14px; }

    .btn-small { padding: 5px 10px; font-size: 12px; width: auto; background-color: #007bff; margin-top: 5px;}
    .btn-remove { background: none; border: none; color: #dc3545; font-size: 24px; cursor: pointer; padding: 0 5px; width: auto; line-height: 1; }

    .cart-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .cart-item-details { flex-basis: 100%; display: flex; justify-content: space-between; align-items: center; }
    .cart-item-info { flex-grow: 1; margin-right: 10px; }
    .cart-controls { flex-basis: 100%; display: flex; align-items: center; justify-content: space-between; background-color: #f8f9fa; padding: 8px; border-radius: 8px; margin-top: 8px; }
    .quantity-controls { display: flex; align-items: center; gap: 6px; }
    .quantity-controls button { width: 30px; height: 30px; padding: 0; font-size: 20px; line-height: 1; border-radius: 50%; }
    .quantity-controls input { width: 50px; text-align: center; height: 32px; padding: 5px; -moz-appearance: textfield; }
    .quantity-controls input::-webkit-outer-spin-button,.quantity-controls input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .price-control { display: flex; align-items: center; gap: 5px; }
    .price-control input { width: 90px; text-align: right; padding: 5px; height: 32px;}

    .total-section { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
    .total-section div { display: flex; justify-content: space-between; padding: 5px 0; }
    .discount-applied { color: #28a745; }
    #btnTerapkanDiskon { background-color: #ffc107; color: #333; }

    .payment-options label { display: block; margin: 10px 0; }

    .product-admin-info { margin-top: 8px; font-size: 11px; color: #6c757d; background-color: #f8f9fa; padding: 5px; border-radius: 4px; text-align: left; margin: 5px; }
    .product-admin-info strong { color: #007bff; }

    .filter-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
    .filter-controls select { flex-grow: 1; }
    .filter-controls button { width: auto; flex-shrink: 0; }

    .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    .pagination-controls button { width: auto; padding: 8px 15px; font-size: 14px; }
    .pagination-controls span { font-weight: bold; font-size: 14px; }

    .report-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;}
    .report-card h4 { margin: 0 0 10px 0; color: #555; font-size: 14px; }
    .report-card p { margin: 0; font-size: 22px; font-weight: bold; color: #1a1a1a; }
    .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    .report-detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
    .report-detail-table th, .report-detail-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .report-detail-table th { background-color: #f2f2f2; }

    details summary { font-weight: bold; cursor: pointer; padding: 10px; background-color: #f1f1f1; border-radius: 8px; margin-top: 20px; list-style: none; position: relative; padding-left: 30px; }
    details summary::-webkit-details-marker { display: none; }
    details summary::before { content: '‚ñ∂'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); }
    details[open] > summary::before { content: '‚ñº'; }

    /* Struk 58mm */
    #strukArea { display: none; }
    @media print {
      body * { visibility: hidden; }
      #strukArea, #strukArea * { visibility: visible; }
      #strukArea { position: absolute; left: 0; top: 0; width: 100%; max-width: 58mm; font-family: 'Courier New', Courier, monospace; line-height: 1.4; font-size: 10pt; }
      #strukArea h3 { text-align: center; margin: 0; font-size: 12pt; }
      #strukArea p { margin: 2px 0; }
      #strukArea table { width: 100%; border-collapse: collapse; margin-top: 5px; }
      #strukArea td { text-align: left; padding: 1px 0; vertical-align: top; }
      #strukArea .total-line td { border-top: 1px dashed #000; padding-top: 5px; }
      #strukArea .footer { text-align: center; margin-top: 10px; font-size: 9pt; }
    }

    .price-control.hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="container" id="loginPage">
    <div class="card">
      <h2>Login Kasir</h2>
      <input type="email" id="emailInput" placeholder="Email (contoh: kasir@tokotanaman.com)">
      <button onclick="login()">Masuk</button>
    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="hidden">
    <div class="container">
      <div class="header-controls">
        <p id="userInfo"></p>
        <button id="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
      </div>

      <div class="nav">
        <button class="nav-button active" id="navKasir" onclick="tampilkanHalaman('pos')">Kasir</button>
        <button class="nav-button" id="navLaporan" onclick="tampilkanHalaman('laporan')">Laporan</button>
      </div>
    </div>

    <!-- POS -->
    <div id="posPage">
      <div class="container">
        <div id="loader">Memuat produk...</div>
        <div id="mainContent" class="hidden">
          <div class="card">
            <h3>Pilih Produk</h3>

            <div class="filter-controls">
              <select id="categorySelect" onchange="filterByCategory(this.value)"></select>
              <button onclick="filterByCategory('Semua')">Home</button>
            </div>

            <input type="text" id="searchInput" placeholder="Cari tanaman..." onkeyup="updateProductView()">
            <div class="product-grid" id="produkList"></div>

            <div class="pagination-controls hidden" id="paginationControls">
              <button id="prevPageBtn" onclick="changePage(-1)">&laquo; Sebelumnya</button>
              <span id="pageInfo"></span>
              <button id="nextPageBtn" onclick="changePage(1)">Berikutnya &raquo;</button>
            </div>
          </div>

          <!-- Tombol kecil (form disembunyikan) -->
          <div class="card">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button style="background-color:#6c757d; width:auto;" onclick="toggleForm('memberFormContainer')">+ Daftarkan Member Baru</button>
              <button style="background-color:#6c757d; width:auto;" onclick="toggleForm('manualItemFormContainer')">+ Tambah Item Manual</button>
              <button style="background-color:#6c757d; width:auto;" onclick="toggleForm('diskonFormContainer')">Gunakan Diskon Member</button>
            </div>

            <div id="memberFormContainer" class="hidden" style="margin-top: 15px;">
              <h3>Form Member Baru</h3>
              <input type="text" id="newMemberName" placeholder="Nama Member Baru">
              <input type="number" id="newMemberHp" placeholder="Nomor HP Member Baru">
              <button onclick="daftarkanMemberBaru(this)">+ Daftarkan</button>
            </div>

            <div id="manualItemFormContainer" class="hidden" style="margin-top: 15px;">
              <h3>Form Item Manual</h3>
              <input type="text" id="manualItemName" placeholder="Nama Item (cth: Biaya Antar)">
              <input type="number" id="manualItemPrice" placeholder="Harga">
              <button onclick="tambahItemManual()">+ Tambah</button>
            </div>

            <div id="diskonFormContainer" class="hidden" style="margin-top: 15px;">
              <input type="text" id="memberId" placeholder="ID Member (No. HP)">
              <button id="btnTerapkanDiskon" onclick="terapkanDiskon(this)">Terapkan Diskon</button>
            </div>
          </div>

          <div class="card" id="keranjangCard">
            <h3>Keranjang Belanja</h3>
            <div id="cartItems">Tidak ada item.</div>

            <div class="total-section">
              <div id="subtotalLine"><span>Subtotal:</span> <span id="subtotalHarga">Rp 0</span></div>
              <div id="diskonLine" class="hidden"><span>Penghematan Member:</span> <span id="nilaiDiskon" class="discount-applied">Rp 0</span></div>
              <hr>
              <div><span>Total:</span> <span id="totalHarga">Rp 0</span></div>
            </div>
            <button id="btnSelesaikanTransaksi" class="hidden" onclick="tampilkanPembayaran()">Lanjut ke Pembayaran</button>
          </div>

          <div class="card hidden" id="paymentCard">
            <h3>Detail Pembayaran</h3>
            <h4>Total Tagihan: <span id="paymentTotalTagihan">Rp 0</span></h4>
            <div class="payment-options">
              <label><input type="radio" name="metodePembayaran" value="Tunai" onchange="togglePaymentDetails()" checked> Tunai</label>
              <label><input type="radio" name="metodePembayaran" value="Non-Tunai" onchange="togglePaymentDetails()"> Non-Tunai</label>
            </div>
            <div id="tunaiDetails">
              <input type="number" id="uangDiterima" placeholder="Uang Diterima (Rp)" oninput="hitungKembalian()">
              <p>Kembalian: <strong id="kembalian">Rp 0</strong></p>
            </div>
            <div id="nonTunaiDetails" class="hidden">
              <select id="jenisNonTunai">
                <option value="QRIS">QRIS</option>
                <option value="Shopee">Shopee</option>
                <option value="Tokopedia">Tokopedia</option>
                <option value="Transfer">Transfer</option>
              </select>
            </div>
            <button id="btnKonfirmasiPembayaran" onclick="selesaikanTransaksi(this)">Konfirmasi & Simpan</button>
            <button style="background-color: #6c757d;" onclick="batalPembayaran()">Kembali ke Keranjang</button>
          </div>

          <div class="card hidden" id="postTransactionCard">
            <h4>Transaksi Berhasil!</h4>
            <p style="text-align:center; color:#555; font-size: 14px;">Silakan cetak struk atau kembali ke kasir.</p>
            <button id="btnCetakStruk" onclick="cetakStruk()">Cetak Struk</button>
            <button style="background-color:#6c757d;" onclick="kembaliKeHalamanAwal()">Kembali ke Kasir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LAPORAN -->
    <div class="container hidden" id="laporanPage">
      <div class="card">
        <h3 id="laporanTitle">Laporan Penjualan Hari Ini</h3>
        <p><small>(Data diperbarui setiap ada transaksi baru)</small></p>

        <div id="reportLoader">Memuat laporan...</div>
        <div id="reportContent" class="hidden"></div>

        <!-- Detail per cabang + tombol hapus di setiap baris -->
        <div id="detailDropdownContainer"></div>
      </div>
    </div>
  </div>

  <div id="strukArea"></div>

  <script>
    /* ============== KONFIG BACKEND ============== */
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

    async function getData(action, payload = {}) {
      const url = new URL(SCRIPT_URL);
      url.searchParams.set('action', action);
      if (payload && Object.keys(payload).length) url.searchParams.set('payload', JSON.stringify(payload));
      const res = await fetch(url.toString(), { method: 'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }
    async function postData(action, payload = {}) { return getData(action, payload); }

    /* ============== STATE & UTIL ============== */
    var semuaProduk = [], keranjang = [], currentUser = null;
    var currentPage = 1, itemsPerPage = 6, isMemberActive = false, lastTransactionData = {};
    function isAdmin(){ return currentUser && (currentUser.role||'').toLowerCase()==='admin'; }

    function toggleTheme(){ document.body.classList.toggle('dark-mode'); document.getElementById('theme-toggle').textContent = document.body.classList.contains('dark-mode') ? 'üåô':'‚òÄÔ∏è'; }
    function toggleForm(id){ document.getElementById(id).classList.toggle('hidden'); }
    function toggleNegoForm(i,show){ document.getElementById('nego-btn-'+i).classList.toggle('hidden',show); document.getElementById('price-control-'+i).classList.toggle('hidden',!show); }

    window.onload=function(){
      const savedUser = localStorage.getItem('currentUser'); if (savedUser) setupApp(JSON.parse(savedUser));
      const savedTheme = localStorage.getItem('theme'); if (savedTheme==='dark') document.body.classList.add('dark-mode');
      document.getElementById('theme-toggle').textContent = document.body.classList.contains('dark-mode')?'üåô':'‚òÄÔ∏è';
    };

    /* ============== AUTH ============== */
    async function login(){
      const email=document.getElementById('emailInput').value;
      if(!email){alert('Email tidak boleh kosong.');return;}
      try{ const res=await getData('cekLogin',{email}); hasilLogin(res); }catch(e){ alert('Gagal terhubung ke server.'); }
    }
    function logout(){ if(confirm('Yakin logout?')){ localStorage.removeItem('currentUser'); location.reload(); } }
    function setupApp(user){
      currentUser=user;
      const roleLabel=(user.role||'').toString().trim();
      document.getElementById('userInfo').innerHTML='<span>'+roleLabel+': '+user.email+' | Cabang: '+user.cabang+'</span> <a href="#" onclick="logout();return false;">Logout</a>';
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      muatProduk();
    }
    function hasilLogin(res){ if(res && res.success){ localStorage.setItem('currentUser',JSON.stringify(res.user)); setupApp(res.user); } else { alert((res && res.message)||'Login gagal.'); } }

    /* ============== PRODUK ============== */
    async function muatProduk(){ try{ const data=await getData('getProduk'); tampilkanProduk(data); }catch(e){ alert('Gagal memuat produk.'); } }
    function tampilkanProduk(data){
      if(!Array.isArray(data)){ document.getElementById('loader').textContent='Error data produk.'; return; }
      semuaProduk=data; const grid=document.getElementById('produkList'); const sel=document.getElementById('categorySelect');
      grid.innerHTML=''; sel.innerHTML='';
      const categories=['Semua', ...Array.from(new Set(data.map(p=>p['Jenis']).filter(Boolean)))];
      categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      data.forEach((p,i)=>{
        if(!p || !p['Nama Produk']) return;
        const card=document.createElement('div'); card.className='product-card'; card.dataset.jenis=p['Jenis']||''; card.dataset.index=i; card.style.display='none';
        const jual=+p['Harga Jual']||0, member=+p['Harga Member']||0, modal=+p['Harga Modal']||0, supplier=p['Supplier']||'-';
        card.innerHTML =
          `<img src="${p['Foto URL']||'https://placehold.co/100x100/e2e8f0/e2e8f0?text=x'}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/e2e8f0?text=x';">
           <p>${p['Nama Produk']} (${p['Ukuran/Variasi']||''})</p>
           <p><strong>Rp ${jual.toLocaleString()}</strong></p>
           <div class="product-admin-info hidden">
             <small>Modal: Rp ${modal.toLocaleString()}<br><strong>Member: Rp ${member.toLocaleString()}</strong><br>Supplier: ${supplier}</small>
           </div>
           <button class="btn-small" onclick="tambahKeKeranjang(${i})">+ Keranjang</button>`;
        grid.appendChild(card);
      });
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      updateProductView();
    }
    function tambahKeKeranjang(i){
      const p=semuaProduk[i]; const ada=keranjang.find(it=>it.produk['ID Produk']===p['ID Produk'] && it.produk['Ukuran/Variasi']===p['Ukuran/Variasi']);
      const jual=+p['Harga Jual']||0, member=+p['Harga Member']||0; const harga=(isMemberActive && member>0 && member<jual)?member:jual;
      if(ada) ada.qty++; else keranjang.push({produk:p, qty:1, hargaSaatIni:harga}); updateKeranjang();
    }
    function ubahJumlah(i,delta){ const it=keranjang[i]; if(!it) return; it.qty+=delta; if(it.qty<=0) keranjang.splice(i,1); updateKeranjang(); }
    function setJumlah(el,i){ const n=+el.value; if(!n || n<=0) keranjang.splice(i,1); else keranjang[i].qty=n; updateKeranjang();}
    function ubahHarga(el,i){ const n=+el.value; const it=keranjang[i]; if(!it) return; it.hargaSaatIni = (isNaN(n)||n<0)?(+it.produk['Harga Jual']||0):n; updateKeranjang(); }
    function updateKeranjang(){
      const box=document.getElementById('cartItems');
      if(!keranjang.length){ box.textContent='Tidak ada item.'; document.getElementById('btnSelesaikanTransaksi').classList.add('hidden'); }
      else{
        box.innerHTML=''; keranjang.forEach((it,i)=>{
          const total=it.qty*it.hargaSaatIni;
          const row=`<div class="cart-item">
            <div class="cart-item-details">
              <div class="cart-item-info">${it.produk['Nama Produk']} (${it.produk['Ukuran/Variasi']||''})<br><strong>${it.qty} x ${it.hargaSaatIni.toLocaleString()} = Rp ${total.toLocaleString()}</strong></div>
              <button class="btn-remove" onclick="hapusItem(${i})">&times;</button>
            </div>
            <div class="cart-controls">
              <div class="quantity-controls">
                <button onclick="ubahJumlah(${i},-1)">-</button>
                <input type="number" value="${it.qty}" onchange="setJumlah(this,${i})">
                <button onclick="ubahJumlah(${i},1)">+</button>
              </div>
              <button id="nego-btn-${i}" class="btn-small" style="background:#ffc107;color:#333;" onclick="toggleNegoForm(${i},true)">Nego</button>
              <div id="price-control-${i}" class="price-control hidden">
                <span>Rp</span>
                <input type="number" value="${it.hargaSaatIni}" onchange="ubahHarga(this,${i})">
                <button class="btn-small" style="background:#28a745;" onclick="toggleNegoForm(${i},false)">OK</button>
              </div>
            </div>
          </div>`;
          box.insertAdjacentHTML('beforeend',row);
        });
        document.getElementById('btnSelesaikanTransaksi').classList.remove('hidden');
      }
      kalkulasiTotal();
    }
    function hapusItem(i){ keranjang.splice(i,1); updateKeranjang(); }
    function kalkulasiTotal(){
      let sub=0, subNormal=0;
      keranjang.forEach(it=>{ const jual=+it.produk['Harga Jual']||0; sub+=it.qty*it.hargaSaatIni; subNormal+=it.qty*jual; });
      document.getElementById('subtotalHarga').textContent='Rp '+subNormal.toLocaleString();
      document.getElementById('subtotalLine').classList.toggle('hidden',!keranjang.length);
      const hemat=subNormal-sub;
      if(hemat>0){ document.getElementById('diskonLine').classList.remove('hidden'); document.getElementById('nilaiDiskon').textContent='- Rp '+hemat.toLocaleString(); }
      else document.getElementById('diskonLine').classList.add('hidden');
      document.getElementById('totalHarga').textContent='Rp '+sub.toLocaleString();
      return { totalAkhir: sub, totalHemat: hemat };
    }

    /* ============== MEMBER & DISKON ============== */
    async function terapkanDiskon(btn){
      const nomorHp=document.getElementById('memberId').value;
      if(!nomorHp){ alert('Masukkan nomor HP member.'); return; }
      btn.disabled=true; btn.textContent='Mengecek...';
      try{
        const res=await getData('cekMember',{ nomorHp });
        if(res.success){ alert('Harga member untuk '+res.nama+' diterapkan.'); isMemberActive=true; btn.textContent='Harga Member Aktif'; btn.classList.add('disabled'); }
        else{ alert(res.message); isMemberActive=false; btn.disabled=false; btn.textContent='Terapkan Diskon'; }
        updateKeranjang();
      }catch(e){ alert('Gagal cek member.'); btn.disabled=false; btn.textContent='Terapkan Diskon'; }
    }
    async function daftarkanMemberBaru(btn){
      const nama=document.getElementById('newMemberName').value;
      const nomorHp=document.getElementById('newMemberHp').value;
      if(!nama||!nomorHp){ alert('Nama & Nomor HP wajib.'); return; }
      btn.disabled=true; btn.textContent='Mendaftarkan...';
      try{
        const res=await postData('tambahMemberBaru',{ nama, nomorHp });
        alert(res.message||'Berhasil.'); btn.disabled=false; btn.textContent='+ Daftarkan';
        if(res.success){ document.getElementById('newMemberName').value=''; document.getElementById('newMemberHp').value=''; toggleForm('memberFormContainer'); }
      }catch(e){ alert('Gagal mendaftar.'); btn.disabled=false; btn.textContent='+ Daftarkan'; }
    }

    /* ============== TRANSAKSI ============== */
    function tampilkanPembayaran(){ if(!keranjang.length){ alert('Keranjang kosong.'); return; } const t=kalkulasiTotal(); document.getElementById('paymentTotalTagihan').textContent='Rp '+t.totalAkhir.toLocaleString(); document.getElementById('keranjangCard').classList.add('hidden'); document.getElementById('paymentCard').classList.remove('hidden'); hitungKembalian(); }
    function batalPembayaran(){ document.getElementById('paymentCard').classList.add('hidden'); document.getElementById('keranjangCard').classList.remove('hidden'); }
    function togglePaymentDetails(){ const m=document.querySelector('input[name="metodePembayaran"]:checked').value; document.getElementById('tunaiDetails').classList.toggle('hidden',m!=='Tunai'); document.getElementById('nonTunaiDetails').classList.toggle('hidden',m==='Tunai'); }
    function hitungKembalian(){ const t=kalkulasiTotal(); const u=+document.getElementById('uangDiterima').value||0; const k=u-t.totalAkhir; document.getElementById('kembalian').textContent='Rp '+(k>=0?k.toLocaleString():0); }

    async function selesaikanTransaksi(btn){
      const metode=document.querySelector('input[name="metodePembayaran"]:checked').value;
      const detail=(metode==='Non-Tunai')?document.getElementById('jenisNonTunai').value:'';
      const t=kalkulasiTotal();
      const dataTransaksi={ items:keranjang.map(it=>({produk:it.produk,qty:it.qty,hargaAkhirSatuan:it.hargaSaatIni})), memberId:document.getElementById('memberId').value, metodePembayaran:metode, detailMetode:detail, diskonJumlah:t.totalHemat, totalAkhir:t.totalAkhir, timestamp:new Date().toISOString(), cabang:currentUser.cabang };
      lastTransactionData=dataTransaksi; btn.disabled=true; btn.textContent='Menyimpan...';
      try{ const r=await postData('simpanTransaksi',dataTransaksi); onTransaksiSuccess(r); }catch(e){ onTransaksiFailure({message:e.message}); }
    }
    function onTransaksiSuccess(r){
      const btn=document.getElementById('btnKonfirmasiPembayaran');
      if(r==="Sukses"||(r&&r.success)){ document.getElementById('paymentCard').classList.add('hidden'); document.getElementById('postTransactionCard').classList.remove('hidden'); generateStruk(); }
      else alert('Gagal menyimpan: '+(r&&r.message?r.message:r));
      btn.disabled=false; btn.textContent='Konfirmasi & Simpan';
    }
    function onTransaksiFailure(e){ alert('Kesalahan menyimpan: '+(e&&e.message?e.message:'Unknown')); const btn=document.getElementById('btnKonfirmasiPembayaran'); btn.disabled=false; btn.textContent='Konfirmasi & Simpan'; }
    function kembaliKeHalamanAwal(){ document.getElementById('postTransactionCard').classList.add('hidden'); document.getElementById('keranjangCard').classList.remove('hidden'); resetKeranjang(); filterByCategory('Semua'); }
    function resetKeranjang(){ keranjang=[]; isMemberActive=false; lastTransactionData={}; document.getElementById('memberId').value=''; const b=document.getElementById('btnTerapkanDiskon'); b.textContent='Terapkan Diskon'; b.disabled=false; b.classList.remove('disabled'); updateKeranjang(); }
    function generateStruk(){
      const el=document.getElementById('strukArea'); const t=kalkulasiTotal(); const now=new Date(); const date=now.toLocaleDateString('id-ID'); const time=now.toLocaleTimeString('id-ID');
      let items=''; (lastTransactionData.items||[]).forEach(it=>{ items+=`<tr><td colspan="3">${it.produk['Nama Produk']}</td></tr><tr><td>${it.qty}x</td><td style="text-align:right;">${it.hargaAkhirSatuan.toLocaleString()}</td><td style="text-align:right;">${(it.qty*it.hargaAkhirSatuan).toLocaleString()}</td></tr>`; });
      el.innerHTML=`<h3>Toko Tanaman</h3><p>Cabang: ${currentUser.cabang}</p><p>Kasir: ${currentUser.email}</p><p>Tanggal: ${date} ${time}</p><hr><table>${items}</table><hr><table><tr class="total-line"><td colspan="2">Subtotal</td><td style="text-align:right;">${(t.totalAkhir+t.totalHemat).toLocaleString()}</td></tr>${t.totalHemat>0?`<tr><td colspan="2">Diskon</td><td style="text-align:right;">-${t.totalHemat.toLocaleString()}</td></tr>`:''}<tr class="total-line"><td colspan="2"><strong>TOTAL</strong></td><td style="text-align:right;"><strong>${t.totalAkhir.toLocaleString()}</strong></td></tr></table><p class="footer">Terima kasih!</p>`;
    }
    function cetakStruk(){ window.print(); }

    /* ============== NAV & FILTER ============== */
    function tampilkanHalaman(h){ const pos=document.getElementById('posPage'), lap=document.getElementById('laporanPage'); const nk=document.getElementById('navKasir'), nl=document.getElementById('navLaporan'); if(h==='laporan'){ pos.classList.add('hidden'); lap.classList.remove('hidden'); nk.classList.remove('active'); nl.classList.add('active'); muatLaporan(); } else { lap.classList.add('hidden'); pos.classList.remove('hidden'); nl.classList.remove('active'); nk.classList.add('active'); } }
    function filterByCategory(j){ document.getElementById('categorySelect').value=j; currentPage=1; updateProductView(); }
    function updateProductView(){ const cat=document.getElementById('categorySelect').value; const q=document.getElementById('searchInput').value.toLowerCase(); const cards=[...document.querySelectorAll('.product-card')]; const filtered=cards.filter(c=> (cat==='Semua'||c.dataset.jenis===cat) && c.innerText.toLowerCase().includes(q)); cards.forEach(c=>c.style.display='none'); const total=Math.ceil(filtered.length/itemsPerPage); const start=(currentPage-1)*itemsPerPage; filtered.slice(start,start+itemsPerPage).forEach(c=>c.style.display='block'); updatePaginationControls(total); }
    function updatePaginationControls(t){ const box=document.getElementById('paginationControls'); const prev=document.getElementById('prevPageBtn'); const next=document.getElementById('nextPageBtn'); const info=document.getElementById('pageInfo'); if(t>1){ box.classList.remove('hidden'); info.textContent='Halaman '+currentPage+' dari '+t; prev.disabled=(currentPage===1); next.disabled=(currentPage===t); } else box.classList.add('hidden'); }
    function changePage(d){ currentPage+=d; updateProductView(); }

    /* ============== LAPORAN + HAPUS ITEM ============== */
    async function muatLaporan(){
      if(!currentUser) return;
      document.getElementById('reportLoader').classList.remove('hidden');
      document.getElementById('reportContent').classList.add('hidden');
      document.getElementById('detailDropdownContainer').innerHTML='';

      try{
        const [harian, detail] = await Promise.all([
          getData('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang }),
          getData('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang })
        ]);
        tampilkanDataLaporan(harian);
        tampilkanDetailLaporan(detail);
      }catch(e){ document.getElementById('reportLoader').textContent='Gagal memuat laporan: '+e; }
    }

    function tampilkanDataLaporan(data){
      const box=document.getElementById('reportContent'); box.innerHTML=''; let grandTotal=0, grandTrans=0;
      (data.reports||[]).forEach(r=>{
        box.insertAdjacentHTML('beforeend',
          `<div class="report-card">
            <h4>Laporan Cabang: ${r.cabang}</h4>
            <div class="report-grid">
              <div><h4>Total Penjualan</h4><p>Rp ${(r.totalPenjualan||0).toLocaleString()}</p></div>
              <div><h4>Jumlah Transaksi</h4><p>${(r.jumlahTransaksi||0)}</p></div>
              <div><h4>Penjualan Tunai</h4><p>Rp ${(r.totalTunai||0).toLocaleString()}</p></div>
              <div><h4>Penjualan Non-Tunai</h4><p>Rp ${(r.totalNonTunai||0).toLocaleString()}</p></div>
            </div>
          </div>`);
        grandTotal+=(r.totalPenjualan||0); grandTrans+=(r.jumlahTransaksi||0);
      });
      if(isAdmin() && (data.reports||[]).length>1){
        document.getElementById('laporanTitle').textContent='Laporan Gabungan Semua Cabang';
        box.insertAdjacentHTML('beforeend',
          `<div class="report-card" style="background:#e9ecef;">
             <h3>Total Keseluruhan (Semua Cabang)</h3>
             <h4>Total Pemasukan: Rp ${grandTotal.toLocaleString()}</h4>
             <h4>Total Transaksi: ${grandTrans}</h4>
           </div>`);
      } else {
        document.getElementById('laporanTitle').textContent='Laporan Penjualan Hari Ini ('+currentUser.cabang+')';
      }
      document.getElementById('reportLoader').classList.add('hidden');
      box.classList.remove('hidden');
    }

    function tableRows(items){
      const withAction=isAdmin();
      let head=`<tr><th>Waktu</th><th>Produk</th><th>Qty</th><th>Harga Satuan</th><th>Total</th>${withAction?'<th>Aksi</th>':''}</tr>`;
      let body='';
      (items||[]).forEach(row=>{
        body+=`<tr>
          <td>${row.timestamp}</td>
          <td>${row.produk} ${row.variasi?('('+row.variasi+')'):''}</td>
          <td>${row.qty}</td>
          <td>${Number(row.hargaSatuan||0).toLocaleString()}</td>
          <td>${Number(row.total||0).toLocaleString()}</td>
          ${withAction?`<td><button style="background:#dc3545" onclick="hapusItemTransaksi(${row.row})">X</button></td>`:''}
        </tr>`;
      });
      return `<div style="overflow-x:auto;"><table class="report-detail-table"><thead>${head}</thead><tbody>${body}</tbody></table></div>`;
    }

    function tampilkanDetailLaporan(data){
      const wrap=document.getElementById('detailDropdownContainer'); wrap.innerHTML='';
      if(isAdmin() && data.groupedTransactions){
        const keys=Object.keys(data.groupedTransactions);
        if(!keys.length){ wrap.innerHTML='<p>Belum ada detail transaksi hari ini.</p>'; return; }
        keys.forEach(cbg=>{
          const det=document.createElement('details');
          det.innerHTML=`<summary>Lihat Detail Item Terjual - Cabang ${cbg}</summary>${tableRows(data.groupedTransactions[cbg])}`;
          wrap.appendChild(det);
        });
      } else if(!isAdmin() && data.transactions){
        const det=document.createElement('details');
        det.innerHTML=`<summary>Lihat Detail Item Terjual Hari Ini</summary>${tableRows(data.transactions)}`;
        wrap.appendChild(det);
      } else {
        wrap.innerHTML='<p>Belum ada detail transaksi hari ini.</p>';
      }
    }

    async function hapusItemTransaksi(row){
      if(!isAdmin()){ alert('Hanya Admin yang bisa menghapus baris transaksi.'); return; }
      if(!confirm('Hapus baris transaksi ini?')) return;
      try{
        const res=await postData('hapusItem',{ row, userRole: currentUser.role });
        if(res && res.success){ alert('Item dihapus.'); muatLaporan(); }
        else alert((res && res.message)||'Gagal menghapus.');
      }catch(e){ alert('Gagal: '+e.message); }
    }
  </script>
</body>
</html>
