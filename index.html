<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kasir POS Tanaman</title>
<style>
  :root{
    --bg:#f7f7f9; --card:#ffffff; --text:#222; --muted:#666;
    --primary:#c62828; --primary-700:#ad2121; --accent:#2e7d32; --info:#1565c0;
    --border:#e6e6ea; --pill:#f1f1f5; --shadow:0 6px 20px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#111317; --card:#171a21; --text:#e9e9ee; --muted:#aeb3bd;
    --primary:#ef5350; --primary-700:#e53935; --accent:#66bb6a; --info:#42a5f5;
    --border:#252a33; --pill:#20242c; --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.4 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .container{max-width:1060px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .pill{background:var(--pill);border:1px solid var(--border);padding:8px 12px;border-radius:999px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
  .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-700)}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-info{background:var(--info);color:#fff}
  .btn-ghost{background:var(--pill);color:var(--text);border:1px solid var(--border);box-shadow:none}
  .muted{color:var(--muted)}
  header{margin-bottom:10px}
  header .tabs{display:flex;gap:12px}
  .tab{flex:1;text-align:center;background:var(--pill);border:1px solid var(--border);padding:12px;border-radius:14px;font-weight:700}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .card .h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
  .card .c{padding:14px 16px}
  .grid{
    display:grid; gap:14px;
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
  @media(min-width:900px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)); } }

  /* Product card */
  .p-item{overflow:hidden;display:flex;flex-direction:column}
  .p-img{aspect-ratio:1/1;border-bottom:1px solid var(--border);background:#00010}
  .p-img img{width:100%;height:100%;object-fit:cover;display:block}
  .p-body{padding:12px 12px 14px}
  .p-name{font-weight:700;margin:0 0 6px}
  .p-var{font-size:12px;color:var(--muted);margin-bottom:8px}
  .p-price{font-weight:800;margin:4px 0 8px}
  .p-meta{background:var(--pill);border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin:8px 0 10px}
  .p-actions{margin-top:auto;display:flex;gap:8px}

  /* Search & nav */
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .filters .search{flex:1}
  .search input, select, .select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text)}
  .nav-pages{display:flex;gap:10px;align-items:center;margin:12px 0 10px}
  .badge{font-weight:800}

  /* Checkout panel */
  .checkout{position:sticky;bottom:10px}
  .pay-card{padding:14px}
  .cart-list{display:flex;flex-direction:column;gap:8px}
  /* Compact cart row (maks 2-3 baris total tinggi) */
  .cart-row{
    display:grid;grid-template-columns:auto auto 1fr auto;align-items:center;
    gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card)
  }
  .cart-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
  .cart-sub{font-size:12px;color:var(--muted)}
  .qty-wrap{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .qty-wrap button{border:0;background:var(--pill);padding:6px 10px;cursor:pointer}
  .qty-wrap input{width:34px;border:0;text-align:center;background:var(--card);color:var(--text);font-weight:700}
  .cart-total{font-weight:800}
  .cart-ctrl{display:flex;align-items:center;gap:8px}
  .cart-del{border:0;background:#fef0f0;color:#cc3636;border:1px solid #f5cccc;border-radius:8px;padding:6px 8px;cursor:pointer}
  .nego-btn{border:1px dashed var(--border);background:var(--pill);padding:4px 8px;border-radius:8px;cursor:pointer;font-size:12px}
  .price-control.hidden{display:none !important}

  .pay-footer{display:flex;gap:10px;flex-wrap:wrap;padding-top:8px;border-top:1px dashed var(--border);margin-top:10px}
  .pay-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .radio{display:flex;gap:8px;align-items:center}
  .strong{font-weight:800}
  .right{margin-left:auto}
  .success{color:var(--accent);font-weight:800}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:30}
  .modal.show{display:grid}
  .modal .box{width:min(420px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .box .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
  .box .bd{padding:16px}
  .box .ft{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
  .box input,.box select,.box textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text)}
  .box label{display:block;margin:10px 0 6px}

  /* Report table (kept minimal) */
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--border)}
  th{text-align:left}
  .t-right{text-align:right}
</style>
</head>
<body data-theme="light">
  <div class="container">

    <!-- HEADER -->
    <header class="row">
      <div id="userBadge" class="pill">Kasir: - | Cabang: -</div>
      <div class="spacer"></div>
      <button id="themeBtn" class="btn btn-ghost">ðŸŒ™ Mode</button>
      <a id="logoutBtn" class="btn btn-ghost">Logout</a>
      <div style="flex-basis:100%"></div>
      <div class="tabs" style="width:100%">
        <div id="tabKasir" class="tab active">Kasir</div>
        <div id="tabLaporan" class="tab">Laporan</div>
      </div>
    </header>

    <!-- ---------- LOGIN PAGE ---------- -->
    <div id="loginPage" class="card">
      <div class="h">Login Kasir/Admin</div>
      <div class="c">
        <div class="row">
          <input id="emailInput" class="search" placeholder="Email (contoh: kasir@tokotanaman.com)" />
          <button id="loginBtn" class="btn btn-primary">Masuk</button>
        </div>
      </div>
    </div>

    <!-- ---------- APP PAGE ---------- -->
    <div id="appContainer" class="hidden">

      <!-- Action bar (+Member, +Item, Diskon, Info Modal, Tema) -->
      <div class="row" style="margin:12px 0">
        <button id="btnAddMember" class="btn btn-primary">+ Member</button>
        <button id="btnItemManual" class="btn btn-accent">+ Item</button>
        <button id="btnDiskon" class="btn btn-info">Diskon</button>
        <label class="pill"><input id="toggleInfoModal" type="checkbox" style="margin-right:8px"/>Tampilkan Info Modal</label>
        <div class="spacer"></div>
      </div>

      <!-- TABS -->
      <div id="kasirPage">
        <!-- Filter & search -->
        <div class="filters">
          <div class="search"><input id="searchInput" placeholder="Cari tanaman..." /></div>
        </div>

        <!-- PRODUCTS -->
        <div id="productGrid" class="grid"></div>

        <!-- Nav pages -->
        <div class="nav-pages">
          <button id="prevPageBtn" class="btn btn-ghost">Â« Sebelumnya</button>
          <div class="pill">Halaman <span id="pageInfo" class="badge">1</span></div>
          <button id="nextPageBtn" class="btn btn-ghost">Berikutnya Â»</button>
        </div>

        <!-- CHECKOUT -->
        <div class="checkout">
          <div class="card pay-card">
            <div class="h">Keranjang</div>
            <div class="c">
              <!-- STEP: review (list items) -->
              <div id="cartReview">
                <div id="cartList" class="cart-list"></div>
                <div class="pay-row" style="margin-top:6px">
                  <span class="muted">Item: <span id="cartCount" class="strong">0</span></span>
                  <span class="right">Total: <span id="cartGrand" class="strong">Rp 0</span></span>
                </div>
                <div class="pay-footer">
                  <button id="goPayBtn" class="btn btn-primary">Lanjut Pembayaran</button>
                </div>
              </div>

              <!-- STEP: pay (hide items, show metode) -->
              <div id="cartPay" style="display:none">
                <div class="pay-row">
                  <label class="radio"><input type="radio" name="paymethod" value="Tunai" checked> Tunai</label>
                  <label class="radio"><input type="radio" name="paymethod" value="Non-Tunai"> Non-Tunai</label>
                  <select id="nonTunaiDetail" class="select" style="display:none">
                    <option value="QRIS">QRIS</option>
                    <option value="Transfer">Transfer</option>
                    <option value="ShopeePay">ShopeePay</option>
                    <option value="GoPay">GoPay</option>
                  </select>
                </div>
                <div class="pay-row" style="margin-top:6px">
                  <span class="muted">Item: <span id="payCount" class="strong">0</span></span>
                  <span class="right">Total: <span id="payGrand" class="strong">Rp 0</span></span>
                </div>
                <div class="pay-footer">
                  <button id="backToReviewBtn" class="btn btn-ghost">KEMBALI</button>
                  <button id="confirmSaveBtn" class="btn btn-primary">KONFIRMASI & SIMPAN</button>
                </div>
              </div>

              <!-- STEP: saved (show print & finish) -->
              <div id="cartSaved" style="display:none">
                <div class="pay-row">
                  <div>Transaksi <span id="savedId" class="success">#-</span> tersimpan.</div>
                  <span class="right">Total: <span id="savedGrand" class="strong">Rp 0</span></span>
                </div>
                <div class="pay-footer">
                  <button id="printBtn" class="btn btn-info">CETAK STRUK</button>
                  <button id="finishBtn" class="btn btn-accent">SELESAI</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ---------- REPORTS ---------- -->
      <div id="laporanPage" class="hidden">
        <div class="card">
          <div class="h">Laporan Penjualan Hari Ini (<span id="lapTitleCabang">Semua</span>)</div>
          <div class="c" id="reportContent">
            Memuat...
          </div>
        </div>
      </div>

    </div><!--/app-->

    <!-- ======= MODALS ======= -->
    <!-- Add Member -->
    <div id="modalMember" class="modal"><div class="box">
      <div class="hd">Daftarkan Member Baru</div>
      <div class="bd">
        <label>Nomor HP</label><input id="m_hp" placeholder="0812xxxxxx" />
        <label>Nama</label><input id="m_nama" placeholder="Nama member" />
        <label>Catatan</label><input id="m_catatan" placeholder="(opsional)"/>
      </div>
      <div class="ft">
        <button class="btn btn-ghost" data-close>Batalkan</button>
        <button id="m_simpan" class="btn btn-primary">Simpan</button>
      </div>
    </div></div>

    <!-- Item Manual -->
    <div id="modalItem" class="modal"><div class="box">
      <div class="hd">Tambah Item Manual</div>
      <div class="bd">
        <label>Nama Item</label><input id="i_nama" placeholder="Contoh: Kurir (Custom)" />
        <label>Ukuran/Variasi</label><input id="i_var" placeholder="(opsional)"/>
        <label>Harga Satuan</label><input id="i_harga" type="number" inputmode="numeric" placeholder="15000" />
        <label>Qty</label><input id="i_qty" type="number" inputmode="numeric" value="1" />
      </div>
      <div class="ft">
        <button class="btn btn-ghost" data-close>Batalkan</button>
        <button id="i_tambah" class="btn btn-accent">Tambah</button>
      </div>
    </div></div>

    <!-- Diskon Member -->
    <div id="modalDiskon" class="modal"><div class="box">
      <div class="hd">Aktifkan Diskon Member</div>
      <div class="bd">
        <label>Nomor HP Member</label>
        <input id="d_hp" placeholder="0812xxxxxx" />
        <div class="muted" style="margin-top:6px">Cukup 1 tombol: jika terdaftar â†’ diskon aktif, jika tidak â†’ beri info & tutup.</div>
      </div>
      <div class="ft">
        <button class="btn btn-ghost" data-close>Tutup</button>
        <button id="d_terapkan" class="btn btn-primary">Terapkan Diskon</button>
      </div>
    </div></div>

  </div><!--/container-->

<script>
/* ==============================
   KONFIGURASI BACKEND (FETCH)
================================ */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

/* GET helper untuk semua panggilan (anti CORS preflight) */
async function getData(action, payload = {}) {
  const url = new URL(SCRIPT_URL);
  url.searchParams.set('action', action);
  if (payload && Object.keys(payload).length) {
    url.searchParams.set('payload', JSON.stringify(payload));
  }
  const res = await fetch(url.toString(), { method:'GET' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : res.text();
}

/* ==============================
   STATE & UTIL
================================ */
let semuaProduk = [];
let keranjang = [];
let currentUser = null;
let currentPage = 1, itemsPerPage = 8;
let isMemberActive = false;
let checkoutStep = 'review'; // 'review' | 'pay' | 'saved'
let savedTransaksi = null;
let showInfoModal = false;

const $ = sel => document.querySelector(sel);
const $all = sel => document.querySelectorAll(sel);
const fmt = n => "Rp " + (Math.round(+n)||0).toLocaleString('id-ID');

function saveSession() {
  localStorage.setItem('kasir_user', JSON.stringify(currentUser||null));
  localStorage.setItem('kasir_member', JSON.stringify({active:isMemberActive}));
  localStorage.setItem('kasir_theme', document.body.dataset.theme || 'light');
}
function loadSession() {
  try{
    const u = JSON.parse(localStorage.getItem('kasir_user')); if (u) currentUser = u;
    const m = JSON.parse(localStorage.getItem('kasir_member')); if (m) isMemberActive = !!m.active;
    const th = localStorage.getItem('kasir_theme'); if (th) document.body.dataset.theme = th;
  }catch(e){}
}

function normHP(s){
  let d = String(s||'').replace(/\D/g,''); // keep digits
  if (d.startsWith('0')) d = d.slice(1);
  return d;
}

function ensureLoginGate() {
  if (currentUser){
    $('#loginPage').style.display='none';
    $('#appContainer').classList.remove('hidden');
    $('#userBadge').textContent = `${currentUser.role}: ${currentUser.email} | Cabang: ${currentUser.cabang}`;
    $('#tabKasir').classList.add('active');
    $('#tabLaporan').classList.remove('active');
    $('#kasirPage').classList.remove('hidden');
    $('#laporanPage').classList.add('hidden');
    refreshProduk();
    renderCart();
    loadReport();
  }else{
    $('#loginPage').style.display='block';
    $('#appContainer').classList.add('hidden');
  }
}

/* ==============================
   LOGIN
================================ */
$('#loginBtn').onclick = async () => {
  const email = $('#emailInput').value.trim();
  if (!email) return alert('Tuliskan email.');
  try{
    const out = await getData('cekLogin', {email});
    if (!out.success) return alert(out.message||'Gagal login.');
    currentUser = out.user;
    saveSession();
    ensureLoginGate();
  }catch(e){ alert('Gagal terhubung ke server.'); }
};
$('#logoutBtn').onclick = () => {
  currentUser = null; keranjang = []; savedTransaksi=null; checkoutStep='review';
  saveSession(); ensureLoginGate();
};

/* ==============================
   THEME & TOGGLES
================================ */
$('#themeBtn').onclick = () => {
  const cur = document.body.dataset.theme || 'light';
  document.body.dataset.theme = (cur==='light'?'dark':'light');
  saveSession();
};
$('#toggleInfoModal').onchange = (e)=>{ showInfoModal = e.target.checked; renderProducts(); };

/* ==============================
   PRODUCTS
================================ */
async function refreshProduk(){
  try{
    const list = await getData('getProduk');
    semuaProduk = list || [];
    currentPage = 1;
    renderProducts();
  }catch(e){ alert('Gagal memuat produk'); }
}
function filteredProduk(){
  const q = $('#searchInput').value.trim().toLowerCase();
  let arr = semuaProduk;
  if (q){
    arr = arr.filter(p =>
      String(p['Nama Produk']||'').toLowerCase().includes(q) ||
      String(p['Ukuran/Variasi']||'').toLowerCase().includes(q) ||
      String(p['Jenis']||'').toLowerCase().includes(q)
    );
  }
  return arr;
}
function renderProducts(){
  const list = filteredProduk();
  const totalPages = Math.max(1, Math.ceil(list.length/itemsPerPage));
  currentPage = Math.min(currentPage, totalPages);
  const start = (currentPage-1)*itemsPerPage;
  const pageItems = list.slice(start, start+itemsPerPage);

  $('#productGrid').innerHTML = pageItems.map(p=>{
    const foto = p['Foto URL']||'';
    const nama = p['Nama Produk']||'';
    const varian = p['Ukuran/Variasi']||'';
    const harga = +p['Harga Jual']||0;
    const hargaMember = +p['Harga Member']||0;
    const modal = +p['Harga Modal']||0;
    const supp = p['Supplier']||'-';
    return `
      <div class="card p-item">
        <div class="p-img"><img src="${foto}" alt=""></div>
        <div class="p-body">
          <div class="p-name">${nama}</div>
          <div class="p-var">${varian}</div>
          <div class="p-price">${fmt(harga)}</div>
          ${showInfoModal ? `
            <div class="p-meta">
              <div>Modal: <b>${fmt(modal)}</b></div>
              <div>Member: <b>${fmt(hargaMember||harga)}</b></div>
              <div class="muted">Supplier: ${supp}</div>
            </div>` : ``}
          <div class="p-actions">
            <button class="btn btn-accent" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&#39;")})'>+ Keranjang</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  $('#pageInfo').textContent = `${currentPage} dari ${totalPages}`;
  $('#prevPageBtn').disabled = currentPage<=1;
  $('#nextPageBtn').disabled = currentPage>=totalPages;
}
$('#prevPageBtn').onclick = ()=>{ currentPage=Math.max(1,currentPage-1); renderProducts(); }
$('#nextPageBtn').onclick = ()=>{ currentPage=Math.min(Math.ceil(filteredProduk().length/itemsPerPage), currentPage+1); renderProducts(); }
$('#searchInput').oninput = ()=>{ currentPage=1; renderProducts(); };

/* ==============================
   CART / CHECKOUT
================================ */
function addToCart(prod){
  const hargaJual = isMemberActive ? (+prod['Harga Member']||+prod['Harga Jual']||0) : (+prod['Harga Jual']||0);
  const item = {
    produk: prod,
    nama: prod['Nama Produk']||'',
    variasi: prod['Ukuran/Variasi']||'',
    harga: +hargaJual||0,
    qty: 1,
    manual:false,
  };
  keranjang.push(item);
  renderCart();
  scrollToCheckout();
}
function scrollToCheckout(){ document.querySelector('.checkout').scrollIntoView({behavior:'smooth',block:'nearest'}); }

/* Tambah item manual */
$('#btnItemManual').onclick = ()=> openModal('#modalItem');
$('#i_tambah').onclick = ()=>{
  const nama = $('#i_nama').value.trim();
  const varian = $('#i_var').value.trim();
  const harga = +$('#i_harga').value || 0;
  const qty = Math.max(1, +$('#i_qty').value||1);
  if (!nama || harga<=0) return alert('Nama & harga wajib diisi.');
  keranjang.push({
    produk: {'ID Produk': `MANUAL-${Date.now()}`, 'Nama Produk': nama, 'Ukuran/Variasi': varian},
    nama, variasi: varian, harga, qty, manual:true
  });
  closeModal('#modalItem'); clearItemManual();
  renderCart(); scrollToCheckout();
};
function clearItemManual(){ $('#i_nama').value=''; $('#i_var').value=''; $('#i_harga').value=''; $('#i_qty').value=1; }

/* Diskon member */
$('#btnDiskon').onclick = ()=> openModal('#modalDiskon');
$('#d_terapkan').onclick = async ()=>{
  const hp = normHP($('#d_hp').value);
  if (!hp) return alert('Nomor HP belum diisi.');
  try{
    const out = await getData('cekMember', { nomorHp: hp });
    if (out.success){
      isMemberActive = true; saveSession();
      alert('Diskon member diaktifkan.');
      closeModal('#modalDiskon');
      // refresh harga item di keranjang â†’ harga member
      keranjang = keranjang.map(it=>{
        if (it.manual) return it;
        const hargaMember = +it.produk['Harga Member']||0;
        return {...it, harga: hargaMember>0?hargaMember:+it.produk['Harga Jual']||0};
      });
      renderCart();
    }else{
      alert('Nomor tidak terdaftar/aktif.');
      closeModal('#modalDiskon');
    }
  }catch(e){ alert('Gagal memeriksa member.'); }
};

/* Tambah member */
$('#btnAddMember').onclick = ()=> openModal('#modalMember');
$('#m_simpan').onclick = async ()=>{
  const hp = $('#m_hp').value.trim();
  const nama = $('#m_nama').value.trim();
  const cat = $('#m_catatan').value.trim();
  if(!hp || !nama) return alert('HP & Nama wajib diisi.');
  try{
    const out = await getData('tambahMemberBaru', { nomorHp: hp, nama, catatan: cat });
    if (out.success){ alert('Member ditambahkan.'); closeModal('#modalMember'); }
    else alert(out.message||'Gagal menyimpan.');
  }catch(e){ alert('Gagal ke server.'); }
};

/* Render cart (ringkas) */
function renderCart(){
  // langkah/step
  showStep(checkoutStep);

  // isi daftar item (saat review)
  const list = $('#cartList');
  list.innerHTML = keranjang.map((it,idx)=>{
    const total = it.harga*it.qty;
    return `
      <div class="cart-row">
        <div>
          <div class="cart-title">${it.nama}</div>
          <div class="cart-sub">${it.variasi||''}</div>
        </div>
        <div class="cart-ctrl">
          <span class="nego-btn price-control hidden" data-idx="${idx}">Nego</span>
          <!-- tombol nego bisa kamu aktifkan dengan menghapus class 'hidden' pada runtime jika perlu -->
        </div>
        <div class="cart-ctrl">
          <div class="qty-wrap">
            <button onclick="editQty(${idx},-1)">âˆ’</button>
            <input value="${it.qty}" readonly />
            <button onclick="editQty(${idx},+1)">+</button>
          </div>
        </div>
        <div style="text-align:right">
          <div class="cart-total">${fmt(total)}</div>
          <button class="cart-del" onclick="hapusItem(${idx})">âœ•</button>
        </div>
      </div>
    `;
  }).join('');

  // ringkasan
  const count = keranjang.reduce((a,b)=>a+b.qty,0);
  const grand = keranjang.reduce((a,b)=>a+(b.qty*b.harga),0);
  $('#cartCount').textContent = count;
  $('#cartGrand').textContent = fmt(grand);
  $('#payCount').textContent = count;
  $('#payGrand').textContent = fmt(grand);
}
function editQty(i, delta){
  keranjang[i].qty = Math.max(1, (keranjang[i].qty||1)+delta);
  renderCart();
}
function hapusItem(i){ keranjang.splice(i,1); renderCart(); }

/* Step controller */
function showStep(step){
  checkoutStep = step;
  $('#cartReview').style.display = (step==='review')?'block':'none';
  $('#cartPay').style.display = (step==='pay')?'block':'none';
  $('#cartSaved').style.display = (step==='saved')?'block':'none';
}

/* Flow tombol checkout */
$('#goPayBtn').onclick = ()=>{
  if (keranjang.length===0) return alert('Keranjang kosong.');
  showStep('pay');
};
$('#backToReviewBtn').onclick = ()=> showStep('review');

$('input[name="paymethod"]').forEach?.(r=>r.onchange=toggleNonTunai);
$all('input[name="paymethod"]').forEach(r=> r.onchange = toggleNonTunai);
function toggleNonTunai(){
  const v = [...$all('input[name="paymethod"]')].find(r=>r.checked)?.value;
  $('#nonTunaiDetail').style.display = (v==='Non-Tunai')?'inline-block':'none';
}

/* SIMPAN TRANSAKSI â†’ kemudian tampil tombol CETAK & SELESAI */
$('#confirmSaveBtn').onclick = async ()=>{
  if (keranjang.length===0) return alert('Keranjang kosong.');
  const metode = [...$all('input[name="paymethod"]')].find(r=>r.checked)?.value || 'Tunai';
  const det = (metode==='Non-Tunai') ? $('#nonTunaiDetail').value : '';
  const payload = {
    cabang: currentUser?.cabang || 'Pusat',
    metodePembayaran: metode,
    detailMetode: det,
    memberId: isMemberActive ? 'member' : '',
    items: keranjang.map(it => ({
      produk: it.produk,
      qty: it.qty,
      hargaAkhirSatuan: it.harga
    }))
  };
  try{
    $('#confirmSaveBtn').disabled = true;
    const res = await getData('simpanTransaksi', payload);
    if (!res.success) throw new Error(res.message||'Gagal menyimpan');
    savedTransaksi = res;
    $('#savedId').textContent = res.id || '#-';
    $('#savedGrand').textContent = $('#payGrand').textContent;
    showStep('saved');
  }catch(e){
    alert('Terjadi kesalahan saat menyimpan transaksi.');
  }finally{
    $('#confirmSaveBtn').disabled = false;
  }
};

/* CETAK & SELESAI */
$('#printBtn').onclick = ()=> printStruk();
$('#finishBtn').onclick = ()=>{
  keranjang = []; savedTransaksi=null; isMemberActive=false;
  saveSession();
  showStep('review');
  renderCart();
  window.scrollTo({top:0,behavior:'smooth'});
};

/* Print 58mm sederhana */
function printStruk(){
  const tgl = new Date();
  let html = `
  <div style="font:12px monospace; width:240px">
    <div style="text-align:center; font-weight:700; margin-bottom:6px">STRUK PEMBELIAN</div>
    <div>${tgl.toLocaleString('id-ID')}</div>
    <div>ID: ${savedTransaksi?.id||'-'}</div>
    <hr/>
    ${keranjang.map(it=>`
      <div>${it.nama} ${it.variasi?`(${it.variasi})`:''}</div>
      <div>${fmt(it.harga)} x ${it.qty} = <b>${fmt(it.harga*it.qty)}</b></div>
    `).join('')}
    <hr/>
    <div style="text-align:right">Total: <b>${$('#savedGrand').textContent}</b></div>
    <div style="margin-top:8px;text-align:center">Terima kasih</div>
  </div>
  `;
  const w = window.open('', '_blank', 'width=320,height=600');
  w.document.write(`<html><body onload="window.print();window.close()">${html}</body></html>`);
  w.document.close();
}

/* ==============================
   REPORTS (ringkas + hapus item utk Admin)
================================ */
function badgeCabang(c){ return `<span class="pill">${c}</span>`; }

async function loadReport(){
  if (!currentUser) return;
  try{
    const [harian, detail] = await Promise.all([
      getData('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang }),
      getData('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang })
    ]);
    const cabangTitle = (currentUser.role==='Admin'?'Semua':currentUser.cabang);
    $('#lapTitleCabang').textContent = cabangTitle;

    let html = '';
    (harian.reports||[]).forEach(rep=>{
      html += `
        <div class="card" style="margin:10px 0">
          <div class="h">Laporan Cabang: ${rep.cabang}</div>
          <div class="c">
            <div class="row">
              <div>Total Penjualan: <b>${fmt(rep.totalPenjualan)}</b></div>
              <div class="spacer"></div>
              <div>Jumlah Transaksi: <b>${rep.jumlahTransaksi}</b></div>
            </div>
            <div class="row" style="margin-top:6px">
              <div>Tunai: <b>${fmt(rep.totalTunai)}</b></div>
              <div class="spacer"></div>
              <div>Non-Tunai: <b>${fmt(rep.totalNonTunai)}</b></div>
            </div>
          </div>
        </div>
      `;
    });

    // detail per cabang
    if (currentUser.role==='Admin' && detail.groupedTransactions){
      Object.keys(detail.groupedTransactions).forEach(cab=>{
        const rows = detail.groupedTransactions[cab];
        html += `<details style="margin:8px 0"><summary class="pill">Lihat Detail Item Terjual - Cabang ${cab}</summary>
          <div class="card" style="margin-top:8px"><div class="c">
          <table><thead><tr><th>Waktu</th><th>Produk</th><th class="t-right">Qty</th><th class="t-right">Harga</th><th class="t-right">Total</th><th></th></tr></thead><tbody>
          ${rows.map(r=>`
            <tr>
              <td>${r.timestamp}</td>
              <td>${r.produk}</td>
              <td class="t-right">${r.qty}</td>
              <td class="t-right">${fmt(r.hargaSatuan)}</td>
              <td class="t-right">${fmt(r.total)}</td>
              <td>${currentUser.role==='Admin'?`<button class="btn btn-ghost" onclick="hapusRow(${r.row})">Hapus</button>`:''}</td>
            </tr>
          `).join('')}
          </tbody></table></div></div></details>`;
      });
    }else if (detail.transactions){
      const rows = detail.transactions;
      html += `<details style="margin:8px 0"><summary class="pill">Lihat Detail Item Terjual</summary>
        <div class="card" style="margin-top:8px"><div class="c">
        <table><thead><tr><th>Waktu</th><th>Produk</th><th class="t-right">Qty</th><th class="t-right">Harga</th><th class="t-right">Total</th></tr></thead><tbody>
        ${rows.map(r=>`
          <tr>
            <td>${r.timestamp}</td>
            <td>${r.produk}</td>
            <td class="t-right">${r.qty}</td>
            <td class="t-right">${fmt(r.hargaSatuan)}</td>
            <td class="t-right">${fmt(r.total)}</td>
          </tr>
        `).join('')}
        </tbody></table></div></div></details>`;
    }

    $('#reportContent').innerHTML = html || '<div class="muted">Tidak ada data.</div>';
  }catch(e){
    $('#reportContent').textContent = 'Gagal memuat laporan.';
  }
}
async function hapusRow(row){
  if (!confirm('Yakin hapus baris transaksi ini?')) return;
  try{
    const res = await getData('hapusItem', { row, userRole: currentUser.role });
    if (res.success){ alert('Dihapus.'); loadReport(); }
    else alert(res.message||'Gagal menghapus.');
  }catch(e){ alert('Gagal ke server.'); }
}

/* ==============================
   TABS
================================ */
$('#tabKasir').onclick = ()=>{ $('#tabKasir').classList.add('active'); $('#tabLaporan').classList.remove('active'); $('#kasirPage').classList.remove('hidden'); $('#laporanPage').classList.add('hidden'); };
$('#tabLaporan').onclick = ()=>{ $('#tabLaporan').classList.add('active'); $('#tabKasir').classList.remove('active'); $('#laporanPage').classList.remove('hidden'); $('#kasirPage').classList.add('hidden'); loadReport(); };

/* ==============================
   MODAL helpers
================================ */
function openModal(sel){ const m=$(sel); if(!m)return; m.classList.add('show'); }
function closeModal(sel){ const m=$(sel); if(!m)return; m.classList.remove('show'); }
$all('[data-close]').forEach(b=> b.onclick = e => e.target.closest('.modal').classList.remove('show'));

/* ==============================
   BOOT
================================ */
loadSession();
ensureLoginGate();
toggleNonTunai();
</script>
</body>
</html>
