<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kasir Toko Tanaman</title>

<style>
:root{
  --brand:#2e7d32;
  --brand-700:#1b5e20;
  --muted:#6b7280;
  --line:#e6e8ef;
  --bg:#f6f7fb;
  --card:#fff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{background:var(--bg);color:#222;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

.container{max-width:1000px;margin:14px auto;padding:0 12px}
.hidden{display:none!important}

.userbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
.userbar a{color:#c62828;font-weight:700;text-decoration:none}

.tabs{display:flex;gap:.75rem;margin-bottom:10px}
.tab{flex:1 1 auto;text-align:center;font-weight:700;background:#eceff4;border:1px solid var(--line);border-radius:12px;padding:.9rem 1rem;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:transparent}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
.card h4{margin:.25rem 0 6px}
select,input[type="email"],input[type="text"],input[type="number"]{width:100%;border:1px solid var(--line);border-radius:10px;padding:.6rem .8rem;background:#fff}
input:focus,select:focus{outline:2px solid rgba(46,125,50,.18)}

.stack-btns{display:flex;flex-direction:column;gap:10px;margin:10px 0}
.btn{border:0;border-radius:10px;cursor:pointer;font-weight:700;padding:.8rem 1rem;transition:filter .15s ease;}
.btn:active{filter:brightness(.95)}
.btn--primary{background:var(--brand);color:#fff}
.btn--secondary{background:#5f6b7a;color:#fff}
.btn--ghost{background:#fff;border:1px dashed var(--line);color:#333}
.btn--line{background:#fff;border:1px solid var(--line)}
.btn--full{width:100%}

.filters{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:8px 0}
.filters .grow{flex:1 1 260px}
.chip{background:#f0f3ff;border:1px solid #e0e7ff;padding:6px 10px;border-radius:999px;font-weight:700;color:#334}

/* Produk 2 kolom */
.product-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width: 360px){ .product-grid{grid-template-columns:1fr} }
.p-card{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden;display:grid;grid-template-rows:auto 1fr;transition:box-shadow .2s,transform .06s}
.p-card:hover{box-shadow:0 10px 20px -12px rgba(0,0,0,.15);transform:translateY(-1px)}
.p-img{width:100%;height:160px;object-fit:cover;background:#f3f4f6;display:block}
.p-body{padding:10px;display:flex;flex-direction:column;gap:6px}
.p-name{font-weight:700;font-size:.95rem;line-height:1.25;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.p-meta{color:var(--muted);font-size:.85rem}
.p-foot{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
.price{font-weight:900;color:#c62828}

.two-cols{display:grid;gap:12px}
@media (min-width:980px){ .two-cols{grid-template-columns:1.2fr .8fr} }
.cart{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
.cart-item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px 0;border-bottom:1px dashed #e8e8ee}
.qty{display:inline-flex;align-items:center;gap:6px}
.qty button{width:28px;height:28px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer}
.k-right{display:flex;align-items:center;gap:8px}
.price-control.hidden{display:none!important}
.tag{background:#f3f4f6;border:1px solid var(--line);padding:4px 8px;border-radius:8px;font-weight:700}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px 10px;font-size:.92rem}
.table thead th{background:#fafafe;text-align:left}
.row-actions button{background:#ffe4e6;border:1px solid #ffccd0;color:#c62828;padding:4px 8px;border-radius:8px;cursor:pointer}

.login-card{max-width:520px;margin:30px auto}
.login-card input{width:100%}

@media print{
  @page{size:58mm auto;margin:0}
  body{background:#fff}
  .print{width:58mm;font-family:monospace;font-size:11px}
  .print h3{text-align:center;margin:6px 0}
  .line{border-top:1px dashed #000;margin:6px 0}
  .row{display:flex;justify-content:space-between}
}
</style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <div id="loginPage" class="login-card">
    <div class="card">
      <h2>Login Kasir</h2>
      <input type="email" id="emailInput" placeholder="Email (contoh: kasir@tokotanaman.com)"/>
      <div style="height:8px"></div>
      <button class="btn btn--primary btn--full" onclick="login()">Masuk</button>
    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="hidden">
    <div class="userbar">
      <div id="userInfo">Kasir: - | Cabang: -</div>
      <a href="javascript:void(0)" onclick="logout()">Logout</a>
    </div>

    <div class="tabs">
      <button id="navKasir" class="tab active" onclick="tampilkanHalaman('kasir')">Kasir</button>
      <button id="navLaporan" class="tab" onclick="tampilkanHalaman('laporan')">Laporan</button>
    </div>

    <!-- ===== HALAMAN KASIR ===== -->
    <div id="posPage">
      <div class="stack-btns">
        <button class="btn btn--secondary" onclick="bukaFormMember()">+ Daftarkan Member Baru</button>
        <button class="btn btn--secondary" onclick="bukaFormManual()">+ Tambah Item Manual</button>
        <button class="btn btn--secondary" onclick="toggleMember()">Gunakan Diskon Member</button>
      </div>

      <div class="filters">
        <input class="grow" id="searchInput" type="text" placeholder="Cari tanaman..." oninput="updateProductView()"/>
        <div style="display:flex;gap:.5rem;margin-left:auto">
          <button id="prevPageBtn" class="btn btn--line" onclick="changePage(-1)">&laquo; Sebelumnya</button>
          <span id="pageInfo" class="chip">Halaman 1 dari 1</span>
          <button id="nextPageBtn" class="btn btn--line" onclick="changePage(1)">Berikutnya &raquo;</button>
        </div>
      </div>

      <div class="two-cols">
        <!-- GRID PRODUK -->
        <div class="card">
          <div id="produkGrid" class="product-grid"></div>
        </div>

        <!-- KERANJANG -->
        <div>
          <div class="cart">
            <h4>Keranjang Belanja</h4>
            <div id="cartList" class="muted">Tidak ada item.</div>
            <div style="border-top:1px dashed #e9e9ee;margin:10px 0"></div>
            <div><b>Subtotal:</b> <span id="subtotalText">Rp 0</span></div>
            <div><b>Penghematan Member:</b> <span id="hematText">Rp 0</span></div>
            <div><b>Total:</b> <span id="totalText">Rp 0</span></div>
            <div style="height:8px"></div>
            <button id="btnBayar" class="btn btn--primary btn--full" onclick="mulaiPembayaran()" disabled>Lanjut ke Pembayaran</button>
          </div>

          <!-- PEMBAYARAN -->
          <div id="payCard" class="card hidden" style="margin-top:10px">
            <h4>Detail Pembayaran</h4>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <label><input type="radio" name="pay" value="Tunai" checked onclick="switchPay('Tunai')"/> Tunai</label>
              <label><input type="radio" name="pay" value="Non-Tunai" onclick="switchPay('Non-Tunai')"/> Non-Tunai</label>
              <select id="detailMetode" class="hidden">
                <option>Transfer</option>
                <option>QRIS</option>
                <option>Debit</option>
                <option>Shopee</option>
                <option>Tokopedia</option>
              </select>
            </div>
            <div style="height:8px"></div>
            <button id="btnSimpan" class="btn btn--primary" onclick="selesaikanTransaksi(this)">Konfirmasi & Simpan</button>
            <button class="btn btn--line" onclick="batalPembayaran()">Kembali ke Keranjang</button>
          </div>

          <!-- SELESAI -->
          <div id="postTransactionCard" class="card hidden" style="margin-top:10px">
            <h4>Transaksi Berhasil</h4>
            <p style="color:#555">Silakan cetak struk atau kembali ke kasir.</p>
            <button id="btnCetakStruk" class="btn btn--primary" onclick="cetakStruk()">Cetak Struk</button>
            <button class="btn btn--line" onclick="kembaliKeHalamanAwal()">Kembali ke Kasir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== HALAMAN LAPORAN ===== -->
    <div id="laporanPage" class="hidden">
      <div class="card">
        <h3 id="laporanTitle">Laporan Gabungan Semua Cabang</h3>
        <small>(Data diperbarui setiap ada transaksi baru)</small>
        <div id="reportContent" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================
   BACKEND (GET/JSONP)
   ====================== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

async function getData(action, payload = {}) {
  const url = new URL(SCRIPT_URL);
  url.searchParams.set('action', action);
  if (payload && Object.keys(payload).length) url.searchParams.set('payload', JSON.stringify(payload));
  const res = await fetch(url.toString(), { method:'GET' });
  if (!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
async function postData(action, payload = {}) { return getData(action, payload); }

/* ===== STATE & UTIL ===== */
let semuaProduk=[], keranjang=[], currentUser=null;
let currentPage=1, itemsPerPage=8;
let isMemberActive=false;
let lastSavedTransaction=null;

const fmt = n => 'Rp ' + (Number(n||0)).toLocaleString('id-ID');

/* ===== AUTO-LOGIN saat page load ===== */
document.addEventListener('DOMContentLoaded', async () => {
  const saved = localStorage.getItem('kasir_user_email');
  if (!saved) return;
  try{
    const res = await getData('cekLogin', { email: saved });
    if (res.success){
      currentUser = res.user;
      document.getElementById('userInfo').textContent = `Kasir: ${currentUser.email} | Cabang: ${currentUser.cabang}`;
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      await inisialisasi();
    }else{
      localStorage.removeItem('kasir_user_email');
    }
  }catch(e){
    // kalau gagal koneksi, tetap tampilkan login
    localStorage.removeItem('kasir_user_email');
  }
});

/* ===== LOGIN ===== */
async function login(){
  const email = document.getElementById('emailInput').value.trim();
  if(!email){ alert('Masukkan email.'); return; }
  try{
    const res = await getData('cekLogin', {email});
    if(!res.success){ alert(res.message||'Login gagal'); return; }
    currentUser = res.user;
    localStorage.setItem('kasir_user_email', email);   // simpan supaya tidak login lagi
    document.getElementById('userInfo').textContent = `Kasir: ${currentUser.email} | Cabang: ${currentUser.cabang}`;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');
    await inisialisasi();
  }catch(e){ alert('Gagal terhubung ke server.'); }
}
function logout(){ localStorage.removeItem('kasir_user_email'); location.reload(); }

/* ===== INIT ===== */
async function inisialisasi(){
  const p = await getData('getProduk');
  semuaProduk = (p||[]).map(x=>({
    id: x['ID Produk']||x.ID||'',
    nama: x['Nama Produk']||'',
    variasi: x['Ukuran/Variasi']||'',
    harga: Number(x['Harga Jual']||0),
    hargaMember: Number(x['Harga Member']||0)||null,
    foto: x['Foto URL']||''
  }));
  updateProductView();
}

/* ===== PRODUK: 2 kolom (FIX var ganda) ===== */
function getFilteredProduk(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  return semuaProduk.filter(p=>p.nama.toLowerCase().includes(q));
}
function paginate(list){
  const totalPages=Math.max(1,Math.ceil(list.length/itemsPerPage));
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*itemsPerPage;
  return {data:list.slice(start,start+itemsPerPage), totalPages};
}
function renderProduk(){
  const grid=document.getElementById('produkGrid');
  const filtered = getFilteredProduk();
  const page = paginate(filtered);
  const pageItems = page.data;
  const totalPages = page.totalPages;

  grid.innerHTML = pageItems.map(p=>`
    <div class="p-card">
      <img class="p-img" src="${p.foto||''}" alt="${p.nama}" loading="lazy" decoding="async" referrerpolicy="no-referrer">
      <div class="p-body">
        <div class="p-name">${p.nama}</div>
        ${p.variasi?`<div class="p-meta">${p.variasi}</div>`:''}
        <div class="p-foot">
          <div class="price">${fmt(isMemberActive && p.hargaMember ? p.hargaMember : p.harga)}</div>
          <button class="btn btn--primary" style="padding:.45rem .7rem" onclick='tambahKeKeranjang(${JSON.stringify(p).replace(/"/g,"&quot;")})'>+ Keranjang</button>
        </div>
      </div>
    </div>
  `).join('') || '<div class="muted">Tidak ada produk.</div>';

  document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages}`;
  document.getElementById('prevPageBtn').disabled = currentPage===1;
  document.getElementById('nextPageBtn').disabled = currentPage===totalPages;
}
function updateProductView(){ renderProduk(); }
function changePage(d){ currentPage+=d; if(currentPage<1) currentPage=1; updateProductView(); }

/* ===== KERANJANG ===== */
function tambahKeKeranjang(p){
  const idx=keranjang.findIndex(it=>it.id===p.id && it.variasi===p.variasi);
  const harga=(isMemberActive && p.hargaMember)?p.hargaMember:p.harga;
  if(idx>=0) keranjang[idx].qty++;
  else keranjang.push({id:p.id,nama:p.nama,variasi:p.variasi,qty:1,hargaAwal:harga,hargaNego:harga,custom:false});
  renderCart();
}
function bukaFormManual(){
  const nama=prompt('Nama item (mis: kurir):','');
  if(!nama) return;
  const harga=Number(prompt('Harga satuan:','0')||0);
  if(harga<=0) return;
  keranjang.push({id:'MANUAL-'+Date.now(),nama,variasi:'Custom',qty:1,hargaAwal:harga,hargaNego:harga,custom:true});
  renderCart();
}
function bukaFormMember(){ toggleMember(true); }
function toggleMember(forceOn){
  if(forceOn===true) isMemberActive=true; else isMemberActive=!isMemberActive;
  keranjang = keranjang.map(k=>{
    if(k.custom) return k;
    const p=semuaProduk.find(x=>x.nama===k.nama && x.variasi===k.variasi);
    const h=(isMemberActive && p && p.hargaMember)?p.hargaMember:(p?p.harga:k.hargaAwal);
    return {...k,hargaAwal:h,hargaNego:h};
  });
  renderCart(); renderProduk();
}
function qtyChange(i,delta){
  keranjang[i].qty+=delta;
  if(keranjang[i].qty<=0) keranjang.splice(i,1);
  renderCart();
}
function removeItem(i){ keranjang.splice(i,1); renderCart(); }
function toggleNego(i){ keranjang[i].showNego=!keranjang[i].showNego; renderCart(); }
function negoInput(i,v){ keranjang[i].hargaNego=Number(v||0); }
function applyNego(i){ if(keranjang[i].hargaNego<=0) keranjang[i].hargaNego=keranjang[i].hargaAwal; keranjang[i].showNego=false; renderCart(); }

function renderCart(){
  const box=document.getElementById('cartList');
  if(!keranjang.length){ box.innerHTML='Tidak ada item.'; document.getElementById('btnBayar').disabled=true; hitungTotal(); return; }
  box.innerHTML = keranjang.map((it,i)=>`
    <div class="cart-item">
      <div>
        <div><b>${it.nama}</b> ${it.variasi?`<span class="p-meta">(${it.variasi})</span>`:''}</div>
        <div class="qty">
          <button onclick="qtyChange(${i},-1)">−</button>
          <span>${it.qty}</span>
          <button onclick="qtyChange(${i},1)">+</button>
          <button class="btn btn--line" style="padding:.3rem .6rem" onclick="toggleNego(${i})">Nego</button>
          <span class="price-control ${it.showNego?'':'hidden'}">
            Rp <input type="number" style="width:90px" value="${it.hargaNego}" oninput="negoInput(${i},this.value)"/>
            <button class="btn btn--primary" style="padding:.3rem .6rem" onclick="applyNego(${i})">OK</button>
          </span>
        </div>
      </div>
      <div class="k-right">
        <span class="tag">${fmt(it.hargaNego)}</span>
        <button class="btn btn--line" style="padding:.3rem .6rem" onclick="removeItem(${i})">Hapus</button>
      </div>
    </div>
  `).join('');
  document.getElementById('btnBayar').disabled=false;
  hitungTotal();
}
function hitungTotal(){
  let subtotal=0, asli=0;
  keranjang.forEach(it=>{ subtotal+=it.qty*it.hargaNego; asli+=it.qty*it.hargaAwal; });
  const hemat=Math.max(0,asli-subtotal);
  document.getElementById('subtotalText').textContent=fmt(asli);
  document.getElementById('hematText').textContent=fmt(hemat);
  document.getElementById('totalText').textContent=fmt(subtotal);
}

/* ===== PEMBAYARAN & CETAK ===== */
function mulaiPembayaran(){
  document.getElementById('payCard').classList.remove('hidden');
  document.getElementById('postTransactionCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=true;
}
function batalPembayaran(){
  document.getElementById('payCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=false;
}
function switchPay(type){
  const d=document.getElementById('detailMetode');
  if(type==='Tunai') d.classList.add('hidden'); else d.classList.remove('hidden');
}
async function selesaikanTransaksi(btn){
  if(!keranjang.length) return;
  btn.disabled=true; btn.textContent='Menyimpan...';
  try{
    const payload={
      cabang: currentUser.cabang,
      metodePembayaran: document.querySelector('input[name="pay"]:checked').value,
      detailMetode: document.getElementById('detailMetode').classList.contains('hidden')?'':document.getElementById('detailMetode').value,
      items: keranjang.map(k=>({ produk:{'ID Produk':k.id,'Nama Produk':k.nama,'Ukuran/Variasi':k.variasi}, qty:k.qty, hargaAkhirSatuan:k.hargaNego }))
    };
    const res=await postData('simpanTransaksi',payload);
    if(!res.success){ alert(res.message||'Gagal menyimpan'); btn.disabled=false; btn.textContent='Konfirmasi & Simpan'; return; }
    lastSavedTransaction=res.id||null;
    document.getElementById('payCard').classList.add('hidden');
    document.getElementById('postTransactionCard').classList.remove('hidden');
  }catch(e){ alert('Terjadi kesalahan saat menyimpan transaksi: '+e.message); }
  finally{ btn.disabled=false; btn.textContent='Konfirmasi & Simpan'; }
}
function kembaliKeHalamanAwal(){
  keranjang=[]; renderCart();
  document.getElementById('postTransactionCard').classList.add('hidden');
  document.getElementById('btnBayar').disabled=true;
}
function cetakStruk(){
  if(!keranjang.length && !lastSavedTransaction){ alert('Tidak ada isi untuk dicetak.'); return; }
  const items=keranjang.length?keranjang:[];
  const total=items.reduce((s,i)=>s+i.qty*i.hargaNego,0);
  const w=window.open('','_blank');
  w.document.write(`
    <html><head><meta charset="utf-8">
      <style>
        @page{size:58mm auto;margin:0}
        body{font-family:monospace;font-size:11px;margin:0}
        .print{width:58mm;padding:6px 8px}
        h3{text-align:center;margin:4px 0 6px}
        .line{border-top:1px dashed #000;margin:6px 0}
        .row{display:flex;justify-content:space-between}
      </style>
    </head><body onload="window.print();setTimeout(()=>window.close(),300);">
      <div class="print">
        <h3>STRUK PENJUALAN</h3>
        <div>Kasir: ${currentUser.email}</div>
        <div>Cabang: ${currentUser.cabang}</div>
        <div class="line"></div>
        ${items.map(i=>`
          <div>${i.nama}${i.variasi?` (${i.variasi})`:''}</div>
          <div class="row"><span>${i.qty} x ${fmt(i.hargaNego)}</span><b>${fmt(i.qty*i.hargaNego)}</b></div>
        `).join('')}
        <div class="line"></div>
        <div class="row"><b>Total</b><b>${fmt(total)}</b></div>
        <div style="margin-top:6px;text-align:center">Terima kasih</div>
      </div>
    </body></html>
  `); w.document.close();
}

/* ===== NAVIGASI ===== */
function tampilkanHalaman(hal){
  const pos=document.getElementById('posPage');
  const lap=document.getElementById('laporanPage');
  const nk=document.getElementById('navKasir');
  const nl=document.getElementById('navLaporan');
  if(hal==='laporan'){ pos.classList.add('hidden'); lap.classList.remove('hidden'); nl.classList.add('active'); nk.classList.remove('active'); muatLaporan(); }
  else{ lap.classList.add('hidden'); pos.classList.remove('hidden'); nk.classList.add('active'); nl.classList.remove('active'); }
}

/* ===== LAPORAN + HAPUS ADMIN ===== */
async function muatLaporan(){
  if(!currentUser) return;
  const box=document.getElementById('reportContent'); box.innerHTML='<div class="muted">Memproses...</div>';
  try{
    const [harian,detail]=await Promise.all([
      getData('getLaporanHarian',{role:currentUser.role,cabang:currentUser.cabang}),
      getData('getLaporanDetail',{role:currentUser.role,cabang:currentUser.cabang})
    ]);
    let html='';
    (harian.reports||[]).forEach(r=>{
      html+=`
        <div class="card" style="margin-bottom:10px">
          <b>Laporan Cabang: ${r.cabang}</b>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:8px">
            <div>Total Penjualan<br><b>${fmt(r.totalPenjualan)}</b></div>
            <div>Jumlah Transaksi<br><b>${r.jumlahTransaksi}</b></div>
            <div>Penjualan Tunai<br><b>${fmt(r.totalTunai)}</b></div>
            <div>Penjualan Non-Tunai<br><b>${fmt(r.totalNonTunai)}</b></div>
          </div>
        </div>`;
    });
    if(currentUser.role==='Admin'){
      const grouped=detail.groupedTransactions||{};
      Object.keys(grouped).forEach(cbg=>{ html+=renderDetailTabel(cbg,grouped[cbg],true); });
    }else{
      html+=renderDetailTabel(currentUser.cabang,(detail.transactions||[]),false);
    }
    box.innerHTML=html||'<div class="muted">Tidak ada data hari ini.</div>';
  }catch(e){ box.innerHTML='<div class="muted">Gagal memuat laporan: '+e.message+'</div>'; }
}
function renderDetailTabel(cabang,list,isAdmin){
  const rows=(list||[]).map(it=>`
    <tr>
      <td>${it.timestamp||''}</td>
      <td>${it.produk||''}</td>
      <td>${it.qty}</td>
      <td>${fmt(it.hargaSatuan||0)}</td>
      <td><b>${fmt(it.total||0)}</b></td>
      <td class="row-actions" style="text-align:center">${isAdmin?`<button onclick="hapusItemAdmin(${it.row})">❌</button>`:''}</td>
    </tr>`).join('');
  return `
    <details class="card" style="margin-top:10px" open>
      <summary><b>Lihat Detail Item Terjual - Cabang ${cabang}</b></summary>
      <div style="margin-top:8px;overflow:auto">
        <table class="table">
          <thead><tr><th>Waktu</th><th>Produk</th><th>Qty</th><th>Harga Satuan</th><th>Total</th><th>Aksi</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="6">Tidak ada item.</td></tr>'}</tbody>
        </table>
      </div>
    </details>`;
}
async function hapusItemAdmin(row){
  if(!confirm('Yakin hapus baris transaksi ini?')) return;
  try{
    const r=await postData('hapusItem',{row,userRole:currentUser.role,userCabang:currentUser.cabang});
    if(!r.success){ alert(r.message||'Gagal menghapus'); return; }
    await muatLaporan();
  }catch(e){ alert('Gagal: '+e.message); }
}
</script>
</body>
</html>
