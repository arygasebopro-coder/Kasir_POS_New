<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kasir POS Tanaman</title>
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --text:#222;
    --muted:#6b7280;
    --primary:#c62828;     /* merah */
    --primary-weak:#fbe9e7;
    --accent:#2e7d32;      /* hijau */
    --accent-weak:#e8f5e9;
    --warning:#f9a825;     /* kuning (nego) */
    --danger:#e53935;
    --radius:14px;
    --shadow:0 6px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin-inline:auto;padding:18px}

  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .role{font-weight:600;color:var(--muted)}
  .btn-link{color:var(--danger);cursor:pointer;font-weight:700;border:none;background:none}

  .tabs{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:10px 0 16px}
  .tab{background:var(--card);border-radius:999px;padding:14px 10px;text-align:center;
       box-shadow:var(--shadow);color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{background:var(--primary);color:#fff}

  /* cards */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .section{padding:16px 16px}

  /* login */
  .login-grid{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:8px}
  input,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:12px 12px;font:inherit;background:#fff}
  .btn{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-ghost{background:#eef2f7;color:var(--text)}
  .btn-small{padding:8px 10px;border-radius:999px;font-weight:700}

  /* produk grid */
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (min-width:800px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr));} }
  .p-card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .p-img{aspect-ratio:1/1;object-fit:cover;width:100%;background:#fafafa}
  .p-body{padding:12px 12px 10px}
  .p-name{font-weight:700;margin-bottom:4px}
  .p-price{color:var(--primary);font-weight:800}
  .p-actions{padding:10px 12px 14px}
  .btn-cart{background:var(--accent);color:#fff;width:100%;border-radius:999px;padding:10px 12px;font-weight:800}

  /* keranjang */
  .cart{margin-top:16px}
  .cart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .c-item{background:#1111; background:var(--card);border-radius:14px;border:1px solid #eef; padding:10px 12px;margin:8px 0;display:flex;flex-direction:column;gap:8px}
  .c-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .c-title{font-weight:700}
  .qty-row{display:flex;align-items:center;gap:8px}
  .qty-btn{width:34px;height:34px;border-radius:999px;border:none;font-weight:900;color:#fff;cursor:pointer}
  .qty-minus{background:var(--danger)}
  .qty-plus{background:var(--accent)}
  .qty-box{min-width:44px;text-align:center;background:#f3f4f6;border-radius:10px;padding:7px 10px}
  .nego-row{display:flex;align-items:center;gap:8px}
  .nego-input{display:none;gap:8px;align-items:center}
  .nego-btn{background:var(--warning);color:#000;border:none;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .ok-btn{background:#16a34a;color:#fff;border:none;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .rm-btn{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:6px 8px;cursor:pointer}

  .summary{margin-top:8px;border-top:1px dashed #e5e7eb;padding-top:8px;display:grid;gap:6px}
  .line{display:flex;justify-content:space-between}
  .total{font-weight:900}

  .pay-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn-wide{width:100%}
  .hidden{display:none !important}
</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="role" id="userBadge">Kasir: - | Cabang: -</div>
      <div style="display:flex;gap:12px;align-items:center">
        <button class="btn-link" id="logoutBtn" onclick="doLogout()">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <div id="tabKasir" class="tab active" onclick="switchTab('kasir')">Kasir</div>
      <div id="tabLaporan" class="tab" onclick="switchTab('laporan')">Laporan</div>
    </div>

    <!-- LOGIN -->
    <div id="loginPage" class="card">
      <div class="section">
        <div style="font-weight:800">Login Kasir/Admin</div>
        <div class="login-grid">
          <input id="emailInput" type="email" placeholder="Email (contoh: kasir@tokotanaman.com)" />
          <button class="btn btn-primary" onclick="login()">Masuk</button>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appContainer" class="hidden">
      <!-- toolbar search -->
      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Cari tanaman..." oninput="filterProduk()" />
      </div>

      <!-- produk -->
      <div id="produkGrid" class="grid"></div>

      <!-- keranjang -->
      <div class="card cart" id="cartCard">
        <div class="section">
          <div class="cart-head">
            <div style="font-weight:800">Keranjang</div>
            <div id="cartInfo" class="muted"></div>
          </div>
          <div id="cartList"></div>

          <div class="summary">
            <div class="line"><span>Subtotal:</span><span id="subtotalTxt">Rp 0</span></div>
            <div class="line"><span>Penghematan Member:</span><span id="saveTxt">Rp 0</span></div>
            <div class="line total"><span>Total:</span><span id="totalTxt">Rp 0</span></div>
          </div>

          <div class="pay-actions">
            <button class="btn btn-primary btn-wide" onclick="lanjutPembayaran()">Lanjut ke Pembayaran</button>
          </div>

          <!-- panel pembayaran (muncul setelah klik Lanjut) -->
          <div id="payPanel" class="hidden" style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:6px">Metode Pembayaran</div>
            <label style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
              <input type="radio" name="pay" value="Tunai" checked /> Tunai
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="radio" name="pay" value="Non-Tunai" /> Non-Tunai
            </label>

            <div class="pay-actions" style="margin-top:10px">
              <button class="btn btn-accent btn-wide" onclick="konfirmasiSimpan()">Konfirmasi & Simpan</button>
              <button class="btn btn-ghost btn-wide" onclick="batalPembayaran()">Kembali</button>
            </div>
          </div>

          <!-- panel setelah simpan -->
          <div id="postSavePanel" class="hidden" style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:8px">Transaksi Berhasil</div>
            <div class="pay-actions">
              <button class="btn btn-primary btn-wide" onclick="cetakStruk()">Cetak Struk</button>
              <button class="btn btn-ghost btn-wide" onclick="kembaliKeProduk()">Selesai</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- LAPORAN -->
    <div id="laporanPage" class="hidden">
      <div class="card">
        <div class="section">
          <div style="font-weight:800">Laporan Penjualan Hari Ini</div>
          <div id="laporanWrap" style="margin-top:10px;color:var(--muted)">Silakan buka tab Laporan setelah login.</div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   KONFIGURASI BACKEND (JSONP)
   ========================= */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

/* =========================
   STATE
   ========================= */
let currentUser = null;
let semuaProduk = [];
let keranjang = [];
let lastSavedTrx = null;

/* =========================
   UTIL & API JSONP
   ========================= */
function fmtRp(n){ n=+n||0; return 'Rp ' + n.toLocaleString('id-ID'); }

function jsonp(action, payload={}){
  return new Promise((resolve,reject)=>{
    const cb = 'cb'+Date.now().toString(36)+Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    function cleanup(){ try{ delete window[cb]; }catch{} script.remove(); }

    const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${cb}`;
    const script = document.createElement('script');
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error('Gagal terhubung ke server.')); };
    document.body.appendChild(script);
  });
}

function switchTab(tab){
  document.getElementById('tabKasir').classList.toggle('active', tab==='kasir');
  document.getElementById('tabLaporan').classList.toggle('active', tab==='laporan');
  document.getElementById('appContainer').classList.toggle('hidden', tab!=='kasir');
  document.getElementById('laporanPage').classList.toggle('hidden', tab!=='laporan');
  if(tab==='laporan'){ muatLaporan(); }
}

/* =========================
   LOGIN / LOGOUT
   ========================= */
async function login(){
  const email = document.getElementById('emailInput').value.trim();
  if(!email){ alert('Masukkan email.'); return; }
  try{
    const res = await jsonp('cekLogin', { email });
    if(!res || !res.success){ alert(res && res.message ? res.message : 'Login gagal'); return; }
    currentUser = res.user;
    localStorage.setItem('kasir_user', JSON.stringify(currentUser));
    afterLogin();
  }catch(e){
    alert('Gagal terhubung ke server.');
  }
}

function afterLogin(){
  // header info
  const badge = document.getElementById('userBadge');
  badge.textContent = `${currentUser.role}: ${currentUser.email} | Cabang: ${currentUser.cabang}`;

  // tampilkan app
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('appContainer').classList.remove('hidden');

  // load produk
  loadProduk();
  renderCart();
}

function doLogout(){
  localStorage.removeItem('kasir_user');
  location.reload();
}

// Auto login
(function(){
  const saved = localStorage.getItem('kasir_user');
  if(saved){
    try{ currentUser = JSON.parse(saved)||null; }catch{}
    if(currentUser){ afterLogin(); }
  }
})();

/* =========================
   PRODUK
   ========================= */
async function loadProduk(){
  try{
    const res = await jsonp('getProduk', {});
    semuaProduk = Array.isArray(res) ? res : [];
    renderProduk(semuaProduk);
  }catch(e){
    alert('Gagal memuat produk.');
  }
}

function filterProduk(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  const list = semuaProduk.filter(p => (String(p['Nama Produk']||'').toLowerCase().includes(q)));
  renderProduk(list);
}

function renderProduk(list){
  const el = document.getElementById('produkGrid');
  if(!list || !list.length){ el.innerHTML = '<div class="card section" style="grid-column:1/-1;color:var(--muted)">Tidak ada produk.</div>'; return; }
  el.innerHTML = list.map(p=>{
    const nama = p['Nama Produk'] || '';
    const variasi = p['Ukuran/Variasi'] ? `<div style="color:var(--muted);font-size:12px">${p['Ukuran/Variasi']}</div>` : '';
    const harga = +p['Harga Jual']||0;
    const foto = p['Foto'] || p['Gambar'] || '';
    return `
      <div class="p-card">
        <img class="p-img" src="${foto}" alt="">
        <div class="p-body">
          <div class="p-name">${nama}</div>
          ${variasi}
          <div class="p-price" style="margin-top:4px">${fmtRp(harga)}</div>
        </div>
        <div class="p-actions">
          <button class="btn-cart" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&apos;")})'>+ Keranjang</button>
        </div>
      </div>
    `;
  }).join('');
}

function addToCart(prod){
  const idp = prod['ID Produk'] || prod['Nama Produk'];
  const idx = keranjang.findIndex(i => i.idp===idp && i.variasi=== (prod['Ukuran/Variasi']||''));
  if(idx>=0){
    keranjang[idx].qty += 1;
  }else{
    keranjang.push({
      idp,
      nama: prod['Nama Produk']||'',
      variasi: prod['Ukuran/Variasi']||'',
      qty: 1,
      harga: +prod['Harga Jual']||0,
      nego: null,          // nilai nego (jika ada)
      showNego: false      // disembunyikan di awal
    });
  }
  renderCart();
}

/* =========================
   KERANJANG & NEGO
   ========================= */
function renderCart(){
  const list = document.getElementById('cartList');
  if(!keranjang.length){
    list.innerHTML = `<div style="color:var(--muted)">Tidak ada item.</div>`;
  }else{
    list.innerHTML = keranjang.map((it,ix)=>{
      const satuan = it.nego!=null ? it.nego : it.harga;
      const total = satuan * it.qty;
      const subtitle = it.variasi ? ` <span style="color:var(--muted)">(${it.variasi})</span>` : '';
      return `
        <div class="c-item">
          <div class="c-top">
            <div class="c-title">${it.nama}${subtitle}</div>
            <button class="rm-btn" title="hapus" onclick="hapusItem(${ix})">✕</button>
          </div>
          <div class="qty-row">
            <button class="qty-btn qty-minus" onclick="kurang(${ix})">−</button>
            <div class="qty-box">${it.qty}</div>
            <button class="qty-btn qty-plus" onclick="tambah(${ix})">＋</button>

            <div class="nego-row">
              <button class="nego-btn" onclick="toggleNego(${ix})">Nego</button>
              <div class="nego-input" id="negoWrap${ix}">
                <span>Rp</span>
                <input id="negoInput${ix}" type="number" min="0" value="${satuan}" style="width:110px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px"/>
                <button class="ok-btn" onclick="setNego(${ix})">OK</button>
              </div>
            </div>
          </div>
          <div style="font-weight:700;margin-top:2px">${it.qty} × ${fmtRp(satuan)} = ${fmtRp(total)}</div>
        </div>
      `;
    }).join('');
  }

  // pastikan semua nego input dalam keadaan hidden sesuai flag
  keranjang.forEach((it,ix)=>{
    const w = document.getElementById('negoWrap'+ix);
    if(w) w.style.display = it.showNego ? 'flex' : 'none';
  });

  // ringkasan
  const subtotal = keranjang.reduce((s,i)=> s + ( (i.nego!=null?i.nego:i.harga) * i.qty ), 0);
  document.getElementById('subtotalTxt').textContent = fmtRp(subtotal);
  document.getElementById('totalTxt').textContent = fmtRp(subtotal);
  document.getElementById('saveTxt').textContent = 'Rp 0';

  // reset panel pembayaran & selesai
  document.getElementById('payPanel').classList.add('hidden');
  document.getElementById('postSavePanel').classList.add('hidden');
}

function toggleNego(ix){
  keranjang[ix].showNego = !keranjang[ix].showNego;
  const w = document.getElementById('negoWrap'+ix);
  if(w) w.style.display = keranjang[ix].showNego ? 'flex' : 'none';
}
function setNego(ix){
  const val = +document.getElementById('negoInput'+ix).value||0;
  keranjang[ix].nego = val>0 ? val : null;
  renderCart();
}
function hapusItem(ix){ keranjang.splice(ix,1); renderCart(); }
function tambah(ix){ keranjang[ix].qty++; renderCart(); }
function kurang(ix){ keranjang[ix].qty = Math.max(1, keranjang[ix].qty-1); renderCart(); }

/* =========================
   PEMBAYARAN
   ========================= */
function lanjutPembayaran(){
  if(!keranjang.length){ alert('Keranjang kosong.'); return; }
  // sembunyikan daftar item? Tidak; tapi sesuai permintaan—form pembayaran di bawah
  document.getElementById('payPanel').classList.remove('hidden');
  document.getElementById('postSavePanel').classList.add('hidden');
}

async function konfirmasiSimpan(){
  if(!keranjang.length){ return; }
  const metode = [...document.querySelectorAll('input[name="pay"]')].find(r=>r.checked)?.value || 'Tunai';

  // siapkan payload untuk backend
  const items = keranjang.map(i=>({
    produk: {'ID Produk': i.idp, 'Nama Produk': i.nama, 'Ukuran/Variasi': i.variasi},
    qty: i.qty,
    hargaAkhirSatuan: (i.nego!=null ? i.nego : i.harga)
  }));
  const payload = {
    cabang: currentUser?.cabang || 'Pusat',
    metodePembayaran: metode,
    detailMetode: '',
    items
  };

  try{
    const res = await jsonp('simpanTransaksi', payload);
    if(!res || !res.success){ alert((res&&res.message)||'Gagal menyimpan'); return; }
    lastSavedTrx = res.id || null;
    document.getElementById('payPanel').classList.add('hidden');
    document.getElementById('postSavePanel').classList.remove('hidden');
  }catch(e){
    alert('Terjadi kesalahan saat menyimpan transaksi.');
  }
}

function batalPembayaran(){
  document.getElementById('payPanel').classList.add('hidden');
}

function cetakStruk(){
  if(!lastSavedTrx){ alert('Tidak ada transaksi.'); return; }
  // Versi sederhana: gunakan window.print(); (bisa kamu ganti dgn struk 58mm yg sudah kamu miliki)
  window.print();
}

function kembaliKeProduk(){
  // kosongkan keranjang & reset panel
  keranjang = [];
  lastSavedTrx = null;
  renderCart();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* =========================
   LAPORAN (hanya saat tab Laporan)
   ========================= */
async function muatLaporan(){
  const wrap = document.getElementById('laporanWrap');
  if(!currentUser){ wrap.textContent='Silakan login terlebih dahulu.'; return; }
  wrap.textContent = 'Memuat...';
  try{
    const harian = await jsonp('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang });
    const det = await jsonp('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang });
    const reports = (harian && harian.reports)||[];
    const list = (det && (det.transactions||[])) || [];

    let html = '';
    if(!reports.length){
      html += '<div style="color:var(--muted)">Tidak ada transaksi hari ini.</div>';
    }else{
      html += reports.map(r=>`
        <div class="card" style="margin:10px 0">
          <div class="section">
            <div style="font-weight:800">Cabang: ${r.cabang}</div>
            <div style="margin-top:6px">Total Penjualan: <b>${fmtRp(r.totalPenjualan)}</b></div>
            <div>Jumlah Transaksi: <b>${r.jumlahTransaksi}</b></div>
            <div>Penjualan Tunai: <b>${fmtRp(r.totalTunai)}</b></div>
            <div>Penjualan Non-Tunai: <b>${fmtRp(r.totalNonTunai)}</b></div>
          </div>
        </div>
      `).join('');
    }

    if(list.length){
      html += `
        <div class="card" style="margin:10px 0">
          <div class="section">
            <div style="font-weight:800;margin-bottom:6px">Detail Item Terjual</div>
            <div style="overflow:auto">
              <table style="width:100%;border-collapse:collapse">
                <thead>
                  <tr>
                    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Waktu</th>
                    <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Produk</th>
                    <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Qty</th>
                    <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Harga Satuan</th>
                    <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${list.map(it=>`
                    <tr>
                      <td style="padding:8px;border-bottom:1px solid #f2f2f2">${it.timestamp||''}</td>
                      <td style="padding:8px;border-bottom:1px solid #f2f2f2">${it.produk||''}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${it.qty||0}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${fmtRp(it.hargaSatuan||0)}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${fmtRp(it.total||0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    wrap.innerHTML = html;
  }catch(e){
    wrap.textContent = 'Gagal memuat laporan.';
  }
}
</script>
</body>
</html>
