<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kasir POS Tanaman</title>
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --text:#222;
    --muted:#6b7280;
    --primary:#c62828;      /* merah */
    --primary-weak:#fde7e7;
    --accent:#2e7d32;       /* hijau */
    --accent-weak:#e8f5e9;
    --warning:#f9a825;      /* kuning (nego) */
    --danger:#e53935;
    --radius:14px;
    --shadow:0 6px 24px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#121417;
    --card:#1a1d21;
    --text:#eef0f2;
    --muted:#9aa4b2;
    --primary:#d04444;
    --primary-weak:#2a1c1c;
    --accent:#44b256;
    --accent-weak:#16231a;
    --warning:#ffd84a;
    --danger:#ff6b6b;
    --shadow:0 8px 28px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin-inline:auto;padding:18px}

  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .role{font-weight:600;color:var(--muted)}
  .btn-link{color:var(--danger);cursor:pointer;font-weight:700;border:none;background:none}

  .tabs{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:10px 0 16px}
  .tab{background:var(--card);border-radius:999px;padding:14px 10px;text-align:center;
       box-shadow:var(--shadow);color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{background:var(--primary);color:#fff}

  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .section{padding:16px}

  .login-grid{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:8px}
  input,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:12px 12px;font:inherit;background:#fff}
  [data-theme="dark"] input,[data-theme="dark"] select{background:#101316;border-color:#2a2f37;color:#fff}
  .btn{border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-ghost{background:#eef2f7;color:var(--text)}
  [data-theme="dark"] .btn-ghost{background:#21262c;color:#cbd5e1}
  .btn-small{padding:8px 10px;border-radius:999px;font-weight:700}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .badges{display:flex;gap:8px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;font-weight:700}
  .badge-green{background:var(--accent-weak);color:var(--accent)}
  .badge-red{background:var(--primary-weak);color:var(--primary)}

  /* produk grid + pagination */
  .grid{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (min-width:800px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr));} }
  .p-card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .p-img{aspect-ratio:1/1;object-fit:cover;width:100%;background:#fafafa}
  [data-theme="dark"] .p-img{background:#0f1114}
  .p-body{padding:12px 12px 10px}
  .p-name{font-weight:700;margin-bottom:4px}
  .p-price{color:var(--primary);font-weight:800}
  .p-actions{padding:10px 12px 14px}
  .btn-cart{background:var(--accent);color:#fff;width:100%;border-radius:999px;padding:10px 12px;font-weight:800}

  .pager{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0}
  .btn-pager{border:none;background:var(--card);box-shadow:var(--shadow);border-radius:10px;padding:8px 12px;font-weight:700}
  .btn-pager[disabled]{opacity:.4;cursor:not-allowed}

  /* keranjang */
  .cart{margin-top:16px}
  .cart-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .c-item{background:var(--card);border-radius:14px;border:1px solid #e9eef5;padding:10px 12px;margin:8px 0;display:flex;flex-direction:column;gap:8px}
  [data-theme="dark"] .c-item{border-color:#28303a}
  .c-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .c-title{font-weight:700}
  .qty-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .qty-btn{width:34px;height:34px;border-radius:999px;border:none;font-weight:900;color:#fff;cursor:pointer}
  .qty-minus{background:var(--danger)}
  .qty-plus{background:var(--accent)}
  .qty-box{min-width:44px;text-align:center;background:#f3f4f6;border-radius:10px;padding:7px 10px}
  [data-theme="dark"] .qty-box{background:#101316;color:#cbd5e1}
  .nego-row{display:flex;align-items:center;gap:8px}
  .nego-input{display:none;gap:8px;align-items:center}
  .nego-btn{background:var(--warning);color:#000;border:none;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .ok-btn{background:#16a34a;color:#fff;border:none;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer}
  .rm-btn{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:6px 8px;cursor:pointer}

  .summary{margin-top:8px;border-top:1px dashed #e5e7eb;padding-top:8px;display:grid;gap:6px}
  [data-theme="dark"] .summary{border-color:#2a2f37}
  .line{display:flex;justify-content:space-between}
  .total{font-weight:900}

  .pay-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn-wide{width:100%}
  .hidden{display:none !important}

  /* mini action buttons (member/item/diskon) */
  .quick-actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{border:none;border-radius:999px;padding:8px 12px;font-weight:800;color:#fff;cursor:pointer}
  .chip-red{background:var(--primary)}
  .chip-green{background:var(--accent)}
  .chip-blue{background:#1d4ed8}

  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .modal.show{display:flex}
  .m-card{background:var(--card);color:var(--text);border-radius:16px;box-shadow:var(--shadow);max-width:420px;width:92%;padding:16px}
  .m-title{font-weight:800;margin-bottom:10px}
  .m-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>
  <div class="wrap" id="root">

    <div class="topbar">
      <div class="role" id="userBadge">Kasir: - | Cabang: -</div>
      <div style="display:flex;gap:12px;align-items:center">
        <button class="btn-ghost btn-small" onclick="toggleTheme()">ðŸŒ™ Mode</button>
        <button class="btn-link" id="logoutBtn" onclick="doLogout()">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <div id="tabKasir" class="tab active" onclick="switchTab('kasir')">Kasir</div>
      <div id="tabLaporan" class="tab" onclick="switchTab('laporan')">Laporan</div>
    </div>

    <!-- LOGIN -->
    <div id="loginPage" class="card">
      <div class="section">
        <div style="font-weight:800">Login Kasir/Admin</div>
        <div class="login-grid">
          <input id="emailInput" type="email" placeholder="Email (contoh: kasir@tokotanaman.com)" />
          <button class="btn btn-primary" onclick="login()">Masuk</button>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appContainer" class="hidden">
      <!-- quick actions -->
      <div class="quick-actions">
        <button class="chip chip-red"  onclick="openMember()">+ Member</button>
        <button class="chip chip-green" onclick="openItemManual()">+ Item</button>
        <button class="chip chip-blue" onclick="openDiskon()">Diskon</button>
      </div>

      <!-- toolbar search -->
      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Cari tanaman..." oninput="onSearch()" />
        <div class="badges">
          <span id="memberBadge" class="badge badge-green hidden">Member Aktif</span>
        </div>
      </div>

      <!-- pagination -->
      <div class="pager" id="pagerTop">
        <button class="btn-pager" id="prevBtn" onclick="changePage(-1)">&laquo; Sebelumnya</button>
        <div id="pageInfo"></div>
        <button class="btn-pager" id="nextBtn" onclick="changePage(1)">Berikutnya &raquo;</button>
      </div>

      <!-- produk -->
      <div id="produkGrid" class="grid"></div>

      <!-- pagination bottom -->
      <div class="pager" id="pagerBottom">
        <button class="btn-pager" onclick="changePage(-1)">&laquo; Sebelumnya</button>
        <div id="pageInfo2"></div>
        <button class="btn-pager" onclick="changePage(1)">Berikutnya &raquo;</button>
      </div>

      <!-- keranjang -->
      <div class="card cart" id="cartCard">
        <div class="section">
          <div class="cart-head">
            <div style="font-weight:800">Keranjang</div>
            <div id="cartInfo" class="muted"></div>
          </div>
          <div id="cartList"></div>

          <div class="summary">
            <div class="line"><span>Subtotal:</span><span id="subtotalTxt">Rp 0</span></div>
            <div class="line"><span>Penghematan Member:</span><span id="saveTxt">Rp 0</span></div>
            <div class="line total"><span>Total:</span><span id="totalTxt">Rp 0</span></div>
          </div>

          <div class="pay-actions">
            <button class="btn btn-primary btn-wide" onclick="lanjutPembayaran()">Lanjut ke Pembayaran</button>
          </div>

          <!-- panel pembayaran -->
          <div id="payPanel" class="hidden" style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:6px">Metode Pembayaran</div>
            <label style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
              <input type="radio" name="pay" value="Tunai" checked /> Tunai
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="radio" name="pay" value="Non-Tunai" /> Non-Tunai
            </label>

            <div class="pay-actions" style="margin-top:10px">
              <button class="btn btn-accent btn-wide" onclick="konfirmasiSimpan()">Konfirmasi & Simpan</button>
              <button class="btn btn-ghost btn-wide" onclick="batalPembayaran()">Kembali</button>
            </div>
          </div>

          <!-- panel setelah simpan -->
          <div id="postSavePanel" class="hidden" style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:8px">Transaksi Berhasil</div>
            <div class="pay-actions">
              <button class="btn btn-primary btn-wide" onclick="cetakStruk()">Cetak Struk</button>
              <button class="btn btn-ghost btn-wide" onclick="kembaliKeProduk()">Selesai</button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- LAPORAN -->
    <div id="laporanPage" class="hidden">
      <div class="card">
        <div class="section">
          <div style="font-weight:800">Laporan Penjualan Hari Ini</div>
          <div id="laporanWrap" style="margin-top:10px;color:var(--muted)">Silakan buka tab Laporan setelah login.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- MODALS -->
  <div class="modal" id="modalMember">
    <div class="m-card">
      <div class="m-title">Daftarkan Member Baru</div>
      <div style="display:grid;gap:10px">
        <input id="memberHp" type="tel" placeholder="Nomor HP (boleh 08â€¦ atau 8â€¦)" />
        <input id="memberNama" type="text" placeholder="Nama Member" />
      </div>
      <div class="m-actions">
        <button class="btn-ghost" onclick="closeModal('modalMember')">Batal</button>
        <button class="btn-primary" onclick="submitMember()">Simpan</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalDiskon">
    <div class="m-card">
      <div class="m-title">Aktifkan Diskon Member</div>
      <div style="display:grid;gap:10px">
        <input id="diskonHp" type="tel" placeholder="Nomor HP (boleh 08â€¦ atau 8â€¦)" />
      </div>
      <div class="m-actions">
        <button class="btn-ghost" onclick="closeModal('modalDiskon')">Batal</button>
        <button class="btn-primary" onclick="applyDiskon()">Terapkan Diskon</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalItem">
    <div class="m-card">
      <div class="m-title">Tambah Item Manual</div>
      <div style="display:grid;gap:10px">
        <input id="itemNama" type="text" placeholder="Nama item" />
        <input id="itemVar" type="text" placeholder="Variasi / catatan (opsional)" />
        <input id="itemHarga" type="number" min="0" placeholder="Harga satuan" />
        <input id="itemQty" type="number" min="1" value="1" placeholder="Qty" />
      </div>
      <div class="m-actions">
        <button class="btn-ghost" onclick="closeModal('modalItem')">Batal</button>
        <button class="btn-accent" onclick="submitItemManual()">Tambahkan</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   KONFIGURASI BACKEND (JSONP)
   ========================= */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

/* =========================
   STATE
   ========================= */
let currentUser = null;
let semuaProduk = [];
let filteredProduk = [];
let keranjang = [];
let lastSavedTrx = null;
let isMemberActive = false;
let pg = {page:1, per:8};

/* =========================
   THEME
   ========================= */
(function restoreTheme(){
  const t = localStorage.getItem('kasir_theme') || 'light';
  if(t==='dark') document.documentElement.setAttribute('data-theme','dark');
})();
function toggleTheme(){
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  if(dark){ document.documentElement.removeAttribute('data-theme'); localStorage.setItem('kasir_theme','light'); }
  else { document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('kasir_theme','dark'); }
}

/* =========================
   UTIL & API JSONP
   ========================= */
function fmtRp(n){ n=+n||0; return 'Rp ' + n.toLocaleString('id-ID'); }
function normalizeHp(hp){
  hp = String(hp||'').replace(/[^\d]/g,'');
  if(hp.startsWith('62')) hp = hp.slice(2);
  if(hp.startsWith('0')) hp = hp.slice(1);
  return hp; // simpan tanpa 0/62 di depan
}

function jsonp(action, payload={}){
  return new Promise((resolve,reject)=>{
    const cb = 'cb'+Date.now().toString(36)+Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    function cleanup(){ try{ delete window[cb]; }catch{} script.remove(); }

    const url = `${SCRIPT_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${cb}`;
    const script = document.createElement('script');
    script.src = url;
    script.onerror = ()=>{ cleanup(); reject(new Error('Gagal terhubung ke server.')); };
    document.body.appendChild(script);
  });
}

/* =========================
   LOGIN / LOGOUT
   ========================= */
async function login(){
  const email = document.getElementById('emailInput').value.trim();
  if(!email){ alert('Masukkan email.'); return; }
  try{
    const res = await jsonp('cekLogin', { email });
    if(!res || !res.success){ alert(res && res.message ? res.message : 'Login gagal'); return; }
    currentUser = res.user;
    localStorage.setItem('kasir_user', JSON.stringify(currentUser));
    afterLogin();
  }catch(e){
    alert('Gagal terhubung ke server.');
  }
}
function afterLogin(){
  const badge = document.getElementById('userBadge');
  badge.textContent = `${currentUser.role}: ${currentUser.email} | Cabang: ${currentUser.cabang}`;
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('appContainer').classList.remove('hidden');
  loadProduk();
  renderCart();
}
function doLogout(){ localStorage.removeItem('kasir_user'); location.reload(); }
(function autoLogin(){
  const saved = localStorage.getItem('kasir_user');
  if(saved){ try{ currentUser = JSON.parse(saved)||null; }catch{} if(currentUser){ afterLogin(); } }
})();

/* =========================
   PRODUK + PAGINATION
   ========================= */
async function loadProduk(){
  try{
    const res = await jsonp('getProduk', {});
    semuaProduk = Array.isArray(res) ? res : [];
    filteredProduk = [...semuaProduk];
    pg.page = 1;
    updateProductView();
  }catch(e){
    alert('Gagal memuat produk.');
  }
}
function onSearch(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  filteredProduk = semuaProduk.filter(p => (String(p['Nama Produk']||'').toLowerCase().includes(q)));
  pg.page = 1;
  updateProductView();
}
function changePage(delta){
  const totalPages = Math.max(1, Math.ceil(filteredProduk.length / pg.per));
  pg.page = Math.min(totalPages, Math.max(1, pg.page + delta));
  updateProductView();
}
function updatePager(){
  const totalPages = Math.max(1, Math.ceil(filteredProduk.length / pg.per));
  document.getElementById('pageInfo').textContent  = `Halaman ${pg.page} dari ${totalPages}`;
  document.getElementById('pageInfo2').textContent = `Halaman ${pg.page} dari ${totalPages}`;
  document.getElementById('prevBtn').disabled = pg.page<=1;
  document.getElementById('nextBtn').disabled = pg.page>=totalPages;
}
function updateProductView(){
  updatePager();
  const start = (pg.page-1)*pg.per, end = start+pg.per;
  const slice = filteredProduk.slice(start, end);
  renderProduk(slice);
}
function renderProduk(list){
  const el = document.getElementById('produkGrid');
  if(!list || !list.length){ el.innerHTML = '<div class="card section" style="grid-column:1/-1;color:var(--muted)">Tidak ada produk.</div>'; return; }
  el.innerHTML = list.map(p=>{
    const nama = p['Nama Produk'] || '';
    const variasi = p['Ukuran/Variasi'] ? `<div style="color:var(--muted);font-size:12px">${p['Ukuran/Variasi']}</div>` : '';
    const harga = +p['Harga Jual']||0;
    const foto = p['Foto'] || p['Gambar'] || p['Image'] || '';
    const img = foto ? `<img class="p-img" src="${foto}" onerror="this.src='data:image/svg+xml;utf8,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22/&gt;';">`
                     : `<div class="p-img"></div>`;
    return `
      <div class="p-card">
        ${img}
        <div class="p-body">
          <div class="p-name">${nama}</div>
          ${variasi}
          <div class="p-price" style="margin-top:4px">${fmtRp(harga)}</div>
        </div>
        <div class="p-actions">
          <button class="btn-cart" onclick='addToCart(${JSON.stringify(p).replace(/'/g,"&apos;")})'>+ Keranjang</button>
        </div>
      </div>
    `;
  }).join('');
}

/* =========================
   QUICK ACTIONS (MODALS)
   ========================= */
function openMember(){ showModal('modalMember'); }
function openDiskon(){ showModal('modalDiskon'); }
function openItemManual(){ showModal('modalItem'); }

function showModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }

async function submitMember(){
  const hpRaw = document.getElementById('memberHp').value.trim();
  const nama = document.getElementById('memberNama').value.trim();
  if(!hpRaw || !nama){ alert('Isi nomor HP & nama.'); return; }
  const hp = normalizeHp(hpRaw);
  try{
    const res = await jsonp('tambahMemberBaru', { nomorHp: hp, nama });
    alert(res && res.message ? res.message : 'Member tersimpan.');
    closeModal('modalMember');
  }catch(e){ alert('Gagal menyimpan member.'); }
}

async function applyDiskon(){
  const hpRaw = document.getElementById('diskonHp').value.trim();
  if(!hpRaw){ alert('Isi nomor HP.'); return; }
  const hp = normalizeHp(hpRaw);
  try{
    const res = await jsonp('cekMember', { nomorHp: hp });
    if(res && res.success){
      isMemberActive = true;
      document.getElementById('memberBadge').classList.remove('hidden');
      closeModal('modalDiskon');
      renderCart(); // re-calc harga satuan
      alert('Diskon member diterapkan.');
    }else{
      isMemberActive = false;
      document.getElementById('memberBadge').classList.add('hidden');
      closeModal('modalDiskon');
      renderCart();
      alert('Nomor tidak terdaftar.');
    }
  }catch(e){
    alert('Gagal cek member.');
  }
}

function submitItemManual(){
  const nama = document.getElementById('itemNama').value.trim();
  const variasi = document.getElementById('itemVar').value.trim();
  const harga = +document.getElementById('itemHarga').value||0;
  const qty = Math.max(1, +document.getElementById('itemQty').value||1);
  if(!nama || !harga){ alert('Isi nama & harga.'); return; }
  const idp = 'MANUAL-'+Date.now();
  keranjang.push({
    idp, nama, variasi, qty,
    harga, hargaMember: null,
    nego: null, showNego:false
  });
  closeModal('modalItem');
  renderCart();
}

/* =========================
   KERANJANG & NEGO
   ========================= */
function addToCart(prod){
  const idp = prod['ID Produk'] || prod['Nama Produk'];
  const idx = keranjang.findIndex(i => i.idp===idp && i.variasi=== (prod['Ukuran/Variasi']||''));
  const hargaMember = +prod['Harga Member']||0;
  if(idx>=0){
    keranjang[idx].qty += 1;
  }else{
    keranjang.push({
      idp,
      nama: prod['Nama Produk']||'',
      variasi: prod['Ukuran/Variasi']||'',
      qty: 1,
      harga: +prod['Harga Jual']||0,
      hargaMember: hargaMember>0 ? hargaMember : null,
      nego: null,
      showNego: false
    });
  }
  renderCart();
}

function unitPrice(it){
  if(it.nego!=null) return it.nego;
  if(isMemberActive && it.hargaMember!=null) return it.hargaMember;
  return it.harga;
}

function renderCart(){
  const list = document.getElementById('cartList');
  if(!keranjang.length){
    list.innerHTML = `<div style="color:var(--muted)">Tidak ada item.</div>`;
  }else{
    list.innerHTML = keranjang.map((it,ix)=>{
      const satuan = unitPrice(it);
      const total = satuan * it.qty;
      const subtitle = it.variasi ? ` <span style="color:var(--muted)">(${it.variasi})</span>` : '';
      return `
        <div class="c-item">
          <div class="c-top">
            <div class="c-title">${it.nama}${subtitle}</div>
            <button class="rm-btn" title="hapus" onclick="hapusItem(${ix})">âœ•</button>
          </div>
          <div class="qty-row">
            <button class="qty-btn qty-minus" onclick="kurang(${ix})">âˆ’</button>
            <div class="qty-box">${it.qty}</div>
            <button class="qty-btn qty-plus" onclick="tambah(${ix})">ï¼‹</button>

            <div class="nego-row">
              <button class="nego-btn" onclick="toggleNego(${ix})">Nego</button>
              <div class="nego-input" id="negoWrap${ix}">
                <span>Rp</span>
                <input id="negoInput${ix}" type="number" min="0" value="${satuan}" style="width:110px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px"/>
                <button class="ok-btn" onclick="setNego(${ix})">OK</button>
              </div>
            </div>
          </div>
          <div style="font-weight:700;margin-top:2px">${it.qty} Ã— ${fmtRp(satuan)} = ${fmtRp(total)}</div>
        </div>
      `;
    }).join('');
  }
  // set vis nego
  keranjang.forEach((it,ix)=>{ const w = document.getElementById('negoWrap'+ix); if(w) w.style.display = it.showNego ? 'flex' : 'none'; });

  // ringkasan
  const subtotalNormal = keranjang.reduce((s,i)=> s + (i.harga * i.qty), 0);
  const subtotal = keranjang.reduce((s,i)=> s + (unitPrice(i) * i.qty), 0);
  const saving = Math.max(0, subtotalNormal - subtotal);
  document.getElementById('subtotalTxt').textContent = fmtRp(subtotal);
  document.getElementById('totalTxt').textContent = fmtRp(subtotal);
  document.getElementById('saveTxt').textContent = fmtRp(saving);

  document.getElementById('payPanel').classList.add('hidden');
  document.getElementById('postSavePanel').classList.add('hidden');
}
function toggleNego(ix){ keranjang[ix].showNego = !keranjang[ix].showNego; const w = document.getElementById('negoWrap'+ix); if(w) w.style.display = keranjang[ix].showNego ? 'flex' : 'none'; }
function setNego(ix){ const val = +document.getElementById('negoInput'+ix).value||0; keranjang[ix].nego = val>0 ? val : null; renderCart(); }
function hapusItem(ix){ keranjang.splice(ix,1); renderCart(); }
function tambah(ix){ keranjang[ix].qty++; renderCart(); }
function kurang(ix){ keranjang[ix].qty = Math.max(1, keranjang[ix].qty-1); renderCart(); }

/* =========================
   PEMBAYARAN
   ========================= */
function lanjutPembayaran(){
  if(!keranjang.length){ alert('Keranjang kosong.'); return; }
  document.getElementById('payPanel').classList.remove('hidden');
  document.getElementById('postSavePanel').classList.add('hidden');
}
async function konfirmasiSimpan(){
  if(!keranjang.length){ return; }
  const metode = [...document.querySelectorAll('input[name="pay"]')].find(r=>r.checked)?.value || 'Tunai';
  const items = keranjang.map(i=>({
    produk: {'ID Produk': i.idp, 'Nama Produk': i.nama, 'Ukuran/Variasi': i.variasi},
    qty: i.qty,
    hargaAkhirSatuan: unitPrice(i)
  }));
  const payload = {
    cabang: currentUser?.cabang || 'Pusat',
    metodePembayaran: metode,
    detailMetode: '',
    items
  };
  try{
    const res = await jsonp('simpanTransaksi', payload);
    if(!res || !res.success){ alert((res&&res.message)||'Gagal menyimpan'); return; }
    lastSavedTrx = res.id || null;
    document.getElementById('payPanel').classList.add('hidden');
    document.getElementById('postSavePanel').classList.remove('hidden');
  }catch(e){ alert('Terjadi kesalahan saat menyimpan transaksi.'); }
}
function batalPembayaran(){ document.getElementById('payPanel').classList.add('hidden'); }
function cetakStruk(){ if(!lastSavedTrx){ alert('Tidak ada transaksi.'); return; } window.print(); }
function kembaliKeProduk(){ keranjang=[]; lastSavedTrx=null; renderCart(); window.scrollTo({top:0,behavior:'smooth'}); }

/* =========================
   LAPORAN (tab Laporan)
   ========================= */
async function muatLaporan(){
  const wrap = document.getElementById('laporanWrap');
  if(!currentUser){ wrap.textContent='Silakan login terlebih dahulu.'; return; }
  wrap.textContent = 'Memuat...';
  try{
    const harian = await jsonp('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang });
    const det = await jsonp('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang });

    const reports = (harian && harian.reports)||[];
    const grouped = (det && det.groupedTransactions) ? det.groupedTransactions : null;
    const list = (det && det.transactions)||[];

    let html = '';
    if(!reports.length){
      html += '<div style="color:var(--muted)">Tidak ada transaksi hari ini.</div>';
    }else{
      html += reports.map(r=>`
        <div class="card" style="margin:10px 0">
          <div class="section">
            <div style="font-weight:800">Cabang: ${r.cabang}</div>
            <div style="margin-top:6px">Total Penjualan: <b>${fmtRp(r.totalPenjualan)}</b></div>
            <div>Jumlah Transaksi: <b>${r.jumlahTransaksi}</b></div>
            <div>Penjualan Tunai: <b>${fmtRp(r.totalTunai)}</b></div>
            <div>Penjualan Non-Tunai: <b>${fmtRp(r.totalNonTunai)}</b></div>
          </div>
        </div>
      `).join('');
    }

    // detail item
    function tableHtml(items){
      if(!items || !items.length) return '<div style="color:var(--muted)">Tidak ada item.</div>';
      return `
        <div style="overflow:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Waktu</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #eee">Produk</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Qty</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Harga Satuan</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid #eee">Total</th>
              </tr>
            </thead>
            <tbody>
              ${items.map(it=>`
                <tr>
                  <td style="padding:8px;border-bottom:1px solid #f2f2f2">${it.timestamp||''}</td>
                  <td style="padding:8px;border-bottom:1px solid #f2f2f2">${it.produk||''}</td>
                  <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${it.qty||0}</td>
                  <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${fmtRp(it.hargaSatuan||0)}</td>
                  <td style="text-align:right;padding:8px;border-bottom:1px solid #f2f2f2">${fmtRp(it.total||0)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    if(grouped){ // admin
      Object.keys(grouped).forEach(cab=>{
        html += `
          <div class="card" style="margin:10px 0">
            <div class="section">
              <div style="font-weight:800;margin-bottom:6px">Detail Item Terjual - Cabang ${cab}</div>
              ${tableHtml(grouped[cab])}
            </div>
          </div>
        `;
      });
    }else{ // kasir
      html += `
        <div class="card" style="margin:10px 0">
          <div class="section">
            <div style="font-weight:800;margin-bottom:6px">Detail Item Terjual</div>
            ${tableHtml(list)}
          </div>
        </div>
      `;
    }

    wrap.innerHTML = html;
  }catch(e){
    wrap.textContent = 'Gagal memuat laporan.';
  }
}

/* =========================
   TAB SWITCH
   ========================= */
function switchTab(tab){
  document.getElementById('tabKasir').classList.toggle('active', tab==='kasir');
  document.getElementById('tabLaporan').classList.toggle('active', tab!=='kasir');
  document.getElementById('appContainer').classList.toggle('hidden', tab!=='kasir');
  document.getElementById('laporanPage').classList.toggle('hidden', tab!=='laporan');
  if(tab==='laporan'){ muatLaporan(); }
}
</script>
</body>
</html>
