<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kasir Toko Tanaman</title>

<!-- ===================== THEME & LAYOUT ===================== -->
<style>
  :root{
    --brand: #c62828;        /* merah premium */
    --brand-700:#ad2222;
    --accent-green:#2e7d32;  /* hijau tombol +Item */
    --accent-blue:#2563eb;   /* biru tombol Diskon */
    --text:#1f2937;
    --muted:#6b7280;
    --bg:#f7f7f8;
    --card:#ffffff;
    --ring:rgba(0,0,0,.06);
    --shadow: 0 6px 16px rgba(0,0,0,.08);
    --radius:16px;
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .container{max-width:920px; margin:0 auto; padding:16px}
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }

  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 12px; margin-bottom:12px;
  }
  .pill{ display:inline-flex; align-items:center; gap:8px; padding:.4rem .8rem; border-radius:999px; background:#eef2ff; color:#1e293b; font-weight:600; font-size:.9rem; }
  .logout{ color:var(--brand); font-weight:700; cursor:pointer; }

  .tabs{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:8px;}
  .tab{ padding:14px; border-radius:999px; background:#ececec; color:#6b7280; font-weight:800; text-align:center; cursor:pointer; user-select:none; }
  .tab.active{ background:linear-gradient(180deg, var(--brand), var(--brand-700)); color:#fff; box-shadow:var(--shadow); }

  .quick{ display:flex; gap:10px; align-items:center; margin:6px 0 14px 0; flex-wrap:wrap; }
  .chip{ display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px 12px; border-radius:999px; font-weight:700; color:#fff; box-shadow:var(--shadow); cursor:pointer; user-select:none; }
  .chip.red{   background:var(--brand) } .chip.green{ background:var(--accent-green) } .chip.blue{  background:var(--accent-blue) }
  .chip:active{ transform:translateY(1px) }

  /* toolbar atas: hanya pencarian */
  .toolbar{ display:grid; grid-template-columns:1fr; gap:10px; align-items:center; margin:10px 0;}
  .search{ width:100%; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; outline:none; }

  /* grid produk 2 kolom (3 di layar lebar) */
  .grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
  @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
  .p-card{ background:#fff; border-radius:16px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; }
  .p-img{ width:100%; aspect-ratio:1/1; object-fit:cover; background:#e5e7eb; }
  .p-body{ padding:10px 12px 12px 12px; display:flex; flex-direction:column; gap:6px; }
  .p-name{ font-weight:800; letter-spacing:.2px; }
  .p-variant{ color:var(--muted); font-size:.78rem }
  .p-price{ font-weight:900; color:#ef4444; font-size:1rem; }
  .p-actions{ display:flex; gap:8px; margin-top:6px; }
  .add-btn{ flex:1; border:none; border-radius:12px; padding:10px; background:#2e7d32; color:#fff; font-weight:800; cursor:pointer; }

  /* panel pembayaran */
  .pay-panel{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .total-big{ font-weight:900; font-size:1.05rem }
  .pay-actions{ display:flex; gap:10px; flex-wrap:wrap }
  .btn{ padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:#fff; cursor:pointer; }
  .btn-primary{ background:linear-gradient(180deg, var(--brand), var(--brand-700)); color:#fff; border:none; font-weight:900; }
  .btn-green{ background:var(--accent-green); color:#fff; border:none; font-weight:900; }
  .btn-blue{ background:var(--accent-blue); color:#fff; border:none; font-weight:900; }

  /* pager di bawah */
  .pager-row{ margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .pager-left{ display:flex; gap:10px; align-items:center }
  .page-info{ color:var(--muted); font-weight:700; border:1px solid var(--ring); padding:8px 12px; border-radius:12px }

  .hidden{ display:none !important }
</style>
</head>
<body>

<div class="container">

  <!-- ================= LOGIN ================= -->
  <div id="loginPage" class="card">
    <h2 style="margin:8px 0 14px 0">Login Kasir</h2>
    <input id="emailInput" class="search" type="email" placeholder="Email (contoh: kasir@tokotanaman.com)" />
    <button id="btnLogin" class="btn-primary" style="width:100%; padding:12px; border-radius:12px">Masuk</button>
  </div>

  <!-- ================= APP ================= -->
  <div id="appContainer" class="hidden">
    <div class="topbar">
      <div id="userInfo" style="font-weight:700"></div>
      <div style="display:flex; align-items:center; gap:10px">
        <span id="roleBadge" class="pill">Kasir</span>
        <span id="btnLogout" class="logout">Logout</span>
      </div>
    </div>

    <div class="tabs">
      <div id="tabKasir" class="tab active">Kasir</div>
      <div id="tabLaporan" class="tab">Laporan</div>
    </div>

    <!-- quick actions -->
    <div class="quick">
      <div id="qaMember" class="chip red">+ Member</div>
      <div id="qaItem" class="chip green">+ Item</div>
      <div id="qaDiskon" class="chip blue">Diskon</div>
    </div>

    <!-- ============ POS PAGE ============ -->
    <div id="posPage" class="card">
      <!-- Search di atas -->
      <div class="toolbar">
        <input id="searchBox" class="search" placeholder="Cari tanaman..." />
      </div>

      <!-- Produk -->
      <div id="produkGrid" class="grid"></div>

      <!-- PANEL PEMBAYARAN (selalu di bawah daftar produk) -->
      <div id="payPanel" class="card hidden" style="margin-top:12px">
        <div class="pay-panel">
          <div>
            <div style="color:var(--muted); font-weight:700">Keranjang</div>
            <div class="total-big">Item: <span id="cartCount">0</span> • Total: <span id="cartTotal">Rp 0</span></div>
          </div>
          <div class="pay-actions">
            <button id="btnClearCart" class="btn">Kosongkan</button>
            <button id="payNonCash" class="btn-blue">Bayar Non-Tunai</button>
            <button id="payCash" class="btn-green">Bayar Tunai</button>
          </div>
        </div>
      </div>

      <!-- Pager pindah ke bawah -->
      <div class="pager-row">
        <div class="pager-left">
          <button class="btn" id="prevBtn">« Sebelumnya</button>
          <button class="btn" id="nextBtn">Berikutnya »</button>
        </div>
        <div class="page-info" id="pageInfo">Halaman 1</div>
      </div>
    </div>

    <!-- ============ LAPORAN PAGE ============ -->
    <div id="laporanPage" class="card hidden">
      <h3 style="margin-top:4px">Laporan Penjualan Hari Ini</h3>
      <div id="reportLoader" style="color:var(--muted)">Memuat...</div>
      <div id="reportContent"></div>
    </div>
  </div>
</div>

<!-- ===================== SCRIPTS ===================== -->
<script>
/** KONFIG BACKEND (JSONP) */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJVXMVdiDZ0VLQSypJtr2dy1gziXMdBMmNbrpUuzcxVXTN9_cxJ3iUvbSPum67jFagzw/exec';

/* ====== STATE ====== */
let currentUser = null;
let semuaProduk = [];
let filteredProduk = [];
let keranjang = [];
let currentPage = 1;
const itemsPerPage = 8; // 2 kolom x 4 baris

/* ====== UTIL ====== */
const rupiah = n => 'Rp ' + (Number(n||0)).toLocaleString('id-ID');
function saveUser(u){ localStorage.setItem('posUser', JSON.stringify(u||null)); }
function loadUser(){ try{ return JSON.parse(localStorage.getItem('posUser')) }catch(e){ return null } }

/* JSONP agar lolos CORS */
function jsonp(action, payload={}){
  return new Promise((resolve,reject)=>{
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    const cleanup = ()=>{ delete window[cbName]; s.remove(); };

    const url = new URL(SCRIPT_URL);
    url.searchParams.set('action', action);
    if (payload && Object.keys(payload).length){
      url.searchParams.set('payload', JSON.stringify(payload));
    }
    url.searchParams.set('callback', cbName);

    window[cbName] = (data)=>{ cleanup(); resolve(data); };
    const s = document.createElement('script');
    s.src = url.toString();
    s.onerror = ()=>{ cleanup(); reject(new Error('Gagal JSONP')) };
    document.body.appendChild(s);
  });
}
const getData  = (a,p={})=>jsonp(a,p);
const postData = (a,p={})=>jsonp(a,p);

/* ====== LOGIN ====== */
const loginPage = document.getElementById('loginPage');
const appContainer = document.getElementById('appContainer');
const emailInput = document.getElementById('emailInput');

async function tryAutoLogin(){
  const saved = loadUser();
  if(!saved || !saved.email){ showLogin(); return; }
  const res = await getData('cekLogin', { email: saved.email });
  if(res && res.success){ currentUser = res.user; saveUser(currentUser); afterLoginUI(); }
  else { showLogin(); }
}
function showLogin(){ loginPage.classList.remove('hidden'); appContainer.classList.add('hidden'); }
function afterLoginUI(){
  loginPage.classList.add('hidden'); appContainer.classList.remove('hidden');
  document.getElementById('userInfo').textContent =
    (currentUser.role==='Admin'?'Admin':'Kasir') + ': ' + currentUser.email + ' | Cabang: ' + currentUser.cabang;
  document.getElementById('roleBadge').textContent = currentUser.role;
  initPOS();
  if (document.getElementById('tabLaporan').classList.contains('active')) muatLaporan();
}

/* ====== TABS ====== */
const tabKasir = document.getElementById('tabKasir');
const tabLaporan = document.getElementById('tabLaporan');
const posPage = document.getElementById('posPage');
const laporanPage = document.getElementById('laporanPage');

tabKasir.onclick = ()=>{ tabKasir.classList.add('active'); tabLaporan.classList.remove('active'); posPage.classList.remove('hidden'); laporanPage.classList.add('hidden'); };
tabLaporan.onclick = ()=>{ tabKasir.classList.remove('active'); tabLaporan.classList.add('active'); posPage.classList.add('hidden'); laporanPage.classList.remove('hidden'); muatLaporan(); };

/* ====== POS ====== */
const grid = document.getElementById('produkGrid');
const searchBox = document.getElementById('searchBox');
const pageInfo = document.getElementById('pageInfo');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const payPanel = document.getElementById('payPanel');
const cartTotalEl = document.getElementById('cartTotal');
const cartCountEl = document.getElementById('cartCount');

async function initPOS(){
  if(!semuaProduk.length){
    const res = await getData('getProduk');
    semuaProduk = Array.isArray(res)? res : [];
    semuaProduk = semuaProduk.map(p=>({
      id: p['ID Produk'],
      nama: p['Nama Produk'],
      variasi: p['Ukuran/Variasi'] || '',
      harga: Number(p['Harga Jual']||0),
      foto: p['Foto URL'] || ''
    }));
  }
  filteredProduk = [...semuaProduk];
  currentPage = 1;
  renderProduk();
  renderPager();
  renderPayPanel();
}

function renderProduk(){
  const start = (currentPage-1)*itemsPerPage;
  const pageItems = filteredProduk.slice(start,start+itemsPerPage);

  grid.innerHTML = pageItems.map(p=>{
    const img = p.foto ? `loading="lazy" src="${p.foto}"` : '';
    return `
      <div class="p-card">
        <img class="p-img" ${img} alt="">
        <div class="p-body">
          <div class="p-name">${p.nama}</div>
          ${p.variasi ? `<div class="p-variant">${p.variasi}</div>`:''}
          <div class="p-price">${rupiah(p.harga)}</div>
          <div class="p-actions">
            <button class="add-btn" data-id="${p.id}">+ Keranjang</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // Bind add to cart
  grid.querySelectorAll('.add-btn').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-id');
      const prod = semuaProduk.find(x=>x.id===id);
      if(!prod) return;
      const exist = keranjang.find(x=>x.id===id);
      if(exist) exist.qty += 1; else keranjang.push({id:prod.id, produk:prod, qty:1, hargaAkhirSatuan:prod.harga});
      renderPayPanel();
    };
  });
}

function renderPager(){
  const totalPages = Math.max(1, Math.ceil(filteredProduk.length/itemsPerPage));
  pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
  prevBtn.disabled = currentPage===1;
  nextBtn.disabled = currentPage===totalPages;
}
prevBtn.onclick = ()=>{ if(currentPage>1){ currentPage--; renderProduk(); renderPager(); } };
nextBtn.onclick = ()=>{ const totalPages = Math.ceil(filteredProduk.length/itemsPerPage); if(currentPage<totalPages){ currentPage++; renderProduk(); renderPager(); } };
searchBox.oninput = ()=>{
  const q = searchBox.value.trim().toLowerCase();
  filteredProduk = !q ? [...semuaProduk] : semuaProduk.filter(p=>
    (p.nama||'').toLowerCase().includes(q) || (p.variasi||'').toLowerCase().includes(q)
  );
  currentPage=1; renderProduk(); renderPager();
};

function renderPayPanel(){
  const count = keranjang.reduce((s,it)=> s+it.qty, 0);
  const total = keranjang.reduce((s,it)=> s + (it.qty*it.hargaAkhirSatuan), 0);
  if(count>0){
    cartCountEl.textContent = count;
    cartTotalEl.textContent = rupiah(total);
    payPanel.classList.remove('hidden');
  }else{
    payPanel.classList.add('hidden');
  }
}

/* Pembayaran */
async function checkout(metode){
  if(!keranjang.length) return;
  const payload = {
    cabang: currentUser.cabang,
    metodePembayaran: metode,
    detailMetode: '',
    items: keranjang.map(k=>({
      produk: {
        'ID Produk': k.produk.id,
        'Nama Produk': k.produk.nama,
        'Ukuran/Variasi': k.produk.variasi
      },
      qty: k.qty,
      hargaAkhirSatuan: k.hargaAkhirSatuan
    }))
  };
  const res = await postData('simpanTransaksi', payload);
  if(res && res.success){
    alert('Transaksi tersimpan.');
    keranjang = []; renderPayPanel();
    if (tabLaporan.classList.contains('active')) muatLaporan();
  }else{
    alert('Gagal menyimpan transaksi.');
  }
}
document.getElementById('payCash').onclick = ()=> checkout('Tunai');
document.getElementById('payNonCash').onclick = ()=> checkout('Non-Tunai');
document.getElementById('btnClearCart').onclick = ()=>{ if(confirm('Kosongkan keranjang?')){ keranjang=[]; renderPayPanel(); } };

/* ====== LAPORAN ====== */
async function muatLaporan(){
  if(!currentUser) return;
  document.getElementById('reportLoader').textContent = 'Memuat...';
  document.getElementById('reportContent').innerHTML = '';

  try {
    const [harian, detail] = await Promise.all([
      getData('getLaporanHarian', { role: currentUser.role, cabang: currentUser.cabang }),
      getData('getLaporanDetail', { role: currentUser.role, cabang: currentUser.cabang })
    ]);

    const list = (harian && harian.reports) ? harian.reports : [];
    const totalKesel = list.reduce((s,r)=> s+(r.totalPenjualan||0), 0);
    const totalTrx = list.reduce((s,r)=> s+(r.jumlahTransaksi||0), 0);

    let html = `
      <div class="card" style="margin-top:10px">
        <div style="font-weight:800; margin-bottom:6px">Ringkasan Hari Ini</div>
        ${list.map(r=>`
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:10px 0; border-bottom:1px dashed var(--ring)">
            <div><b>Cabang:</b> ${r.cabang}</div>
            <div style="text-align:right"><b>Total:</b> ${rupiah(r.totalPenjualan)}</div>
            <div>Transaksi: ${r.jumlahTransaksi}</div>
            <div style="text-align:right">Tunai: ${rupiah(r.totalTunai)} | Non-Tunai: ${rupiah(r.totalNonTunai)}</div>
          </div>
        `).join('')}
        <div style="padding-top:8px; display:flex; justify-content:space-between; font-weight:900">
          <div>Total Transaksi: ${totalTrx}</div>
          <div>Total Pemasukan: ${rupiah(totalKesel)}</div>
        </div>
      </div>
    `;

    const items = (detail && (detail.transactions || flattenGroup(detail))) || [];
    if(items.length){
      html += `
        <div class="card" style="margin-top:10px">
          <div style="font-weight:800; margin-bottom:6px">Detail Item Terjual</div>
          <div style="overflow:auto">
            <table style="width:100%; border-collapse:collapse">
              <thead>
                <tr style="background:#f3f4f6">
                  <th style="text-align:left; padding:8px">Waktu</th>
                  <th style="text-align:left; padding:8px">Produk</th>
                  <th style="text-align:right; padding:8px">Qty</th>
                  <th style="text-align:right; padding:8px">Harga</th>
                  <th style="text-align:right; padding:8px">Total</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(it=>`
                  <tr>
                    <td style="padding:8px">${it.timestamp||''}</td>
                    <td style="padding:8px">${it.produk||''}${it.variasi?` (${it.variasi})`:''}</td>
                    <td style="padding:8px; text-align:right">${it.qty||0}</td>
                    <td style="padding:8px; text-align:right">${rupiah(it.hargaSatuan||0)}</td>
                    <td style="padding:8px; text-align:right">${rupiah(it.total||0)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    document.getElementById('reportLoader').textContent = '';
    document.getElementById('reportContent').innerHTML = html;

  } catch (e){
    document.getElementById('reportLoader').textContent = 'Gagal memuat laporan.';
  }

  function flattenGroup(d){
    if(!d || !d.groupedTransactions) return [];
    return Object.keys(d.groupedTransactions).flatMap(k=>d.groupedTransactions[k]);
  }
}

/* ====== QUICK ACTIONS PLACEHOLDER ====== */
document.getElementById('qaMember').onclick = ()=> alert('Form "Daftarkan Member Baru" akan dibuka (fitur asli tetap).');
document.getElementById('qaItem').onclick   = ()=> alert('Form "Tambah Item Manual" akan dibuka (fitur asli tetap).');
document.getElementById('qaDiskon').onclick = ()=> alert('Terapkan Diskon Member (fitur asli tetap).');

/* ====== AUTH BUTTONS ====== */
document.getElementById('btnLogin').onclick = async ()=>{
  const email = (emailInput.value||'').trim();
  if(!email) return alert('Masukkan email.');
  const res = await getData('cekLogin', { email });
  if(res && res.success){ currentUser = res.user; saveUser(currentUser); afterLoginUI(); }
  else{ alert('Login gagal.'); }
};
document.getElementById('btnLogout').onclick = ()=>{
  saveUser(null); currentUser=null; semuaProduk=[]; filteredProduk=[]; keranjang=[];
  showLogin();
};

/* ====== START ====== */
tryAutoLogin();
</script>
</body>
</html>
